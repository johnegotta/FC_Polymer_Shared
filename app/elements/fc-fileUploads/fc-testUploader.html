<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<dom-module id="fc-testUploader">
  <template>
     <style>
      .enabled {
        border: 1px dashed #555;
      }

      .hover {
        opacity: .7;
        border: 1px dashed #111;
      }

      #UploadBorder{
        vertical-align: middle;
        color: #555;
        padding: 20px;
        max-height: 300px;
        overflow-y: auto;
        display: inline-block;
      }

      #dropArea {
        text-align: center;
      }

      paper-button {
        margin-bottom: 20px;
      }

      .file {
        padding: 10px 0px;
      }

      .commands {
        float: right;
        padding: 0px 10px;
      }

      .commands iron-icon:not([icon="check-circle"]) {
        cursor: pointer;
        opacity: .9;
      }

      .commands iron-icon:hover {
        opacity: 1;
      }

      .fileSelects {
        float: right;
        padding: 0px 10px;
      }

      [hidden] {
        display: none;
      }

      .error {
        color: #f40303;
        font-size: 11px;
        margin: 2px 0px -3px;
      }

      paper-progress {
        --paper-progress-active-color: #03a9f4;
      }

      paper-progress[error] {
        --paper-progress-active-color: #f40303;
      }
    </style>
    <firebase-collection id="trloc" location="https://focusedstaging1.firebaseio.com/test_results"></firebase-collection>
    <firebase-document id="score_chart_loc" location="https://focusedstaging1.firebaseio.com/score_conversion_charts" data="{{score_charts}}"></firebase-document>
    <div>
      <paper-button id="button" icon="file-upload" class="blue" on-click="_fileClick">
        <content></content>
      </paper-button>
      <div id="UploadBorder">
        <div id="dropArea" hidden$="{{_hiddenDropText}}">{{dropText}}</div>
        <template is="dom-repeat" items="{{files}}">
          <div class="file horizontal layout">
            <div>
              <div class="name">
                <span>{{item.name}}</span>
                <div class="commands">
                  <iron-icon icon="autorenew" title="Retry Upload" on-click="_retryUpload" hidden$="{{!item.error}}"></iron-icon>
                  <iron-icon icon="cancel" title="Remove" on-click="_cancelUpload" hidden$="{{item.complete}}"></iron-icon>
                  <iron-icon icon="check-circle" title="Success" hidden$="{{!item.complete}}"></iron-icon>
                </div>
              </div>
              <div class="error" hidden$="{{!item.error}}">Error uploading file...</div>
              <div hidden$={{progressHidden}}>
                <paper-progress value$="{{item.progress}}" error$="{{item.error}}"></paper-progress>
              </div>
            </div>
            <div>
              <div class="fileSelects">
                <paper-dropdown-menu label="Results or Score Table" on-selected-item-changed="_setFileType">
                  <paper-menu class="dropdown-content">
                    <paper-item>Test Result</paper-item>
                    <paper-item>Score Table</paper-item>
                  </paper-menu>
                </paper-dropdown-menu>
                <paper-dropdown-menu id="testSelector" label="For Which Test" on-selected-item-changed="_setTestName">
                  <paper-menu class="dropdown-content">
                    <paper-item>Test 1</paper-item>
                    <paper-item>Test 2</paper-item>
                    <paper-item>Test B12A</paper-item>
                  </paper-menu>
                </paper-dropdown-menu>
              </div>
            </div>
          </div>
        </template>
      </div>
    </div>
    <input type="file" id="fileInput" on-change="_fileChange" hidden multiple="{{multi}}" accept=".csv">
    <!--<paper-toast id="toastSuccess" text="File uploaded successfully!"></paper-toast>
    <paper-toast id="toastFail" text="Error uploading file!"></paper-toast>-->
  </template>

</dom-module>

<script>

  Polymer({

    is: 'fc-testUploader',

     /**
      * Fired when a response is received status code 200.
      *
      * @event success
    */
     /**
      * Fired when a response is received other status code.
      *
      * @event error
    */

    properties: {

      /**
       * `target` is the target url to upload the files to.
       * Additionally by adding "<name>" in your url, it will be replaced by
       * the file name.
       */
      target: {
        type: String,
        value: ""
      },

      /**
       * `progressHidden` indicates whether or not the progress bar should be hidden.
       */
      progressHidden: {
        type: Boolean,
        value: false
      },

      /**
       * `droppable` indicates whether or not to allow file drop.
      */
      droppable: {
        type: Boolean,
        value: false
      },

      /**
       * `dropText` is the  text to display in the file drop area.
      */
      dropText: {
        type: String,
        value: "Drop CSV Files Here"
      },

      /**
       * `multi` indicates whether or not to allow multiple files to be uploaded.
      */
      multi: {
        type: Boolean,
        value: true
      },

      /**
       * `files` is the list of files to be uploaded
      */
      files: {
        type: Array,
        value: []
      },

      /**
       * `method` is the http method to be used during upload
      */
      method: {
        type: String,
        value: "PUT"
      },

      /**
       * `raised` indicates whether or not the button should be raised
      */
      raised: {
        type: Boolean,
        value: false
      },

      /**
       * `noink` indicates that the button should not have an ink effect
      */
      noink: {
        type: Boolean,
        value: false
      },

      /**
       * `_hiddenDropText` indicates whether or not the drop text should be shown
      */
      _hiddenDropText: {
        type: Boolean,
        value: true
      },

      /**
       * `headers` is a key value map of header names and values
      */
      headers: {
        type: Object,
        value: {},
      }
    },

    /**
     * Clears the list of files
    */
    clear: function() {
      this.set("files", []);
      this._showDropText();
    },

    ready: function() {
      if (this.raised) {
        this.toggleAttribute("raised", true, this.$.button);
      }
      if (this.noink) {
        this.toggleAttribute("noink", true, this.$.button);
      }
      if (this.droppable) {
        this._showDropText();
        this.setupDrop();
      }
    },

    /**
     * A function to set up a drop area for drag-and-drop file uploads
    */
    setupDrop: function() {
      var uploadBorder = this.$.UploadBorder;
      this.toggleClass("enabled", true, uploadBorder);

      this.ondragover = function(e) {
        e.stopPropagation();
        this.toggleClass("hover", true, uploadBorder);
        return false;
      }

      this.ondragleave = function() {
        this.toggleClass("hover", false, uploadBorder);
        return false;
      }

      this.ondrop = function(event) {
        this.toggleClass("hover", false, uploadBorder);
        event.preventDefault();
        var length = event.dataTransfer.files.length;
        for (var i = 0; i < length; i++) {
          var file = event.dataTransfer.files[i];
          file.progress = 0;
          file.error = false;
          file.complete = false;
          this.push("files", file);
          this._showDropText();
          //this.uploadFile(file);
        }
      }
    },

    /**
     * Clicks the invisible file input
    */
    _fileClick: function() {
      var elem = this.$.fileInput;
      if (elem && document.createEvent) { // sanity check
        var evt = document.createEvent("MouseEvents");
        evt.initEvent("click", true, false);
        elem.dispatchEvent(evt);
      }
    },

    /**
     * Called whenever the list of selected files changes
    */
    _fileChange: function(e) {
      var length = e.target.files.length;
      for (var i = 0; i < length; i++) {
        var file = e.target.files[i];
        file.progress = 0;
        file.error = false;
        file.complete = false;
        this.push("files", file);
        //this.uploadFile(file);
      }
    },

    /**
     * Cancels the file upload for a specific file
     *
     * @param {object} a file, an element of the files array
    */
    cancel: function(file) {
      if (file) {
        this.splice("files", this.files.indexOf(file), 1);
        this._showDropText();
      }
    },

    /**
     * Cancels the file upload
     *
     * @param {object}, an event object
    */
    _cancelUpload: function(e) {
      this.cancel(e.model.__data__.item);
    },

    /**
     * Retries to upload the file
     *
     * @param {object}, an event object
    */
    _retryUpload: function(e) {
      e.model.set("item.error", false);
      e.model.set("item.progress", 0);
      // The async helps give visual feedback of a retry occurring, even though it's less efficient.
      var self = this;
      this.async(function() {
        self.uploadFile(e.model.__data__.item);
      }, 50);
    },

    /**
     * Whether or not to display the drop text
    */
    _showDropText: function() {
      this.set("_hiddenDropText", !(!this.files.length && this.droppable));
    },
    /**
     * Tell uploader if the CSV contains test results or score conversion chart
    */
    _setFileType: function(e){
      e.model.__data__.item.filetype = e.target.selectedItem.innerText;
      if(e.model.__data__.item.filetype && e.model.__data__.item.testname){
        this.uploadFile(e.model.__data__.item);
      }
    },
    /**
     * Tell uploader what test this goes with
    */
    _setTestName: function(e){
      e.model.__data__.item.testname = e.target.selectedItem.innerText;
      if(e.model.__data__.item.filetype && e.model.__data__.item.testname){
        this.uploadFile(e.model.__data__.item);
      }
    },
    /**
     * Uploads a file
     *
     * @param {object} a file, an element of the files array
    */
    uploadFile: function(file) {
      var regex = /.+(.csv)/;
      if (!file || !regex.test(file.name.toLowerCase())) {
        alert('Check that the file you want to add exists and that it is a CSV file.')
        return;
      } else {
        switch(file.filetype){
          case 'Test Result':
            this.uploadTestResult(file);
            break;
          case 'Score Table':
            this.uploadScoreTable(file);
            break;
        }
      }
    },

    uploadTestResult: function(file){
      var start_time = performance.now();
      self = this;
      var prefix = "files." + self.files.indexOf(file);
      console.log('Uploading ' + file.name + ' as a ' + file.filetype + ' for ' + file.testname);
          if (typeof (FileReader) != "undefined") {
            var reader = new FileReader();
            reader.onload = function (e) {
              //var table = document.createElement("table");
              var essay_index = 0;
              var student_id_index = 0;
              var last_name_index = 0;
              var first_name_index = 0;
              var indices_to_skip = [];
              var question_and_score_indices = [];

              var rows = e.target.result.split(/[\r|\n]+/);
              var numRows = rows.length;
              var headers = rows[0].split(',');
              var num_columns = headers.length;

              //figure out which columns to look at when going through rows
              for (var i = 0; i < num_columns; i++){
                var header_name = headers[i];
                var underscore_index = header_name.indexOf('_');
                var period_index = header_name.indexOf('.');

                if (period_index > -1 && underscore_index > -1){
                  var nums_in_name = header_name.match(/\d+/g);
                  nums_in_name = nums_in_name.map(function(value){
                    return parseInt(value);
                  });

                  if (nums_in_name[2] <= nums_in_name[1]){
                    var question_index_pair_info = {};
                    var match_term = header_name.substring(0,underscore_index);
                    question_index_pair_info['score_index'] = i;
                    question_index_pair_info['response_index'] = headers.indexOf(match_term);
                    question_index_pair_info['section_number'] = nums_in_name[0] == 0 ? 10 : nums_in_name[0];
                    question_index_pair_info['question_number'] = nums_in_name[2];
                    question_index_pair_info['section_type'] = header_name.indexOf('mfr') < 0 ? header_name[1] : 'mfr';
                    question_and_score_indices.push(question_index_pair_info);
                  }
                }
              }
              console.log(question_and_score_indices);
              var qasi_size = question_and_score_indices.length;
              student_id_index = headers.indexOf('id');
              last_name_index = headers.indexOf('Last Name');
              first_name_index = headers.indexOf('First Name');
              essay_index = headers.indexOf('essay_score');
              indices_to_skip.push(student_id_index,last_name_index,first_name_index,essay_index);

              var question_results = {};
              var test_results = {};

              for (var i = 1; i < numRows; i++) {
                //var row = table.insertRow(-1);
                var cells = rows[i].split(",");
                if(cells[essay_index] != "0" && cells[essay_index] != ""){
                  var student_id = cells[student_id_index];
                  var last_name = cells[last_name_index];
                  var first_name = cells[first_name_index];
                  var essay = cells[essay_index];
                  var math_raw = 0;
                  var math_num_right = 0;
                  var math_num_wrong = 0;
                  var math_num_skipped = 0;
                  var reading_raw = 0;
                  var reading_num_right = 0;
                  var reading_num_wrong = 0;
                  var reading_num_skipped = 0;
                  var writing_raw = 0;
                  var writing_num_right = 0;
                  var writing_num_wrong = 0;
                  var writing_num_skipped = 0;

                  for (var j = 0; j < qasi_size; j++) {
                      //var cell = row.insertCell(-1);
                      //cell.innerHTML = cells[j];
                      var question_score = parseFloat(cells[question_and_score_indices[j]['score_index']]);
                      var question_response = cells[question_and_score_indices[j]['response_index']];
                      switch(question_and_score_indices[j]['section_type']){
                        case 'c':
                          reading_raw += question_score;
                          switch(question_score){
                            case 1:
                              reading_num_right++;
                              break;
                            case 0:
                              reading_num_skipped++;
                              break;
                            case -0.25:
                              reading_num_wrong++;
                              break;
                          }
                          break;
                        case 'w':
                          writing_raw += question_score;
                          switch(question_score){
                            case 1:
                              writing_num_right++;
                              break;
                            case 0:
                              writing_num_skipped++;
                              break;
                            case -0.25:
                              writing_num_wrong++;
                              break;
                          }
                          break;
                        case 'm':
                          math_raw += question_score;
                          switch(question_score){
                            case 1:
                              math_num_right++;
                              break;
                            case 0:
                              math_num_skipped++;
                              break;
                            case -0.25:
                              math_num_wrong++;
                              break;
                          }
                          break;
                        case 'mfr':
                          math_raw += question_score;
                          switch(question_score){
                            case 1:
                              math_num_right++;
                              break;
                            case 0:
                              if(question_response == ""){
                                math_num_skipped++;
                              } else {
                                math_num_wrong++;
                              }
                              break;
                          }
                          break;
                      }
                  }
                  var test_obj = {
                    'stul': last_name,
                    'stuf': first_name,
                    'craw': reading_raw,
                    'cr': reading_num_right,
                    'cw': reading_num_wrong,
                    'cs': reading_num_skipped,
                    'mraw': math_raw,
                    'mr': math_num_right,
                    'mw': math_num_wrong,
                    'ms': math_num_skipped,
                    'wraw': writing_raw,
                    'wr': writing_num_right,
                    'ww': writing_num_wrong,
                    'ws': writing_num_skipped
                  };
                  console.log(test_obj);
                  self.$.trloc.add(test_obj);
                }
                else {
                  continue;
                }
                self.set(prefix + ".progress", Math.floor((i/numRows)*1000)/10);

              }
              self.set(prefix + ".complete", true);
              self.set(prefix + ".progress", 100);
              /*var dvCSV = document.getElementById("dvCSV");
              dvCSV.innerHTML = "";
              dvCSV.appendChild(table);*/
              self.cancel(file);
            }
            reader.readAsText(file);
          }
          else {
            alert('Your browser does not support HTML 5. Please update your browser to the latest version if you would like to upload files.');
            self.set(prefix + ".error", true);
          }

          var endtime = performance.now();
          var full_time = endtime - start_time;
          console.log("Full Time: " + full_time.toString());
    },

    uploadScoreTable: function(file){
      var start_time = performance.now();
      self = this;
      var prefix = "files." + self.files.indexOf(file);
      console.log('Uploading ' + file.name + ' as a ' + file.filetype + ' for ' + file.testname);
          if (typeof (FileReader) != "undefined") {
            var reader = new FileReader();
            reader.onload = function (e) {
              var rows = e.target.result.split(/[\r|\n]+/);
              var numRows = rows.length;
              var headers = rows[0].split(',');
              var num_headers = headers.length;

              var temp_score_obj_of_arrays = {};
              for (var i = 0; i < num_headers; i++){
                temp_score_obj_of_arrays[headers[i]] = [];
              }

              for (var i = 1; i < numRows; i++) {
                var cells = rows[i].split(",");
                var num_columns = cells.length;

                for (var j = 0; j < num_columns; j++) {
                  if (cells[j] != ''){
                    temp_score_obj_of_arrays[headers[j]].push(cells[j]);
                  }
                }
              }
              console.log(temp_score_obj_of_arrays);
              var num_reading_raws = temp_score_obj_of_arrays['reading_raw'].length;
              var num_math_raws = temp_score_obj_of_arrays['math_raw'].length;
              var num_writing_raws = temp_score_obj_of_arrays['writing_raw'].length;
              var score_chart = {};
              score_chart[file.testname] = {
                  'reading': {},
                  'math': {},
                  'writing': {}
              };
              for (var i = 0; i < num_reading_raws; i++) {
                score_chart[file.testname].reading[temp_score_obj_of_arrays['reading_raw'][i]] = temp_score_obj_of_arrays['reading_converted'][i];
              }
              for (var i = 0; i < num_math_raws; i++) {
                score_chart[file.testname].math[temp_score_obj_of_arrays['math_raw'][i]] = temp_score_obj_of_arrays['math_converted'][i];
              }
              for (var i = 0; i < num_writing_raws; i++) {
                score_chart[file.testname].writing[temp_score_obj_of_arrays['writing_raw'][i]] = {};
                for (var j = 1; j <= 12; j++) {
                  score_chart[file.testname].writing[temp_score_obj_of_arrays['writing_raw'][i]][j.toString()] = temp_score_obj_of_arrays[j.toString()][i];
                }
              }
              /*for (var i = 0; i < num_reading_raws; i++) {
                score_chart.reading[temp_score_obj_of_arrays['reading_raw'][i]] = temp_score_obj_of_arrays['reading_converted'][i];
              }*/

              console.log(score_chart);
              /*for (var set in temp_score_obj_of_arrays){
                if(set.indexOf('_raw') >= 0){
                  var section_type = set.substring(0,set.indexOf('_raw'));
                  switch (section_type){
                    case 'reading':

                  }
                }
              }*/
              self.score_charts = score_chart;
              self.set(prefix + ".complete", true);
              self.set(prefix + ".progress", 100);
              self.cancel(file);
            }
            reader.readAsText(file);
          }
          else {
            alert('Your browser does not support HTML 5. Please update your browser to the latest version if you would like to upload files.');
            self.set(prefix + ".error", true);
          }
          var endtime = performance.now();
          var full_time = endtime - start_time;
          console.log("Full Time: " + full_time.toString());
    }
  });

</script>
