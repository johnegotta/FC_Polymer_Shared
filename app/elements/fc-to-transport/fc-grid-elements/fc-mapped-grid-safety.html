<dom-module id="fc-mapped-grid">
 <template id="fc-mapped-grid-template">
 <style>
 section{
  background:white;
 }
textarea::-moz-selection { /* Code for Firefox */
    color: red;
    background: yellow;
}

textarea::selection {
    background: yellow;
}
:host{
	background: white;
	padding: 0px 3px 4px 8px;
	opacity: 1;

	position: static;
	@apply(--horizontal-layout);
	@apply(--layout-flex);
	}
  *{@apply(--layout-nowrap);}
 </style>
 <array-selector id="columnSelector" items="[[dataArrays]]" selected="{{selected}}?">
 </array-selector>

 
<!-- <a> -->
<div is-gridbox="true" id="mappedGridContainer" class="horizontal layout flex self-stretch reverse" style="min-width:88.99vw; max-width:98.99vw; min-height: 91vh; max-height:96vh;">
<!--side utility editing menu for the spreadsheet-like versions-->
<fc-grid-menu_sheets>
  <paper-button on-tap="addCol">Add Column</paper-button>
<paper-button on-tap="addRow">Add Row</paper-button>
<paper-button on-tap="monkey">Make (2,2) a Monkey</paper-button>
</fc-grid-menu_sheets>

<template is="dom-repeat"  id="mappedGridRepeater" observe="data selected" class="horizontal layout flex" id="template" index-as="columnIndex" items="{{columns}}" as="col">
<!-- <a link={{}}> -->
    <div id$="divCol_[[columnIndex]]" class="vertical layout flex nowrap self-stretch">
          <section id$="header_[[columnIndex]]" class="horizontal layout flex nowrap center center-justified" data-gh="true" data-payload$="{{col.data}}" draggable="true" on-dragstart="startDrag" on-dragover="dragOver" on-drop="handleDrop" style$="background:[[_computeHighlighted(col.selected, col.data, col.data.0.highlighted, trigger)]]; cursor:pointer; font-weight:700; color: #009; font-size: 20px; overflow: hidden; text-align: center; width:calc(100vw/18); max-height: 95px; min-height: 38px;" on-click="highlightCol">
          <span>
              {{col.column}} {{col.name}} <input type="checkbox" readonly name="hl" value="Bike" checked="{{computeColSelected(col.selected, trigger)}}">{{_computeCol(columnIndex)}}</span>
          </section>    
          <template is="dom-repeat" id$="template_{{columnIndex}}" class="vertical flex layout" observe="highlight col row" is="dom-repeat" items="{{col.data}}">
               <!--          <a link={{}}> -->
                              <section class="horizontal layout flex self-stretch"  id="{{index}}" data-payload$="{{item.payload}}" draggable="true" on-dragstart="startDrag" on-dragover="dragOver" on-drop="handleDrop" class="layout vertical"  style$="background:[[_computeHighlighted2(item.highlighted, trigger)]]; min-width:calc(99%/18); min-height:calc(92vh/16); max-width: 220px; max-height:60px; background-color:#ada; border:4px solid #009; font-size:14px;" id$="gridBox{{item.col}}_{{item.row}}">
                                <span>([[_computeCol(columnIndex)]],{{index}})</span>
                             <fc-input-search-select input-type="text" cell="{{item.row}}_{{item.col}}" style="border-bottom: 3px white solid;min-width: 35px; min-height: 35px; font-family:courier; font-size:24px; font-weight: 700; z-index: 4; resize:none;text-align:center;" id$="input[[item.col]]_[[item.row]]" data-fcitem$="{{item}}" on-keyup="changePayload" style$="background:{{item.payload}};" max-char="450" value="{{issValue::value}}" iss-value$="{{item.payload}}"></fc-input-search-select>
                        </section>
            <!--         </a> -->
              </template>
          
    </div>
<!--     </a> -->
</template>

</div>
<!-- </a> -->
 </template>
 <script>
 FcMappedGrid=Polymer({
 	is:"fc-mapped-grid",
  behaviors:[Polymer.Templatizer],
 	properties: {
    columns:{
      type: Array,
      value: function(){return [];},
      notify:true,
    },
    startCell:{
      type: Object,
      value:function(){return {};},
      notify:true
    },
    startContainer:{
      type: Object,
      value:function(){return {};},
      notify: true,
    },
  
    startCellModel:{
      type:Object,
      value: function(){return {};},
      notify: true,
    },

    trigger:{
      type: Boolean,
      value: function(){return false;},
      notify: true
    },

    menuProperty:{
        type:Object,
        value:function(){return {"property": null, "propertyValue":null, "propertyType":null};},
        observer: "observeMenuProperty",
        notify: true,
    },
    
      issClass:{
        notify: true,
      },
      arraySets:{
        type:Function,
        value:function(){return [
                                  ["keyColors", 
                                          ["yellow","orange","#afafaf", "lightblue","lightgreen","red", "cornflowerblue"]
                                  ],

                                  ["numberOfHighlightColors",["one", "two", "2 plus one accent", "2 plus 2 accents", "3 plus 2 accents"]
                                  ],
                                  ["selectionOfFirstHighlightColor",["rowsOnly", "columnsOnly", "rowsAndColumns", "rowsAndSummations", "All"]
                                  ],//0th has key then val array
        ]
      },

	 	drags:{type: Boolean, value: function(){return true;}, notify: true},
	 	
 		},
  },
ready(){
this.set("columns", [ {column: 0, selected:false, name:"one", data:[{payload:"yellow", col:0, row:0, highlighted:false}, {payload:"dodgerblue", col:0, row:1, highlighted:false}, {payload:"cyan", col:0, row:2, highlighted:false}]}, {column: 1, selected:false, name:"two", data:[{payload:"lightgrey", col:1, row:0, highlighted:false}, {payload:"green", col:1, row:1, highlighted:false}, {payload:"white", col:1, row:2, highlighted:false}]}, {column: 2,selected:false, name:"three", data:[{payload:"crimson", col:2, row:0, highlighted:false}, {payload:"grey", col:2, row:1, highlighted:false}, {payload:"orange", col:2, row:2, highlighted:false}]}  ]);
  },
startDrag: function(e)
  {   
    var parentOneTemplate=e.model.dataHost;
    var celloneModel = parentOneTemplate.modelForElement(e.target);
      var cell=parentOneTemplate.itemForElement(e.target); 
      var item = this.$.mappedGridRepeater.itemForElement(e.target);
      this.set("startContainer",item);
      console.log(this.startContainer);
      this.set("startCell",cell);
      this.set("startCellModel",celloneModel);
    
  },

  dragOver: function(e){e.preventDefault();},

  handleDrop: function(e)
  { 
      var parentTemplate=e.model.dataHost;
        var endContainer = this.$.mappedGridRepeater.itemForElement(e.target);
        var endCell= parentTemplate.itemForElement(e.target);
        var cellModel = parentTemplate.modelForElement(e.target);  
    if(this.startContainer.selected===true){
      var startCol=this.startContainer.data[0].col;
          var endCol=endContainer.data[1].col;
          var startContainerClone=Object.assign({},this.startContainer);
          var endContainerClone=Object.assign({},endContainer);
            endContainerClone.column=startCol;
            startContainerClone.column=endCol;
        for(var i=0; i<endContainer.data.length;i++){
            startContainerClone.data[i].col=endCol;
            endContainerClone.data[i].col=startCol;
          }
        this.async(function(){this.splice("columns",endCol,1,startContainerClone);},50);
        this.async(function(){this.splice("columns",startCol,1, endContainerClone);},26);
    }
    else
    {
      var destpayload = endCell.payload;
      var payload=this.startCell.payload;
      this.async(function(){cellModel.set("item.payload",payload)},25);
      this.startCellModel.set("item.payload",destpayload);
    }
  },

  monkey: function(e)
  {
    var col = "columns[2][2]";
    this.set(["columns", 2, "data",2, "payload"], "monkey"); //{payload:"Monkey"});
    console.log(this.columns);
  },

  changePayload: function(e)
  {
    var dat = JSON.parse(e.target.dataset.fcitem);
    var col = parseInt(dat.col);
    var row = parseInt(dat.row);
    console.log(e.target.value, dat, typeof dat, col, row);
    this.set(["columns", parseInt(dat.col), "data", parseInt(dat.row)], {payload: e.target.value, col: dat.col, row: dat.row, highlighted:dat.highlighted});
    console.log(this.columns);
  },
  _computeCol: function(col){return col;},

  addCol: function(e)
  {
    var numCols = this.columns.length;
    var numRows = this.columns[0].data.length;
    var newCol = {column: numCols, name: "new", selected:false, data:[]};
    var i = 0;
    for(i = 0; i < numRows; i++)
    {
      newCol.data.push({payload:"lightgreen", col:numCols, row:i, highlighted:false});
    }
    this.push("columns", newCol); //{selected:false, data:newCol});
    console.log(this.columns.length, this.columns);
  },

  addRow: function(e)
  { 
    var numCols = this.columns.length;
    var numRows = this.columns[0].data.length;
    var i = 0;
    for(i = 0; i < numCols; i++)
    {
      this.push(["columns", i, "data"], {payload:"beige", col:i, row:numRows, highlighted:this.columns[i].selected});
    }
  },

  highlightCol: function(e)
  {   
      var item= this.$.mappedGridRepeater.itemForElement(e.target);
        var model= this.$.mappedGridRepeater.modelForElement(e.target);
        var setVal=(item.selected===false)?true: false;
      var counter=item.data.length;
      var resetVal=item, i=0;
        resetVal.selected=setVal;
        model.set("item.selected", setVal);
        for(i=0;i<counter;i++){
          model.set(["item.data",i,"highlighted"], setVal);
          item.data[i].highlighted=setVal;
          }
        console.log(item);
        this.set("trigger",!this.trigger);
  },

  _computeHighlighted: function(one, two, three)
  {
    console.log(one,two, three, "why is this not triggered onb the change of values above");
    if(typeof three===Object){
    var result = (one === true && two===true)?"yellow":"#afafaf";
    }
    result=(three===true)?"cyan; border: solid 4px #aecdfe":"white; border: solid 0px #aecdfe"+result;
    return result;
  },
  computeColSelected: function(one,two){return one;},
  _computeHighlighted2(hl, tr){var result = (hl === true)?"yellow":"white";return result;},

    setDataArrays(){
        var columnKeys=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];
        var columnNames=["Years","January","February","March","April","May","June","July","August","September","October","November","December","Year Total",`&#x0394`, `&#x0394`];
        var tempArr=[];
        var retArrays=columnKeys.map(function(val, index,array){
                    var count=array.length;
                    var tempArr=[];
                    var valueArray=[];
                    for(var i=0;i<count;i++)
                    {
                       var retMini= val+array[i];
                       tempArr.push({"key": retMini, "location": retMini, "value": retMini});
                       var value= "inputValue__"+index+"_"+i;
                       valueArray.push(value);
                    }
                   retVal={column: columnNames[index], cell: tempArr, values:valueArray};
                   //console.log()
                    return retVal;  
            }, []);
        //console.log(retArrays);
        return retArrays;
        },
   
    observeMenuProperty(newVal, oldVal){},

  });
    </script>
   </dom-module>
  