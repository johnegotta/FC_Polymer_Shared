<dom-module id="fc-mapped-grid">
 <template id="fc-mapped-grid-template">
 <style>
         :host{margin: 12px 3px;padding: 4px;overflow:scroll;position: static;background: white; opacity: 1; @apply(--layout-vertical);@apply(--layout-flex); };
        textarea{margin:0px; border: 1px #dfdfdf solid; box-shadow: 1px 3px 4px 2px #fafafa;cursor: cell; font-size: 18px; font-weight: 600; color: #009; font-family: merriweather; text-align: center; white-space: wrap;
          max-height: 45px; min-height: 45px; border: 1px solid #afafaf; padding-top: 4px; font-family: merriweather; color: #009; text-align: center; resize:none; @apply(--layout-self-shrink);}
        details{outline: 0px white solid;}
        summary{outline: 0px white solid;}
        section{background:white;}
        paper-item{border: 1px solid #afafaf;}
        #myContextMenu{min-width: 280px; max-height: 420px; position: fixed; border:4px ridge gold; overflow-y: scroll; box-shadow: 5px 7px 11px 3px #afafaf;}*{@apply(--layout-nowrap);}
</style>
 <array-selector id="columnSelector" items="{{dataArrays}}" multi toggle selected="{{selectedArraySet}}">
 </array-selector>
<!-- <a> -->
<div is-gridbox="true" on-mousedown="closemenu" id="mappedGridContainer" class="horizontal layout flex self-stretch reverse" style="min-width:66.99vw; background: aliceblue; max-width:85.99vw; min-height: 91vh; max-height:96vh; padding-top: 9px;">
<!--side utility editing menu for the spreadsheet-like versions-->

Turn<paper-icon-button icon="icons:dashboard" on-tap="arraySwap"></paper-icon-button>Page 
<div hidden="{{!four}}" id="hanger1" contenteditable="true" style="display:flex; flex-direction: column; flex-wrap:nowrap; max-width: 97.5%; width: auto;">
<div id="hanger3"   contenteditable="true" on-contextmenu="mycontextMenu"  on-focus="setValuesInMap" style="display:flex; flex-direction: row; flex-wrap:nowrap; max-width: 95%; width: auto; overflow: scroll;">
</div>
</div>
  <template is="dom-repeat"  id="mappedGridRepeater" observe="data selected" class="horizontal layout flex" id="template" index-as="columnIndex" items="{{selectedArraySet}}" as="col">
        <div id$="divCol_[[columnIndex]]" hidden="{{four}}" class="vertical layout container nowrap self-stretch">
              <section id$="header_[[columnIndex]]" class="horizontal layout flex nowrap center center-justified self-shrink" data-payload$="{{col.data}}" draggable="true" on-dragstart="startDrag" on-dragover="dragOver" on-drop="handleDrop" style="cursor:pointer; font-weight:700; color: #009; font-size: 18px; overflow: hidden; text-align: background: aliceblue; center; min-width:calc(100vw/28); border-radius: 2px; max-width: 210px; max-height: 58px; min-height: 38px;">
            {{col.name}} 
            <input on-click="highlightCol" type="checkbox" name="hl" value="Bike" checked="{{computeColSelected(col.selected, trigger)}}">
          </section>    
          <template is="dom-repeat" id$="template_{{columnIndex}}" class="vertical flex layout" observe="highlight col row" is="dom-repeat" items="{{col.data}}">
               <!--          <a link={{}}> -->
                <textarea input-type="text" cell="{{item.row}}_{{item.col}}" draggable="true" style="" id$="gridBox[[item.col]][[item.row]]" data-payload$="{{item.payload}}" contenteditable="true"  value="{{item.value}}" class$="cellClass" max-char="450"></textarea>      
            <!--         </a> -->
          </template>
        </div>
  </template>
</div>
<paper-listbox id="myContextMenu"  hidden>
  <paper-item class="around-justified">
        <paper-swatch-picker>
        </paper-swatch-picker><span>  &nbsp; Color Selector &nbsp;&nbsp; &nbsp;</span>
        <input type="color" value="{{color::input}}">
  </paper-item>
    <template is="dom-repeat"  items="{{contextMenuCategories}}" as="category" index-as="categoryIndex">
        <paper-item value="{{category.title}}">
            <details>
                <summary>{{category.title}}</summary>
                <paper-listbox style="min-width:320px; max-width: 321px; ">
                    <template is="dom-repeat" items="{{category.buttons}}" as="item">
                          <paper-item onclick="{{item.myFunction}}" btn-value="{{item.text.0}}" btn-args="{{item.dataArgs}}"style$="padding: 0px; margin: 0px; font-size: 18px; font-weight: 700; font-family: merriweather; color: #009;{{_computeStyle(item.dataProperty, item.text.0, color)}}" btn-prop="{{item.dataProperty}}">                {{item.text.0}}
                              <span btn-prop="{{item.dataProperty}}" btn-function="{{item.datafunction}}"style$="font-size: 24px; font-weight: 300; color: #009;{{_computeStyle(item.dataProperty,item.text.0, color)}}">{{item.text.2}}</span>
                              <span btn-prop="{{item.dataProperty}}" btn-function="{{item.dataFunction}}" btn-args="{{item.dataArgs}}" style$="{{_computeStyle(item.dataProperty, item.text.0,color)}}; font-size: 28px;">{{item.text.1}}</span> 
                          </paper-item>
                    </template> 
                </paper-listbox>
            </details>
        </paper-item>
    </template>
</paper-listbox>
 </template>
 <script>
 FcMappedGrid=Polymer({
 	is:"fc-mapped-grid",
  behaviors:[Polymer.Templatizer, FCBehaviors.FcDataGridBehavior],
  listeners: {"color-picker-selected":"getcolor"},
 	properties: { 
    format:{
      type: Object,
      value:function(){return {};},
      notify: true,
    },
    gridEvent:{
        type: Object,
        value: function(){return {};},
        notify: true, 
    },
   
    btnValue:{
      type: String,
      value:function(){return "";},
      notify: true
    },
    color:{
        type: String,
      value:function(){return "";},
      notify: true        
    },
    arraysIndex:{
        type: Number,
        value: function(){return 0;},
        notify:true,
    },
    four:{     type:Boolean,
     computed:"computefour(arrayIndex)",
      notify: true,
    },
   
   
 	},
ready(){
    var columns=this.setColumns();
     var headerArray=columns.map(function(val,index, array){
             return val.name;
        });
    var columnd=this.parser(headerArray,"accounting", columns);
    this.set("columns", columnd);
    this.parser2();
       this.parser3();
    this.push("dataArrays",this.columns);
    this.push("dataArrays", this.columns2);
    this.push("dataArrays",this.columns3);
        this.push("dataArrays",this.columns4);
    this.set("selectedArraySet", this.dataArrays[this.arrayIndex]);
  },

  mycontextMenu(e){
    console.log(e, self);
    if(e.target.btnValue){
    var btnValue=e.target.btnValue;
      this.set("btnValue", btnValue);
    } 
    this.set("gridEvent", e);
    console.log(this.gridEvent);
    this.$.myContextMenu.hidden=false;
    this.$.myContextMenu.style.left=(e.clientX-330)+"px";
    this.$.myContextMenu.style.top=(e.clientY)+"px";
    this.$.myContextMenu.style.zIndex=25000;
    console.log(e.target);
    this.set("gridEvent",e);
    var key=e.target.getAttribute("id").split("_");//
    if(key[2]==0 && key[1]!=0){
      var returnColumnHeader =this.columnMenu.concat(this.basemenu);
    this.setMenuEntries(returnColumnHeader);
    }
    else if(key[1]==0&&key[2]!=0){
        var returnRowMenu=this.rowMenu.concat(this.basemenu);
         this.setMenuEntries(returnRowMenu);
    }
    else if(key[1]&&key[2]){ this.setMenuEntries(this.basemenu);}
    else{this.setMenuEntries([]);}
  },
  getcolor(e){
    this.set("color",e.detail.color);
  },

  setMenuEntries(returnValue){
      this.set("contextMenuCategories", returnValue);
  },
  closemenu(e){
    this.$.myContextMenu.hidden=true;
  },
 
  stylePropertySelection(e){
    if(this.comparisons&&this.comparisons.get("comparisons_0_15_")){
      if(e.target.btnProp){
        console.log("HERE HERE HERE", e.target.btnProp);
        this.set("changeProperty", e.target.btnProp);
        }
        var value=this.comparisons.get(this.gridEvent.target.id);
        var keys=this.gridEvent.target.id.split("_");
        this.set("btnValue", e.target.btnValue);
        var text=this.btnValue,
        property=(text.match("Highlight Selection"))?`background: ${this.color};`:(text.match("Apply This Text Color"))?`color: ${this.color}`: e.target.btnProp;
     var propertyName=property.split(":");
    for(var i=1;i<50;i++)
    {
          if(value  && keys[2]==0 && keys[1]!=0)
          {
            var newKey="comparisons_"+keys[1]+"_"+i+"_";
             var value=this.comparisons.get(newKey);
           }
          else if(value && value[1] && keys[1]==0 && keys[2]!=0)
          {
            var newKey="comparisons_"+i+"_"+keys[2]+"_";
             var value=this.comparisons.get(newKey);
          }
          else if(value && value[1] && keys[1]==0 && keys[2]==0){
            for(let n of this.comparisons){
             
                    var style=n[1][1].style.cssText;
                  if(style.match(property))
                {
                  var replacer=propertyName[0]+/\[[a-z]+\]:[a-z]+;/;
                  style=style.replace(replacer, "");
                  style=style+property;
                  }
                 else
                    {
                      style=style+property;
                    }
                  n[1][1].style=style;
                  var key=n[1][1].getAttribute("id");//here gets all 
                  this.comparisons.set(key,[n[1][1].value, n[1][1]]);
                
            }
            break;
          }
          else{
            i=52;
            }
          if(value && value[1])
            { 
              var style=value[1].style.cssText;
              if(style.match(property))
                {
                  var replacer=propertyName[0]+/\[[a-z]+\]:[a-z]+;/;
                  style=style.replace(replacer, "");
                    style=style+property;
                }
              else
                {
                  style=style+property;
                }
              value[1].style=style;
            }   
            else{i=52;}
      }//end for loop 
    }//end initialization if for values
  },
  

  _computeStyle(property, text, color){
    if(text||text.match(" ")){
 var retVal=(text.match("Highlight Selection"))||text.match("Alternate Row Highlighting")?`background: ${color};`:(text.match("Apply This Text Color"))?`color: ${color}`: property;
 return retVal;
}
else return "background: gold;";
         //NOTE TODO: MUST SAVE THE SET OF PROPERTIES WILL OVERWRITE EACH TIME!!!
  },
  
computefour(arrayIndex){
    return(arrayIndex===3);
},
  arraySwap(e){
        var arrayNum=(this.arrayIndex===0)?1:(this.arrayIndex===1)?2:(this.arrayIndex===2)?3:0;
        this.set("arrayIndex", arrayNum);
        this.set("selectedArraySet", this.dataArrays[this.arrayIndex]);
  },
 
  });
    </script>
   </dom-module>

