<dom-module id="fc-grid">
 <template id="fc-grid-template">
 <style>
         :host{margin: 12px; padding: 4px;overflow: scroll;position: static;background: white; opacity: 1; @apply(--layout-vertical);@apply(--layout-flex); };
        textarea{margin:0px; border: 1px #dfdfdf solid; box-shadow: 1px 3px 4px 2px #fafafa;cursor: cell; font-size: 18px; font-weight: 600; color: #009; font-family: merriweather; text-align: center; white-space: wrap;
          max-height: 45px; min-height: 45px; border: 1px solid #afafaf; padding-top: 4px; font-family: merriweather; color: #009; text-align: center; resize:none; @apply(--layout-self-shrink);}
        details{outline: 0px white solid;}
        summary{outline: 0px white solid;}
        section{background:white;}
        paper-item{border: 1px solid #afafaf;}
        #myContextMenu{min-width: 280px; max-height: 420px; position: fixed; border:4px ridge gold; overflow-y: scroll; box-shadow: 5px 7px 11px 3px #afafaf;}*{@apply(--layout-nowrap);}
        #mappedGridContainer{min-width:50.99vw; background: aliceblue; max-width:92.99vw; width: 90%; min-height: 50vh; max-height:96vh; height: 100%; padding: 19px; margin: 16px;}
        input{padding: 6px; min-height: 12px; align-items: center;}
        paper-button{
          min-width: 110px; height: 65px; text-align: center; margin: 12px; border: #afafaf solid 2px; box-shadow: 4px 7px 15px 9px slategrey;
        }
        .columnHeader{
          background: yellow; border: 1px silver solid; text-align: center; font-weight: 600; color: #009;
        }
        #polymerGrid{position: absolute; padding: 6px; background: aliceblue;}
</style>

 <array-selector id="columnSelector" items="{{dataArrays}}" multi toggle selected="{{selectedArraySet}}">
 </array-selector>
<!-- <a> -->
<div on-mousedown="closemenu" class="layout horizontal" style="position: relative; width: 100%;">
<section class="layout flex-1 center-justified" style="z-index: 7; position: relative; left:22px;bottom: -2px; top: 1px; width: 137px;padding: 8px 36px 8px 20px;">
BCK<paper-icon-button icon="icons:dashboard" on-tap="arraySwapBack"></paper-icon-button>ONE 

<paper-button on-tap="loadPresets">Load Presets</paper-button>
<!-- <paper-button on-tap="deletedb">delete all</paper-button>
<paper-button on-tap="changeSource">Data Add</paper-button>
<paper-button on-tap="recallSpreadSheet">Access DB</paper-button> -->
              {{arrayIndex}}                      
</section>
<div is-gridbox="true"  id="mappedGridContainer" class="horizontal layout reverse flex-8" style="position: relative; overflow: scroll;">
<!--side utility editing menu for the spreadsheet-like versions-->


<div id="polymerGrid" on-contextmenu="mycontextMenu" class="horizontal layout flex-9 self-stretch reverse">
  <template is="dom-repeat"  id="mappedGridRepeater" observe="data selected" class="horizontal layout flex" id="template" index-as="columnIndex" items="{{selectedArraySet}}" as="col">
        <div id$="divCol_[[columnIndex]]" class="vertical layout container nowrap self-stretch columnHeader" style="position: relative;">
      <section style="display: flex; flex-direction: row;flex: nowrap; white-space: nowrap; overflow-x: scroll; margin: auto; background: yellow; position: absolute: top: 0px; right: 0px; left: 0px;">  [[columnIndex]]
        <input on-click="lockColumn" style="background:yellow;" type="checkbox" name="hl" value="[[columnIndex]]" id="column_{{columnIndex}}_0_inputA" checked="[[computeLockedColumn(columnIndex)]]">
        <input on-click="lockColumn" type="checkbox" style="background:yellow;" name="hl" value="[[columnIndex]]" id="column_{{columnIndex}}_0_inputB" checked="[[computeLockedColumn(columnIndex)]]">
        </section>
        
          <template is="dom-repeat" id$="template_{{columnIndex}}" class="vertical flex layout" observe="highlight col row" is="dom-repeat" items="{{col}}">
               <!--          <a link={{}}>  on-change="{{item.indexedDbFunction}}"
                    on-focus="{{item.indexedDbRequest}}"  hidden="{{__computeCellHidden(item.id, item.key)}}" -->
                <textarea
                   
                    input-type="text" 
                    draggable="true" 
                    id$="{{item.id}}" 
                    value="{{item.value::textarea}}"
                    on-focus="indexedDbRequest"
                    on-change="indexedDbPutter"  
                    contenteditable="true" 
                    style$="{{item.style}}"
                    class$="{{item.class}}"
                    key="{{item.key}}"
                    related-cells="{{item.relatedCells}}"
                    name="{{item.name}}"
                    archive="{{item.archive}}" 
                    max-char="450">  
                </textarea>      
            <!--         </a> -->
          </template>
        </div>
  </template>
  </div>
</div>
<section class="layout flex-1 center-justified" style="z-index: 7; position: relative; right:-2px;bottom: -2px; top: 1px; min-width: 297px;padding: 8px 8px 8px 20px; margin:0px; border-left: 1px silver solid;">
FWD<paper-icon-button icon="icons:dashboard" on-tap="arraySwap"></paper-icon-button>ONE 
<fc-indexed-database maps-array="{{mapsArray}}" data-arrays="{{dataArrays}}">
</fc-indexed-database>
</section>
</div>
<paper-listbox id="myContextMenu"  hidden>
  <paper-item class="around-justified">
        <paper-swatch-picker>
        </paper-swatch-picker><span>  &nbsp; Text Color &nbsp;&nbsp; &nbsp;</span>
        <input type="color" value="{{background::input}}"> Background Color
  </paper-item>
    <template is="dom-repeat"  items="{{contextMenuCategories}}" as="category" index-as="categoryIndex">
        <paper-item on-blur="detailOpenListener" value="{{category.title}}">
            <details on-blur="detailOpenListener" open="{{detailOpen}}">
                <summary>{{category.title}}</summary>
                <paper-listbox id="innerListBox" style="min-width:360px!important; max-width: 360px!important;">
                    <template is="dom-repeat" items="{{category.buttons}}" as="item">
                          <paper-item onclick="{{item.myFunction}}" btn-set-value="{{item.dataSetValue}}" btn-text="{{item.text.0}}" btn-args="{{item.dataArgs}}"style$="padding: 0px; margin: 0px; font-size: 18px; font-weight: 700; font-family: merriweather; color: #009;{{_computeStyle(item.dataProperty, item.dataSetValue, color, background, item.text.0)}}" btn-property="{{item.dataProperty}}">                {{item.text.0}}
                            {{item.text.2}}  
                             {{item.text.1}}
                          </paper-item>
                    </template> 
                </paper-listbox>
            </details>
        </paper-item>
    </template>
</paper-listbox>
 </template>
 <script>
 FcGrid=Polymer({
 	is:"fc-grid",
  behaviors:[Polymer.Templatizer, FCBehaviors.FcGridInitializerBehavior, FCBehaviors.FcGridStyleBehavior],
  listeners: {"color-picker-selected":"getcolor"},
 	properties: { 
    format:{
      type: Object,
      value:function(){return {};},
      notify: true,
    },
    arrayIndex:{
        type: Number,
        value: function(){return 0;},
        observer:"observeIndex",
        notify:true,
    },
   
    parentTarget:{
        type: Object,
        notify: true,
    
    },data:{
      type: Array,
      value: function(){return [];},
      notify: true
    },
      detailOpen:{
        type: Boolean,
        value: function(){return false;},
        notify: true,
      },
      mapsArray:{
        type:Array,
        value: function(){return [];},
        notify: true,


      },
   
 	},

 get gridPresets(){
    return [ [50,50, "JasonTest", "allRed", 1, null, false, undefined, undefined],
      [40,40, "A Calendar", "calendar", 1, null, false, undefined, undefined],
      [30,30, "ACalendar2", "daysofweek", 1, null, true, undefined, undefined],
      [26,26,"jasonGrid2","monthsFinancial",1, null, true, undefined, undefined],
      [16,25,"jasonGrid","allBlue",1, null, true, undefined, undefined],
      [12,12,"months","allBlue",1, null, false, undefined, undefined],
      [38,43,"class","allBlue",1, null, false, undefined, undefined],
      [4,10,"class21","allBlue",1, null, false, undefined, undefined],
      [6,12,"class20","allBlue",1, null, false, undefined, undefined],
      [5,10,"class22","allBlue",1, null, false, undefined, undefined]
      ];
    },

  ready(){
    
      // this.set("selectedArraySet", this.dataArrays[this.arrayIndex]);
    this.set("parentTarget", this.$.mappedGridRepeater);
  },

  attached(){
     this.async(this.arraySwap, 2);
     this.async(this.arraySwapBack,20);
     if(this.dataArrays.length>0&&this.arrayIndex){
      this.set("selectedArraySet", this.dataArrays[this.arrayIndex]);
      }
  },
  detailOpenListener(e){
    console.log(e, "here is the focus lost");
    if(e.target.nodeName==="DETAILS"){
    e.target.open=false;
    }
    else if(e.target.nodeName==="PAPER-ITEM")
    { 
      var children= Polymer.dom(e.target).children; 
      var details=children.filter(function(elem){return (elem.nodeName==="DETAILS");});
      console.log(details);
      details.forEach(function(item){item.attributes.open=false;},this);
    

    }
  },
  __computeCellHidden(id, key){
    var keys=key.split("_");
    return(keys[2]==0);
  },
  

  mycontextMenu(e){
    this.set("gridEvent", e);
    this.$.myContextMenu.hidden=false;
    this.$.myContextMenu.style.left=(e.clientX-330)+"px";
    this.$.myContextMenu.style.top=(e.clientY-80)+"px";
    this.$.myContextMenu.style.zIndex=25000;
    var key=e.target.getAttribute("id").split("_");//
    if(key[2]==0 && key[1]!=0){
      var returnColumnHeader=this.columnMenu.concat(this.basemenu);
    this.setMenuEntries(returnColumnHeader);
    }
    else if(key[1]==0&&key[2]!=0){
        var returnRowMenu=this.rowMenu.concat(this.basemenu);
         this.setMenuEntries(returnRowMenu);
    }
    else if(key[1]&&key[2]){ this.setMenuEntries(this.basemenu);}
    else{this.setMenuEntries([]);}
  },

computeColSelected(one, trigger){},
  getcolor(e){
    this.set("color",e.detail.color);
  },

  setMenuEntries(returnValue){
      this.set("contextMenuCategories", returnValue);
  },
  closemenu(e){
    this.$.myContextMenu.hidden=true;
  },
  _computeStyle(property, val, color, background, text ){
    if(text||text.match(" ")){
 var retVal=(text.match("Remove"))?`background: ${this.defaultFormat.background};`:(text.match("Base"))?`color: ${this.defaultFormat.color};`:(property==="background:")?`background: ${this.background};`:(property==="color:")?`color: ${this.color}`: property + val;
 return retVal;
}
else return "background: gold;";
         //NOTE TODO: MUST SAVE THE SET OF PROPERTIES WILL OVERWRITE EACH TIME!!!
  },
 arraySwap(e){
       var maxNum=this.dataArrays.length;
       console.log(this.dataArrays);
        maxNum=maxNum-1;
        var newIndex=(this.arrayIndex!=maxNum)?parseInt(this.arrayIndex)+1:0;
        this.set("arrayIndex", newIndex);
        this.set("selectedArraySet", this.dataArrays[this.arrayIndex]);
  },
  arraySwapBack(e){
    var maxNum=this.dataArrays.length;
    maxNum=maxNum-1;
    var newIndex=(this.arrayIndex!=0)?parseInt(this.arrayIndex)-1:maxNum;
        this.set("arrayIndex", newIndex);
        this.set("selectedArraySet", this.dataArrays[this.arrayIndex])

  },
observeIndex(newVal, oldVal){
  console.log(newVal, oldVal, "index for names");
},
changeSource(e){
    console.log(this.dataArrays.length);
  this.push("dataArrays",this.holderArray);
    console.log(this.dataArrays.length);
},
loadPresets(e){
  this.gridPresets.forEach(function(gridParams, index, arrayOfGrids){
      this.gridConstructor(gridParams);
      }, this);

},
lockColumn(e){},
startDrag(e){},
dragOver(e){},
handleDrop(e){},
computeLockedColumn(col){},
 
 
  });
    </script>
   </dom-module>

<!--<span btn-property="{{item.dataProperty}}" btn-text="{{item.text.0}}" btn-set-value="{{item.dataSetValue}}" btn-function="{{item.datafunction}}"style$="font-size: 24px; font-weight: 300; color: #009;{{_computeStyle(item.dataProperty, item.dataSetValue, color, background, item.text.0)}}"></span>

 <span btn-property="{{item.dataProperty}}" btn-text="{{item.text.0}}" btn-set-value="{{item.dataSetValue}}" btn-function="{{item.dataFunction}}" btn-args="{{item.dataArgs}}" style$="{{_computeStyle(item.dataProperty, item.dataSetValue, color, background, item.text.0)}}; font-size: 28px;">
 </span> 

 <section style="display: flex; flex-direction: column; background: yellow; flex: nowrap; white-space: nowrap; overflow-x: scroll;">
        <span>{{col.value}}-[[columnIndex]]</span>
        <section style="display: flex; flex-direction: row;flex: nowrap; white-space: nowrap; overflow-x: scroll; margin: auto;">
        <input on-click="lockColumn" type="checkbox" name="hl" value="[[columnIndex]]" style="background:yellow;" id="column_{{columnIndex}}_0_" checked="[[computeLockedColumn(col.id)]]">
        <input on-click="lockColumn" style="background:yellow;" type="checkbox" name="hl" value="[[columnIndex]]" id="column_{{columnIndex}}_0_" checked="[[computeLockedColumn(col.id)]]">
        <input on-click="lockColumn" type="checkbox" style="background:yellow;" name="hl" value="[[columnIndex]]" id="column_{{columnIndex}}_0_" checked="[[computeLockedColumn(col.id)]]">
        <input on-click="lockColumn" type="checkbox" style="background:yellow;" name="hl" value="[[columnIndex]]" id="column_{{columnIndex}}_0_" checked="[[computeLockedColumn(col.id)]]">
             </section>
             </section> -->