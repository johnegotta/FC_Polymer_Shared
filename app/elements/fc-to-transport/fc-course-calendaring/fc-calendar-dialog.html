<dom-module id="fc-calendar-dialog">
<template>
<style>
:host{
background: white;
padding: 0px 3px 4px 8px;
opacity: 1;
position: relative;}
.primary{
	color: #008;
	font-weight:600;
	font-size: 16.5px;
}
.secondary{
		color: brown;
	font-weight:500;
	font-size: 13px;

}
.headerLeft{
height: 42px; width: 42px; color: white; float: left;
top: 10px;

}
.headerRight{
	height: 42px; width: 42px; color: white; float: right;
top: 10px;
}
.footerclass{
	height: 32px;
	padding: 14px;
	color: white;
	background: #03A9F4;
	font-weight: 600;
	text-align: center;
	font-size: 11px;
}
.slides{overflow: hidden; overflow-y: scroll;}

.one{
	font-family: merriweather; 
	font-weight: 600;
	color: #080808;
	font-size: 14px;

	white-space: nowrap;
	display: inline-block;
}
.courseData{
	height: 72px!important;

}
.calendarItem{height: 380px!important;}
.fbutton{text-align: center; width: 99.6%;border: #afafaf 1px solid; border-radius: 3px; z-index: 7; box-shadow: 3px 7px 11px 4px #efefef; padding: 5px 0px; cursor: pointer;}
.fbutton:active{
	border:4px solid #2435C9;
 color: #FFD410;
 box-shadow: inset 0 1px 0 0 #FFF6CE,inset 0 -1px 0 0 #E3C852,inset 0 0 0 1px #FCE88D;
 -moz-box-shadow: inset 0 1px 0 0 #FFF6CE,inset 0 -1px 0 0 #E3C852,inset 0 0 0 1px #FCE88D;
 -webkit-box-shadow: inset 0 1px 0 0 #FFF6CE,inset 0 -1px 0 0 #E3C852,inset 0 0 0 1px #FCE88D;
 background-color: #5DD7FC;
 width: 98.6%
}
.courseItem{
	border: silver 2 solid;
	font-size: 16px;
	color: black;

}
paper-button{max-width: 357px;}

</style>
<fc-event-dialog event="{{dialogEvent}}" id="eventDialog">
</fc-event-dialog>		
<fc-ddr-card drags="true" focused-planner="true" id="focusedPlanner" head-class="darkBlue" is-picker="true" header-title="Focused Planner" class="horizontal layout flex nowrap" style="padding-right:2px; margin: 4px 0px 4px 0px; width: 100%!important;" current-width="{{currentWidth}}" current-height="{{currentHeight}}">


	<div class="horizontal layout flex nowrap">
		<section class="vertical layout flex-4">
 		<div class="flex layout horizontal center-justified">
 			<array-selector 
 					id="arrselector" 
 					items="{{fcCourseObject.eventArray}}" selected="{{selected}}" 
 					multi 
 					toggle>
 			</array-selector>
			<neon-animated-pages 
				class="layout vertical flex-1" 
				id="pages" 
				style="width: 320px; 
				height:400px;" 
				selected="1"
			>
				<fc-calendar-day-back
					id="dayBack"
					is-single="true"
					on-close="_onClose"
					hook="{{hook}}"
					cal-day="{{hook}}"
					
					course-calendar-days="{{fcCourseObject.courseCalendarDaysArray}}" 
					fc-course={{fcCourseObject}}
				>
		
				</fc-calendar-day-back>
				<fc-date-picker-proto
					id="datePickerPro" 
					displayed-month="{{displayedMonth}}" 
					on-tap="_dateSelected" 
					calendar-day-array="{{calendarDayArray}}"
					fc-course="{{fcCourseObject}}" 
					course-calendar-days="{{fcCourseObject.courseCalendarDaysArray}}" 
					id="myCalendarCard">
					<section 
						class="footer fbutton" 
						on-tap="createCalendar">
						Create Calendar from Selected Days
					</section>
				</fc-date-picker-proto>
			</neon-animated-pages>
			<fc-base-event-inputs 
				class="horizontal flex-2 layout" 
				value-options={{valueOptions}} 
				output-options="{{outputs}}" 
				fc-course="{{fcCourseObject}}"
				window-width="{{computedWidth}}">
			</fc-base-event-inputs>
			
			<div class="horizontal layout flex-1">
				<fc-event-element 
					fc-course="{{fcCourseObject}}" 
					inputs="{{inputs}}" 
					class="calendarItem"
					course-calendar-days-array="{{fcCourseObject.courseCalendarDaysArray}}"
					calendar-day-array="{{calendarDayArray}}">
 				</fc-event-element>
 			</div>
 		</div>
 		<paper-tabs 
 			id="calendarTabs" 
 			scrollable="true" 
 			style="padding: 2px 0px; height: 450px; outline: 0px; overflow: hidden; overflow-x: scroll;" 
 			class="horizontal layout" 
 			bar="true" 
 			hide-scroll-buttons="false">  
			<div 
				class="horizontal layout justified" 
				style="width: 100%; margin: 9px; overflow-x: scroll;">
			<template is="dom-repeat" initial-count="16" class="horizontal layout flex" items="{{fcCourseObject.courseCalendarDaysArray}}" as="day">		
				<fc-calendar-day-back 
						back-width="{{backWidth}}"
						back-height="{{}}"
						course-calendar-days-array="{{fcCourseObject.courseCalendarDaysArray}}" 
						fc-course={{fcCourseObject}}
						cal-day="{{day}}"
						event-list="{{day.eventList}}"
						>
						<section class="headerButton flex-1" on-tap="addEvent" style="border-radius:180px;">
					<iron-icon class="small" style="height: 16px!important;width:16px!important; border-radius:180px; color: green; background: silver;"icon="icons:add-circle-outline">
						</iron-icon>
					</section>
				</fc-calendar-day-back>
			</template>

			</div>
		 </paper-tabs> 
	</section>
	<section 
			class="vertical layout flex-1" 
			style="overflow-y: scroll; 
			max-height: 880px;
			border: double 1px #008;
			padding: 12px;
			outline: silver;"
			>
	<paper-button style="background: green; color: white; font-weight: 700; border: 2px double silver;" on-tap="newCalendar">New Calendar</paper-button>
	<paper-button on-tap="clearWorkArea" style="background: yellow; color: brown; font-weight: 700; border: 1px double brown;"> Clear Work</paper-button>
	<paper-button style="background: silver; color: #008; font-weight: 700; border: 1px solid #008;" on-tap="loadToDayCalendar">set primary</paper-button>
	<div style="max-height: 900px; min-height: 700px; width: 100%; width: 340px; margin: 4px 14px 4px 2px; border: 6px silver ridge; overflow-y: scroll;">
	<paper-list-box style="overflow-y: scroll;">
			<template 
				is="dom-repeat" 
				items="{{courses}}" 
				as="course"
			>
				<paper-item 
					on-tap="setCourse" 
					class="layout-horizontal courseItem"
					style="border: silver 1px solid;"
				>
					<paper-item-body  
						class="layout vertical one"
					>
						<div 
							class="primary">
							{{course.coach}} {{course.fcid}}
						</div>
						<div 
							class="secondary">
							[[course.courseMeetingSets]], {{course.numberOfMeetings}} Classes<br>
							Test:{{course.testDate}}, {{course.programLength}}, {{course.price}}
						</div>
					</paper-item-body>   	
					<paper-icon-button 
							icon="star" 
							style="color: {{course.coachObject.color}}"
							alt="favourite this!">
					</paper-icon-button>
		  		</paper-item>
			</template>
	</paper-list-box>

 		</div>
	<paper-button style="max-width: 420px; border: 1px silver solid; background: red; color: white; font-weight: 700;" on-tap="deleteCalendar">Delete Current Calendar</paper-button>
	
	</section>
</div>

</fc-ddr-card>	
</template>
<script>
FcCalendarDialog= Polymer({
	is:"fc-calendar-dialog",
	behaviors:[
			// "FCBehaviors.FcCalendarBehaviorPrime",
			"Polymer.IronResizableBehavior",
		 "FCBehaviors.DraggableBehavior"
		  ],

	listeners: {"click": "myclickgetter"},
	observers:["observeEventTypes(dialogEvent.*, event.*)"],
	properties:{
		fcCourseObject:{
			type: FcCourse,
			notify: true
		},
		computedWidth: {
			type: String, 
			notify: true,
		},
		computedHeight: {
			type: String, 
			notify: true
		},
		backWidth:{
			type: String, 
			computed: "_computeBackWidth(displayType, computedWidth)",
			notify: true
		},
		backHeight: {
			type: String,
			computed: "_computeBackHeight(displayType)",
			notify: true
		},
		displayedMonth:{
			type:Array,
			notify: true
		},
		event: {
			type: Object,
			value: {},
			notify: true
		},
		valueOptions: {
			type: Array, 
			value: [],
			notify: true
			},
		outputs: {
			type: Array,
			value: [],
			notify: true
		},
		hook:{
			type: Array,
			value: [],
			notify: true
		},
		currentHeight:{
			type: String,
			observer:"observeCurrentHeight",
			notify: true
		},
		currentWidth: {
				type: String,
			observer: "observeCurrentWidth",
			notify: true,
		},
		inputs: {
			type: Array,
			value: [],
			notify: true
		},
		calendarDayArray:{
			type: Array,
			value: [],
			notify: true
		}, 
		courses: {
			type: Array, 
			value: [],
			notify: true
		},
		dialogEvent:{
			type: Object,
			value: {},
			notify: true
		}	
	},
	
	ready: function()
	{	
		this.set("fcCourseObject", new FcCourse());
		var self=this;
		var valueArray=FcCourse.getInputs();
		valueArray.forEach(function(item, index, array){
			 self.push("valueOptions",item);

		 });
	},

	attached: function()
	{		
		this.set("firstTime", false);
		var inputO=this.inputValueAndLabelSerialization(this.valueOptions);
		this.set("inputs", inputO);	
		var outputs= this._computeOutput(this.valueOptions, this.fcCourseObject);
		this.set("outputs", outputs);
		console.log(this.fcCourseObject.courseCalendarDaysArray);
		this.getFireBaseCourses();
		console.log(this.courses);
	},

	
	myclickgetter: function(e){
		console.log(e.target, e.parent, e);
	},
	observeEventTypes: function(dev, ev){
	if(dev){console.log(dev, dev.base, dev.value);} 
	if(ev){console.log(ev, ev.base, ev.value);}
	},
	newCalendar: function(){
		course= new FcCourse();
		this.set("fcCourseObject",course);
		this.$.datePickerPro.initialize();
	},
	_sortSlots: function(a,b){
			var ao = stringTime(a.startTime);
			var bo= stringTime(b.startTime); 
		if (ao> bo) {
    		return 1;
  			}
  		if (ao < bo) {
   	 		return -1;
  			}
  		if (ao ===bo){
  			  return 0;
			}
		},

    observeCurrentWidth: function(newVal,oldVal){
 		if(newVal && newVal!=oldVal)
 		{
 		this.set("computedWidth", newVal);
        console.log(newVal);
        var wt= Math.floor(parseFloat(newVal));//making sure no pxs or %s are sent in;
      	Polymer.dom(this).setAttribute("style.width", wt+"px");
    	}
    },
    observeCurrentHeight: function(newVal, oldVal){
    	if(newVal && newVal!=oldVal){
         console.log(newVal, newVal, oldVal,"new, new, old");
        var ht= Math.floor(parseFloat(newVal));//making sure no pxs or %s are sent in;
        this.set("computedHeight",newVal);
      console.log(ht, ht, ht, ht, ht, ht, "this value should set the height");
      Polymer.dom(this).setAttribute("style.height", ht+"px");
    }


    },
    addEvent:function(e){
			console.log(e);
			var index=e.model.day.cdIndex;
				var model = event.model;
				var day=model.day
				var elist=day.eventList;
				var dateId=day.dateId;
				var course=model.__data__.fcCourseObject;
				

			if(index==-1)
			{	var model = event.model;
				var day=model.day;
				var elist=day.eventList;
				var dateId=day.dateId;
				var course=model.__data__.fcCourseObject;
				var index=this.fcCourseObject.courseCalendarDaysArray.length;
				day.cdIndex=index;
				day.inCourseCalendarDayArray=true;
				day.color="#008";
				//day.background="#aecefe";
				day.eventType="private course meeting";
				day.dateText="Session";
			var modelPst=new FcCourseEvent({activity: "Private Course Meeting", name: "Private Course Meeting", color: "purple", cdIndex: index, eventType: day.eventType, courseEventType: day.eventType, date: day.date, showDate: day.showDate, coach: this.fcCourseObject.coach, coachId: this.fcCourseObject.fcid});
				this.push("fcCourseObject.courseCalendarDaysArray",day);
			}
			else{
			var evId =stringTimeToDateTime(this.fcCourseObject.startTime, day.date);
			var pst=new FcEvent({activity: "new event", date: day.date, showDate: day.showDate, coach: this.fcCourseObject.coach, coachId: this.fcCourseObject.fcid, evId: evId});
			if(this.fcCourseObject.courseCalendarDaysArray[index].eventList){
			this.push(["fcCourseObject.courseCalendarDaysArray",index,"eventList"], pst);
			}
			else{this.set(["fcCourseObject.courseCalendarDaysArray",index,"eventList"], []);
				this.push(["fcCourseObject.courseCalendarDaysArray",index,"eventList"], pst);
				}
			}
},

  
	_computeBackWidth: function(displayType, computedWidth)
	{
		
		if(displayType=="One Week At A Time"){
			var width = Math.floor(parseInt(computedWidth)/9);
			return width.toString()+"px";
		}
		else if(displayType=="A Five Day Schedule"){
			var width = Math.floor(parseInt(computedWidth)/6.6);
			return width.toString()+"px";
		}
	
		// "One Day At A Time"

	},
	clearWorkArea: function(){
		var	cda=[];
		var course={};
		course= new FcCourse();
		course.calendarDayArray=this.fcCourseObject.calendarDayArray;
		console.log(course.calendarDayArray);
		this.set("fcCourseObject",course);
		this.set("fcCourseObject.calendarDayArray",course.calendarDayArray);

	},
	_computeBackHeight: function(displayType)
	{

	},
	loadToDayCalendar: function(){
		var calendarDayArray=this.fcCourseObject.calendarDayArray;
		this.set("fcCourseObject.calendarDayArray",course.calendarDayArray);
		console.log(course.calendarDayArray);
		this.$.datePickerPro.initialize(calendarDayArray);
	},

	setCourse: function(e){
			this.set("fcCourseObject",e.model.course);
	},
	deleteCalendar: function(){
		var fcid=this.fcCourseObject.fcid;
		var partRef=FcCourse.getFirebaseLocation();
		var firebase=partRef+"/"+fcid;
		var deleteRef=new Firebase(firebase);
		deleteRef.remove();
		this.set("fcCourseObject", new FcCourse({}));
	}, 
	
	createCalendar: function(){
		var sortedCalDays= this.fcCourseObject.courseCalendarDaysArray.sort(function(a,b){
			if (a.dateId > b.dateId) {
    		return 1;
  			}
  			if (a.dateId < b.dateId) {
   	 		return -1;
  			}
  			if (a.dateId ===b.dateId){
  			  return 0;
			}
		});
		
		 this.set("fcCourseObject.courseCalendarDaysArray", sortedCalDays);
	},


_computeOutput: function(valueOptions, fcCourseObject)
	{
		var length=valueOptions.length;
	 	 var outputArray=[];
	 	for(i=0;i<length;i++)
	  {
	 		var valarr = [];
	 		valarr=valueOptions[i];
	 		var name = valarr[1].label2;
	 			name =name.charAt(0).toLowerCase() + name.slice(1);
	 			name=name.replace(/\s/g,'');
	 		var propertyName ="fcCourseObject."+name;
	 		var eventOutput={
	 			"name":name,
	 			"inputType": "select",
	 			"header":valarr[0].label,
	 			"labelA":valarr[1].label2,
	 			"value": this.fcCourseObject[name] || ""
	 		};
	 		outputArray.push(eventOutput);
	 	}
	 	return outputArray;
	},

inputValueAndLabelSerialization: function(valueOptions)
	 {	
		var length=valueOptions.length;
	 	 var derray=[];
	 	for(i=0;i<length;i++)
	  {	
	 		var valarr = [];
	 		valarr=valueOptions[i];
	
	 		var eventInput={
	 			"name":"",
	 			"inputType": "select",
	 			"header":valarr[0].label,
	 			"labelA":valarr[1].label2,
	 			"labelB":"",
	 			"isRepeaterSelect":true,
	 			"selectItems":valarr[2],
	 			"style":"",
	 			"class": "",
	 			"aside":{	"noteOne:": "",
	 						"noteTwo:": ""}
			};
	 			var name = valarr[1].label2;
	 			name =name.charAt(0).toLowerCase() + name.slice(1);
	 			name=name.replace(/\s/g,'');
	 		eventInput.name=name;
	 		derray.push(eventInput);

	 	}
	 	 return derray;
	 },	
	
_dateSelected: function(event) {
      var targetOne = event.target;
      while (targetOne.nodeName!=="FC-DATE-MINI"&& targetOne !== this && !targetOne._templateInstance && targetOne.nodeName!="PAPER-ICON-BUTTON" && targetOne.nodeName!="PAPER-MATERIAL" && targetOne.nodeName!="BODY") {
        targetOne = targetOne.parentNode; 
       }
       if(targetOne.nodeName=="FC-DATE-MINI")
         {
         	
         	this.set("hook", targetOne.day);
         	this.set("hook.eventList", targetOne.day.eventList);
        
      this.sharedElements = {
        'hero': this.$.dayBack
      };
             this.$.pages.selected = 0;
        }    
    },


    _onClose: function() {
      this.$.pages.selected = 1;
    },

  computeYear: function(displayedMonth)
{	
	if(this.displayedMonth[15])
	{
	return displayedMonth[15].date.getFullYear();
	}
},

 getFireBaseCourses: function(){
 		var self=this;
 		var ref = new Firebase(FcCourse.getFirebaseLocation());

 		ref.on("child_added", function(snapshot, prevChildKey) {
  				var course = snapshot.val();
  				if(snapshot.key()!="counter")
  				{
  					self.push("courses", course);
  				}
  			});


 },
  openup: function(e){
    		console.log(e);
    		var event=e.model.__data__.event;
    		this.$.eventDialog.openDi();
    		console.log(this.$.eventDialog, event);
    		this.set("dialogEvent", event);
    		console.log(this.$.eventDialog, event, this.dialogEvent);

    },


});
</script>
</dom-module>
