<dom-module id="fc-input-search-select">	
<template>
<style>
root{--label-position-top:-53px;
  --label-position-bottom:3px;
 }
:host{background:"";}
paper-item{--paper-item-focused:{background: orange;};
   @apply(--paper-item-focused);
  }
input,
span, {
 display: block;
  margin: 6px;
  padding: 4px;
  border: none;
  background: "none";
  font-size: 16px;
}
input.question.menuItem{
 visibility: hidden;
 width: 110px;
    font-size: 18px;
  font-family: merriweather;
  color: brown;
  font-weight: 700;
}


textarea:focus,
input:focus {
  /*outline: 1px green solid;*/
  margin-bottom: 6px;
}


input.question {
  font-size: 20px;
  font-weight: 300;
  border-radius: 2px;
  margin: 0;
  border: none;
  opacity: .5;
  width: 100%;
  background: rgba(0, 0, 0, 0);
  transition: padding-top 0.4s ease, margin-top 0.4s ease;
  overflow-x: hidden;
}

input.question + label{
  display: block;
  position: relative;
  white-space: nowrap;
  padding: 0;
  margin: 0;
width: 90%;
  border-top: 1px solid red;
  -webkit-transition: width 0.4s ease;
  transition: width 0.4s ease;
  height: 0px;
}

input.question:focus + label
{
  width: 102%;
  border-top: 3px solid #005c00;
   -webkit-transition: width 0.3s ease, border-top .3s ease;
  transition: width 0.3s ease, border-top .3s ease;
}
input.question:focus + label > span{
top: -53px;
  z-index:1;
  font-size: 16px;
  font-family: merriweather;
  color: #050;
  -webkit-transition: color 0.3s ease, top .3s ease;
  transition: color 0.3s ease, top .3s ease;
}
input:valid + label + paper-listbox{
  display:none; z-index: -1; left:0px; right:0px; top:30px; opacity: 0;
         -webkit-transition: top 0.6 ease, display 0.6s ease, opacity 0.6s ease,z-index 0.6s ease;
  transition: top 0.6s ease, display 0.6s ease, opacity 0.6s ease, z-index 0.6s ease;
}
input:focus + label + paper-listbox{
  display:block; z-index: 45; left:0px; right:0px; top:30px; opacity: 1;
         -webkit-transition: top 0.6 ease, display 0.6s ease, opacity 0.6s ease;
  transition: top 0.6s ease, display 0.6s ease, opacity 0.6s ease;
}
input.question:valid + label > span {
  top: 3px;
  z-index:0;
  font-size: 16px;
  font-family: merriweather;
  color: #005c00;
}
input.menuItem:blur + label + paper-listbox.menuItem{
   display: none;
      position: absolute;
      background-color: #efefef;
      min-width: 160px;
      opacity: 0;
      z-index:-1;
      box-shadow: 3px 8px 16px 5px #afafaf;
    -webkit-transition: background-color 0.6 ease, display 0.6s ease, opacity 0.6s ease;
  transition: background-color 0.6s ease, display 0.6s ease, opacity 0.6s ease;
}

input.question:valid + label{
  border-color: green;
}

input.question:invalid{
  box-shadow: none;
}


input.question + label > span{
  font-weight: 300;
  margin: 0;
  position: absolute;
  color: grey;
  font-size: 22px;
  top: -26px;
  left: 0px;
  z-index: 0;
  -webkit-transition: top 0.3s ease, font-size 0.3s ease, color 0.3s ease;
  transition: top 0.3s ease, font-size 0.3s ease, color 0.3s ease;
}
input.question.menuItem + label.menuItem > span{
    font-size:14px;
    font-color: brown;
    font-weight: 700;
}

input.question.menuItem + label.menuItem{
  border-top: 0px white dashed;
}
input.question + label > span:active {
  top: -53px;
  z-index:1;
  font-size: 16px;
  font-family: merriweather;
  color: #050;
}
input.question.cell + label{
  border-top:0px white solid;
}
input.menuItem:valid{
visibility: visible;
-webkit-animation: appear 1.2s forwards;
  animation: appear 1.2s forwards;
} 
input.menuItem+label+paper-listbox.show{
   font-size: 18px;
  font-family: merriweather;
  color: #005c00;
  font-weight: 300;
  display:block; z-index: 45; left:0px; right:0px; top:30px; opacity: 1;
         -webkit-transition: top 0.6 ease, display 0.6s ease, opacity 0.6s ease;
  transition: top 0.6s ease, display 0.6s ease, opacity 0.6s ease;


}

input.question.cell +label + paper-list-box{display: none;}

input.question:valid  input[type="submit"], textarea.question:valid  input[type="submit"] {
  -webkit-animation: appear 1.2s forwards;
  animation: appear 1.2s forwards;
}

input.question:invalid  input[type="submit"], textarea.question:invalid  input[type="submit"] {
  display: none;
}

span.above {
top: -53px;
  z-index:1;
  font-size: 16px;
  font-family: merriweather;
  color: #050;
}

@-webkit-keyframes appear {
  100% {
    opacity: 1;
  }
}

@keyframes appear {
  100% {
    opacity: 1;
  }
}
.dropbtn{
 margin-top:-8px;
}.dropbtn.menuItem{margin:8px;}

 .dropbtn:hover, .dropbtn:focus{
  
  }
  .defaultToggleButtonClass{background: gold; border-radius: 50%;}
  .toggleDeleteColumn{background: red; border-radius: 50%; @apply(--layout-horizontal);} 
  .toggleAddColumn{background: aqua; border-radius: 50%; @apply(--layout-horizontal); }
 
  .selectColor{
   background: orange;
  }
  .dropbtn.cell{
    display: none;
  }

  input{outline: 0px;
    border: 0px;
    border-bottom: #009 solid 2px;}
  /* The container <div> - needed to position the dropdown content */
  .dropdown {
      position: relative;
      display: inline-block;
  }
 /* / Dropdown Content (Hidden by Default) /*/
  .dropdown-content {
     display: none;
      position: absolute;
      background-color: #efefef;
      min-width: 160px;
      opacity: 0;
      box-shadow: 3px 8px 16px 5px #afafaf;
  }
/*  / Links inside the dropdown /*/
  .dropdown-content a {
      color: #009;
      padding: 8px 16px;
      text-decoration: none;
      display: block;
      margin-top:32px;
  }
  .check{
   font-size:24px;
   text-align: right;
   color: #009;
   position: absolute;
   left: 5px;
  }
  .show {/*display:block; z-index: 45; left:0px; right:0px; top:30px;*/ opacity: 1;
         -webkit-transition: top 0.6 ease, display 0.6s ease, opacity 0.6s ease;
  transition: top 0.6s ease, display 0.6s ease, opacity 0.6s ease;}

</style>
<array-selector id="selector" items="{{dropdownItems}}" selected="{{selected}}" multi="{{multiSelect}}"></array-selector>
<iron-a11y-keys id="a11y1" target="[[target]]" keys="down" on-keys-pressed="onDownArrow"></iron-a11y-keys>
<iron-a11y-keys id="a11y2" target="[[target]]" keys="up" on-keys-pressed="onUpArrow"></iron-a11y-keys>
<iron-a11y-keys id="a11y3" target="[[target]]" keys="enter" on-keys-pressed="onEnter"></iron-a11y-keys>
<iron-a11y-keys id="a11y4" target="[[target]]" keys="esc" on-keys-pressed="onEsc"></iron-a11y-keys>


<div class="horizontal layout flex">
<!-- <paper-menu-button id="dropdownMenuButton" class="vertical layout dropdown">-->
    <paper-icon-button id="dropdownbutton" class$="dropbtn dropdown-trigger {{issClass}}" hidden="{{!showDropButton}}" icon="{{issIcon}}" on-tap="inputToggle"> 
    </paper-icon-button>
<div class="vertical layout dropdown" on-down="focusInput">
	<input id="issInput" class$="question {{issClass}}" required value="{{issValue::input}}" is-multi-select="{{isMult}}" on-change="{{sortArrayForMultiSelect(isMulti)}}" name="[[issName]]">
		<label for="issInput" class$="{{issClass}}"><span class$="{{_computeLabelSpanClass(isToggle,toggleClass,issClass)}}">{{issLabel}}</span></label>
			<paper-listbox id="dropdownlist" class$="dropdown-content {{issClass}}" hidden="{{!dropdownItems}}" style$="min-height:220px; max-height:{{maxHeight}}px; overflow-y: scroll;">
		 		<template is="dom-repeat" id="controllerList" style="height: 2200px;" items="{{dropdownItems}}" observe="selectCheck value name propertyName val" filter="{{createFilter(issValue, searchOff)}}">
					<paper-item class="block" style="border: 1px silver solid;margin-top: 3px; color: #006; font-size: 20px; font-weight:600;font-family:times;text-align: center;" on-up="toggleSelection">
          <span hidden$="{{!item.selectCheck}}" class="check">&#10148;</span>

          <span>{{_computeItemSelectedPropValue(item,index, itemSelectProperty)}}</span>
          </paper-item>
		 		</template>
		 	</paper-listbox>
		</div>
	</div>

	</template>
<script>
FcInputSearchSelect=Polymer({
	is:"fc-input-search-select",
	properties:{
    baseScrollTop:{
          type: Number,
          notify: true
        },  
		
		dropdownItems:{
			type:Array,
      value:function(){return[];},
			 notify: true,
      observe:"observeDropdownItems",
		},
	
         dropdownOpen:{
          type: Boolean,
          value:function(){return false;},
          notify: true,
          observer:"observeDropdown",
        },
  		dropdownlist:{
  			type: Object,
  			value:function(){
  				return this.$.dropdownlist;
  			},
        notify: true
  		},
       hostAttributes:{
          value:{
            notify: true
          }
      },
       issClass:{
          type: String,
          notify: true,
          observer:"observeIssClass",
        },
  
  		issId:{
  				type: String,
  				notify: true,
  		},
      issIcon:{
        type:String,
        value:function(){return "icons:dashboard";},
        notify: true,
      },
      issLabel:{
          tinpiype:String,
          value:function(){return "";},
          notify: true
      },
  		issName:{
  			type: String,
  			notify: true
  		},
      issValue:{
      type: String,
      notify: true,
      observer:"observeIssInput",
    },
      issValueArray:{
        type:Array,
        value:function(){return [];},
        notify: true,
      },
      isToggle:{
          type:Boolean,
          value: function(){return false;},
          notify: true
      },
  	itemSelectProperty:{
  			type: String,
  			value: function(){return "";},
  			notify: true
  		},
  	itemKeyStrokeIndex:{
  			type: Number,
  			value: function(){return -889;},
  			notify: true,
  		},
   
 maxHeight: {
      type: String,
      value:function(){return "180";},
      notify:true,
     },
   
        multiSelect:{
        	type:Boolean,
        	value:function(){return false;},
        	notify: true,
        },
     
        searchOff:{
          type: Boolean,
          value:function(){return false;},
          notify: true,
        },
          selected:{
      notify: true,
    },
     selectedArray:{
        type: Array,
        notify: true
      },
    
        shadowIndex:{
        		type:Object,
        		computed:"_computedSetterForIndex(multiSelect, dropdownOpen)",
        		notify: true,
        },
          showDropButton:{
      type:Boolean,
      value:function(){return false;},
      notify: true,
    },
        startScrollTop:{
          type: Number,
          notify: true
        },
      target: {
        type: Object,
        value: function() {
          return this.$.issInput;
          },
        // observer:"_observeInput", 
        notify: true
      },
        toggleClass:{
        type: String,
        value:function(){"";},
        notify: true,
      },
      topHolder:{
          type:Number,
          value:function(){return 0;},
          notify: true
      },
      holder:{
         type: String,
        value:function(){"";},
        notify: true,
      }
      
	},//end properties
	ready(){
    var retVal=(this.multiSelect===true)?[]:"";
    this.set("selected",retVal);
    retVal=(this.multiSelect===true)?Array:String;
    this.set("selected.type", retVal);
     },
 attached(){
  //console.log(this.$.dropdownlist.scrollTop);
  this.set("startScrollTop",this.$.dropdownlist.scrollTop);
  this.set("baseScrollTop",this.$.dropdownlist.scrollTop);
  if((this.dropdownItems&&this.dropdownItems.length>0)||this.issClass==="menuItem"){
    this.set("showDropButton",true);
  }
  if(this.isToggle===true){
    this.toggleToggleButton();
    this.set("searchOff",true);
    }
 
 },

 _computeLabelSpanClass(isToggle,toggleClass,issClass){
        return this.issClass;
 },
 observeIssInput(nv, ov){
//console.log(nv, ov);
 },
 _computeItemSelectedPropValue(item, index,isp){
	 		var retval=(isp==="")?item:item[isp];
       return retval;
	 },// doItAgain(){return this.call(this.doItAgainTempVar());}, REVISIT WHEN HOOKING UP SCHOOL CHOICE
  observeDropdownItems(newVal,oldVal){
    if(newVal&&newVal.length>0){
    }
  }, 

  observeIssClass(nv,ov){
    // if(nv){console.log(nv, ov)};
  },
	focusInput(){
    this.set("dropdownOpen",true);
    this.$.issInput.focus();
    this.async(function(){
          this.$.issInput.focus;},50);
  },
   blurInput(){
     //   this.$.dropdownMenuButton.set("opened", false);
    this.set("dropdownOpen",false);
         this.$.issInput.blur();
    this.async(function(){
          this.$.issInput.blur;},20);
 },
  observeDropdown(newVal,oldVal){
    if(newVal===true){
        var self=this;
        this.async(function(){Polymer.dom(this.$.dropdownlist).classList.add("show");}, 320);
      }
    else{
        this.async(function(){Polymer.dom(this.$.dropdownlist).classList.remove("show");}, 500);
          }
        },
  inputToggle(e){
    console.log(this.isToggle, this.dropdownOpen, this.showDropButton);
      var retFunc=(this.isToggle===true)?"toggleToggleButton":(this.dropdownOpen===false&&this.showDropButton===true)?"focusInput":"blurInput";
      console.log(retFunc, this.issLabel);
      this[retFunc](e);
  },
  toggleToggleButton(e){
        var label="";
        var newLabel="";
        console.log(e);
        console.log(e);
      if(this.issLabel!=null){this.actualToggleFunction()}
      else{this.async(this.actualToggleFunction,250);}
      },

  actualToggleFunction(){
     if(this.issLabel.charAt(this.issLabel.length-3)!=="O")
        {
          newLabel=this.issLabel + " OFF";
        }
        else if(this.issLabel.charAt(this.issLabel.length-2)==="F"){
          label=this.issLabel.slice(0,-4);
          newLabel=label+" ON ";
          Polymer.dom(this.$.dropdownbutton).classList.add(this.toggleClass);
        }
        else{
          label=this.issLabel.slice(0,-4);
          newLabel=label+" OFF"; 
          Polymer.dom(this.$.dropdownbutton).classList.remove(this.toggleClass);
        }  
        this.set("issLabel",newLabel);
        }, 
	createFilter(issValue, searchOff){
    if(searchOff)return function(item){return true;}
    else{
      var self=this, isp=self.itemSelectProperty;
        var regex = new RegExp('.*' + issValue + '.*', 'i');
        return function(item) {
          if(self.multiSelect===true){return true;}
          else if(item[self.itemSelectProperty]){return item[self.itemSelectProperty].match(regex);}
          else if(item.value){return item.value.match(regex);}
        };
      }
  },
  _computedSetterForIndex(multi, ddo){
     // console.log("insetter for index",ddo, multi);
   		// var setVal=(!ddo)?0:this.itemKeyStrokeIndex;
   		// this.set("itemKeyStrokeIndex", setVal);
   		// return setVal;
   	},
  getDropdownChildren(){
    var children=Polymer.dom(this.$.dropdownlist).children;
        itemChildren=children.filter(function(val,index, array){
              return (val.nodeName==="PAPER-ITEM");});
        return itemChildren;
  },
  removeColorFromChildren(children){
    var retChildren=children.map(function(val,index, array){
      if(val.classList.contains("selectColor")){val.classList.remove("selectColor");}
        return val;
        });
    return retChildren;
    },
  sortArrayForMultiSelect(e){
    var valArr=this.issValue.split(",");
    console.log(valArr);
    var length=valArr.length;
    var arr=this.issValueArray;
    var size=arr.length;
    var diff=size-length;
    console.log(diff,valArr, arr);
  },
  toggleSelection(e){
    var item = this.$.controllerList.itemForElement(e.target);//console.log(item);
    var model=this.$.controllerList.modelForElement(e.target);
    //console.log(item,model);
    var targ=e.target;
    while(targ.nodeName!=="PAPER-ITEM"){targ=targ.parentElement;}
    if(targ.nodeName==="PAPER-ITEM"){
    	if(this.dropdownOpen===true && this.$.controllerList){
        var setval=(this.itemSelectProperty==="" )?item:model.item[this.itemSelectProperty];
        var children=this.getDropdownChildren();
          if(this.$.selector.multi===false && this.searchOff===false){
                
                this.set("issValue",setval);
                Polymer.dom(children[0]).classList.add("selectColor");
              }
          else if(this.$.selector.multi===false && this.searchOff===true){
                this.removeColorFromChildren(children);
                Polymer.dom(targ).classList.add("selectColor");
                this.set("issValue",setval);
                // if(this.itemSelectProperty==""){
                //   index=children.indexOf(setval);
                //   Polymer.dom(children[index]).classList.add("selectColor");
                // }
          }
          else if(this.$.selector.multi===true&&model.item.selectCheck===true){
    		    this.$.selector.deselect(setval); 
    		    model.set("item.selectCheck",false);
            var index=this.issValue.indexOf(setval);
            this.set("issValue","");//fix this to choose type for value at attached and get rid oif the double value bullshit
            index=this.issValueArray.indexOf(setVal);
    		    this.splice("issValueArray",index, 1);
            var showvalue=this.issValueArray.toString();
            this.set("issValue", showvalue);
            Polymer.dom(targ).classList.remove("selectColor");
            //console.log(this.issValue, typeof this.issValue, this.issValue.length);
          }    		  
          else if(this.$.selector.multi===true&&model.item.selectCheck===false){
            this.$.selector.select(item[this.itemSelectProperty]);
            this.push("issValueArray",item[this.itemSelectProperty]);
            model.set("item.selectCheck", true);
            this.set("issValue",null);
            Polymer.dom(targ).classList.add("selectColor");
            var showvalue=this.issValueArray.toString();
            this.async(function(){this.set("issValue", showvalue);}, 50);
            // this.valueMap.set(item,this.issValue);
          }
        }
		  this.set("dropdownOpen",false);
		}
  },
  updateAllyKeyChangedItemInColumnPosition(dy, elem){
        this.trackDelta = dy || this.trackDelta || 0;
        //console.log(this.trackDelta);
        var scrollDelta = this.$.dropdownlist.scrollTop - this.startScrollTop;
        var pos = this.trackDelta + scrollDelta;
        this.translate3d(0, -pos + 'px', 0, elem);
    },
  onDownArrow(e){
          this.set("startScrollTop", this.$.dropdownlist.scrollTop);
      	 var children=this.getDropdownChildren(),setterBase=this.itemKeyStrokeIndex;
         var last=(children.length-1),oneLess=(setterBase-1),oneMore=(setterBase+1);
         var bool=children[last]._templateInstance.item.selectCheck;
         var element=children[oneMore]; 
         var preSib=children[setterBase];
         var clas="selectColor";
         var func="classFollows";
         // //console.log(clas, bool, elem,previous);
          if(this.itemKeyStrokeIndex<0||this.itemKeyStrokeIndex===last){
            this.set("itemKeyStrokeIndex", 0);
            var elem=children[this.itemKeyStrokeIndex];
            var previous=children[last];
            var setVal=[func, clas,elem,previous,0];
            Polymer.dom(elem).classList.add(clas); 
            this[setVal[0]](setVal[1],setVal[2],setVal[3]);
            element=elem;
          }
          else{
   
          var setVal=(setterBase===last&&children[last]._templateInstance.item.selectCheck===false)?["classFollows",clas, children[0],children[last],0, "ONE"]:["classFollows",clas, children[oneMore], children[setterBase],oneMore, "TWO"];
          //console.log("inelse else", setVal,setVal[5]);
        
            this.set("itemKeyStrokeIndex",setVal[4]);
            this[setVal[0]](setVal[1],setVal[2],setVal[3]);
          }
            var boundRect=element.getBoundingClientRect();
            var delta=boundRect.height+3;
            this.$.dropdownlist.scrollTop=(this.$.dropdownlist.scrollHeight - this.$.dropdownlist.scrollTop === this.$.dropdownlist.clientHeight)?this.baseScrollTop:this.$.dropdownlist.scrollTop+delta;       
    },
  onUpArrow(e){
      	var children=this.getDropdownChildren();
        var last=(children.length-1);
        setVal=(this.itemKeyStrokeIndex==0)?last:(this.itemKeyStrokeIndex-1);  ;  	
        this.set("itemKeyStrokeIndex",setVal);
        children=this.removeColorFromChildren(children);
      	var elem=children[this.itemKeyStrokeIndex];
      	elem.classList.add("selectColor");
      	var rect=elem.getBoundingClientRect(),
      	ht=window.getComputedStyle(elem,null).getPropertyValue("height"), 
      	height=rect.height;
 		   this.$.dropdownlist.scrollTop=this.$.dropdownlist.scrollTop-(Math.floor((height+ht)/2)+2);
      },
  onEnter(e){
      var children=Polymer.dom(this.$.dropdownlist).children;
      if(this.itemSelectProperty===""){
        this.set("issValue",children[this.itemKeyStrokeIndex]._templateInstance.item);
        children=this.getDropdownChildren();
        var elem=children[0];
        Polymer.dom(elem).classList.add("selectColor"); 

      }
      else if(this.multiSelect===false){
        var value=children[this.itemKeyStrokeIndex]._templateInstance.item[this.itemSelectProperty];
        this.set("issValue", value);
        }
      else if(this.multiSelect===true){
         var value=children[this.itemKeyStrokeIndex]._templateInstance.item[this.itemSelectProperty];
        var model=children[this.itemKeyStrokeIndex]._templateInstance;
         this.set("issValue","");
        if(children[this.itemKeyStrokeIndex]._templateInstance.item.selectCheck===true){
          model.set("item.selectCheck", false);
          var index = this.issValueArray.indexOf(value);
          this.splice("issValueArray",index, 1);
          var newVal=this.issValueArray.toString();
          this.set("issValue", newVal);
        }
        else{ 
              model.set("item.selectCheck", true);
              this.push("issValueArray", value);
               var newVal=this.issValueArray.toString();
              this.set("issValue", newVal);
            }
      }
      if(this.$.selector.multi===false){this.blurInput();}
    },

  
});
</script>
</dom-module>
