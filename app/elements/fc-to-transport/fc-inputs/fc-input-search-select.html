<dom-module id="fc-input-search-select">	
<template>
<style>
root{--label-position-top:-53px;
  --label-position-bottom:3px;
 }
:host{background:"";}
paper-item{--paper-item-focused:{background: orange;};
   @apply(--paper-item-focused);
  }
input,
span, {
 display: block;
  margin: 6px;
  padding: 4px;
  border: none;
  background: "none";
  font-size: 16px;
}

textarea:focus,
input:focus {
  outline: 0;
  margin-bottom: 6px;
}


input.question {
  font-size: 20px;
  font-weight: 300;
  border-radius: 2px;
  margin: 0;
  border: none;
  opacity: .5;
  width: 97%;
  background: rgba(0, 0, 0, 0);
  transition: padding-top 0.4s ease, margin-top 0.4s ease;
  overflow-x: hidden;
}

input.question + label{
  display: block;
  position: relative;
  white-space: nowrap;
  padding: 0;
  margin: 0;
/* width: 10%;*/
  border-top: 1px solid red;
  -webkit-transition: width 0.4s ease;
  transition: width 0.4s ease;
  height: 0px;
}

input.question:focus + label,
{
  width: 93%;
}
input.question:focus + label > span {
top: -53px;
  z-index:3;
  font-size: 16px;
  font-family: merriweather;
  color: #050;
}
input.question:valid + label > span {
  top: 3px;
  z-index:0;
  font-size: 16px;
  font-family: merriweather;
  color: #050;
}

input.question:valid + label{
  border-color: green;
}

input.question:invalid{
  box-shadow: none;
}


input.question + label > span {
  font-weight: 300;
  margin: 0;
  position: absolute;
  color: grey;
  font-size: 22px;
  top: -26px;
  left: 0px;
  z-index: 0;
  -webkit-transition: top 0.4s ease, font-size 0.4s ease, color 0.4s ease;
  transition: top 0.4s ease, font-size 0.4s ease, color 0.4s ease;
}

input.question:valid  input[type="submit"], textarea.question:valid  input[type="submit"] {
  -webkit-animation: appear 1.2s forwards;
  animation: appear 1.2s forwards;
}

input.question:invalid  input[type="submit"], textarea.question:invalid  input[type="submit"] {
  display: none;
}

@-webkit-keyframes appear {
  100% {
    opacity: 1;
  }
}

@keyframes appear {
  100% {
    opacity: 1;
  }
}
.dropbtn{
 margin-top:-8px;
}

 .dropbtn:hover, .dropbtn:focus{
      
  }
  .selectColor{
   background: orange;


  }
  input{outline: 0px;
    border: 0px;
    border-bottom: #009 solid 2px;}
  /* The container <div> - needed to position the dropdown content */
  .dropdown {
      position: relative;
      display: inline-block;
  }
 /* / Dropdown Content (Hidden by Default) /*/
  .dropdown-content {
      display: none;
      position: absolute;
      background-color: #efefef;
      min-width: 160px;
      box-shadow: 3px 8px 16px 5px #afafaf;
  }
/*  / Links inside the dropdown /*/
  .dropdown-content a {
      color: #009;
      padding: 8px 16px;
      text-decoration: none;
      display: block;
      margin-top:32px;
  }
  .check{
   font-size:24px;
   text-align: right;
   color: #009;
   position: absolute;
   left: 5px;
  }
  .show {display:block; z-index: 45; left:0px; right:0px; top:40px;}

</style>
<array-selector id="selector" items="{{itemsArray}}" selected="{{selected}}" multi="{{multiSelected}}"></array-selector>
<iron-a11y-keys id="a11y" target="[[target]]" keys="down" on-keys-pressed="onDownArrow"></iron-a11y-keys>
<iron-a11y-keys id="a11y" target="[[target]]" keys="up" on-keys-pressed="onUpArrow"></iron-a11y-keys>
<iron-a11y-keys id="a11y" target="[[target]]" keys="enter" on-keys-pressed="onEnter"></iron-a11y-keys>

<div class="horizontal layout flex">
	<paper-icon-button class="dropbtn" on-up="focusInput" hidden$="{{!itemSelectProperty}}"  icon="icons:dashboard" on-tap="toggleDropdownOpen">  
  </paper-icon-button>
	<div class="vertical layout dropdown">
		<input id="issInput" class="question"required autocomplete="on" value="{{issValue::input}}" name="[[issName]]" on-down="openDropdown" on-up="focusInput">
				<label for="issInput"><span on-down="focusInput">{{issLabel}}</span></label>
			<paper-list-box id="dropdownlist" class="block dropdown-content" hidden="{{!dropdownItems}}" style="min-height: 220px; overflow-y: scroll;">
		 		<template is="dom-repeat" id="controllerList" style="height: 2200px;" items="{{dropdownItems}}" filter="{{createFilter(issValue)}}">
					<paper-item class="block" style="border: 1px silver solid;margin-top: 3px; color: #006; font-size: 20px; font-weight: 600;font-family:times;text-align: center;" on-tap="toggleSelection">
          <span hidden$="{{!item.selectCheck}}" class="check">&#10148;</span><span>{{_computeItemSelectedPropValue(item, dropdownItems,itemSelectProperty)}}</span>
          </paper-item>
		 		</template>
		 	</paper-list-box>
		</div>
	</div>

	</template>
<script>
FcInputSearchSelect=Polymer({
	is:"fc-input-search-select",
	// listeners:{"click":"elemclick"},
	properties:{
		issValue:{
			type:String,
			value:function(){return "";},
			notify: true,
		},
		dropdownItems:{
			type:Array,
      value:function(){return[];},
			notify: true,
		},
		selected:{
			type:Array,
			value:function(){return [];},
			notify: true,
		},
		target: {
    		type: Object,
    		value: function() {
      		return this.$.issInput;
    			}, 
        notify: true
  		},
  		dropdownlist:{
  			type: Object,
  			value:function(){
  				return this.$.dropdownlist;
  			}
  		},
  		issId:{
  				type: String,
  				notify: true,
  		},
  		issName:{
  			type: String,
  			notify: true
  		},
  		issLabel:{
  				type:String,
          value:function(){return "";},
  				notify: true
  		},
  	itemSelectProperty:{
  			type: String,
  			value: function(){return "name";},
  			notify: true
  		},
  	itemKeyStrokeIndex:{
  			type: Number,
  			value: -1,
  			notify: true,
  		},
 
  
      topHolder:{
      		type:Number,
      		value:function(){return 0;},
      		notify: true
      },
  
        multiSelected:{
        	type:Boolean,
        	value:function(){return false;},
        	notify: true,

        },
        dropdownOpen:{
        	type: Boolean,
        	value:function(){return false;},
        	notify: true
        },
        shadowIndex:{
        		type:Object,
        		computed:"_computedSetterForIndex(multiSelected, dropdownOpen)",
        		notify: true,
        },
        itemArray:{
          notify:true,
        },
        item:{
          obserever:"_observeItem",
          notify: true
        },
        
	},//end properties
	_observeItem(nv,ov){
    console.log(nv,ov, "read these values");

  },
	_computeItemSelectedPropValue(item, isp){
	  if(isp!==undefined){ 
		var pickle=function(){
			var retval=(isp==="__")?item:item[isp];return retval;
			};
			this.doItAgainTempVar=pickle(); 
		return this.doItAgainTempVar;
		}
	else{
		this.async(this.doItAgain,1500);
		}
	},
	doItAgain(){return this.call(this.doItAgainTempVar());},
	focusInput(){this.$.issInput.focus();},
	openDropdown(){this.set("dropdownOpen",true);Polymer.dom(this.$.dropdownlist).classList.add("show");},
  closeDropdown(){this.set("dropdownOpen",false);Polymer.dom(this.$.dropdownlist).classList.remove("show");},
	createFilter(issValue) {
        var regex = new RegExp('.*' + issValue + '.*', 'i');
        return function(item) {
          return item.match(regex);
      		};
      },
  toggleDropdownOpen(){
    	var setVal=(this.dropdownOpen)?["closeDropdown", false]:["openDropdown",true];
    	this[setVal[0]]();
    	this.set("dropdownOpen",setVal[1]);
    },
  _computedSetterForIndex(multiSelected, ddo){
   		var setVal=(!ddo)?0:this.itemKeyStrokeIndex;
   		this.set("itemKeyStrokeIndex", setVal);
   		return setVal;
   	},
   
    toggleSelection(e){
    	if(this.dropdownOpen===true){
        var item = this.$.controllerList.itemForElement(e.target);
        var model=this.$.controllerList.modelForElement(e.target);
        if(!this.$.selector.multi || (this.$.selector.multi===true && (model.item.selectCheck && model.item.selectCheck===false))){
        	this.$.selector.select(item);
        	var setval=(!this.dropdownItems)?"":(this.itemSelectProperty==="---")?this.issValue: (this.itemSelectProperty==="__")?model.item:model.item[this.itemSelectProperty];
        	this.set("issValue",setval);
        	if(this.$.selector.multi===true){this.valueMap.set(item,this.issValue);}
        		}
    	else if(model.item.selectCheck && model.item.selectCheck===true){
    		 this.$.selector.deselect(item); 
    		 model.item.set("selectCheck",false);
    		 this.valueMap.delete(item);
    		 }
		this.async(this.closeDropdown, 20);
		this.set("dropdownOpen",false);
		}
  },

    onDownArrow(e){
      	var children=Polymer.dom(this.$.dropdownlist).children;
      	itemChildren=children.filter(function(val,index, array){
      			if(val.classList.contains("selectColor"))
      			{
      				val.classList.remove("selectColor");
      			} 
      				return (val.nodeName==="PAPER-ITEM");
      	});
      	this.$.dropdownlist.focus();
      	var size=itemChildren.length-1;
      	if(this.itemKeyStrokeIndex>=size){
      		this.set("itemKeyStrokeIndex",0);
      	}
      	else if(this.itemKeyStrokeIndex==-1){this.set("itemKeyStrokeIndex",0);}
      	else{this.set("itemKeyStrokeIndex", this.itemKeyStrokeIndex+1);}
 		var elem=itemChildren[this.itemKeyStrokeIndex];
 		elem.classList.add("selectColor");
 		var rectBttm=elem.getBoundingClientRect(),
 		scrolltop=this.$.dropdownlist.scrollTop,
 		delta=rectBttm.height+3;
 		this.$.dropdownlist.scrollTop=this.$.dropdownlist.scrollTop+delta;
 		this.set("topHolder", rectBttm);
    },
      onUpArrow(e){
      	var scroller=this.$.dropdownlist,
  		children=Polymer.dom(scroller).children;
      	itemChildren=children.filter(function(val,index, array){
      			if(val.classList.contains("selectColor"))
      			{val.classList.remove("selectColor");} 
      				return (val.nodeName==="PAPER-ITEM");
      	});
      	var size=itemChildren.length-1;
      	console.log(size);
      	if(this.itemKeyStrokeIndex==0){this.set("itemKeyStrokeIndex", size);}
      	else{this.set("itemKeyStrokeIndex", this.itemKeyStrokeIndex-1);}
      	var elem=itemChildren[this.itemKeyStrokeIndex];
      	elem.classList.add("selectColor");
      	var rect=elem.getBoundingClientRect(),
      	ht=window.getComputedStyle(elem,null).getPropertyValue("height"), 
      	height=rect.height;
 		this.$.dropdownlist.scrollTop=this.$.dropdownlist.scrollTop-(Math.floor((height+ht)/2)+2);
      },
      onEnter(e){
      	 var children=Polymer.dom(this.$.dropdownlist).children;
      	itemChildren=children.filter(function(val,index, array){
      		if(val.classList.contains("selectColor"))
      			{val.classList.remove("selectColor");}
      			return (val.nodeName==="PAPER-ITEM");
      	});
      		if(this.itemSelectProperty=="__"){this.set("issValue",itemChildren[this.itemKeyStrokeIndex]._templateInstance.item);}
        	else if(this.itemSelectProperty!=="__")
          {
     		   var value=itemChildren[this.itemKeyStrokeIndex]._templateInstance.item[this.itemSelectProperty];
     		   this.set("issValue", value);
     	    }
     		   this.closeDropdown();
        },

  
});
</script>
</dom-module>
