<dom-module id="fc-clock">
<style is="custom-style">
:host{
	position: absolute; 
	top: 8px;
	background: #fff;
	left: 8px;
	min-width: 245px; 
	z-index:93;
};
paper-material{
	opacity: 1;
	position: relative;
	background: #ffffff;
	border: 3px ridge #aecdfe;
	padding: 8px 4px;
	display: block;
	@apply(--horizontal-layout);
	@apply(--nowrap-layout);
}
.timer{
	font-size: 17px; 
	opacity: 1; 
	font-weight: 600; 
	font-family: merriweather; 
	color: #007; 
	padding: 6px 4px 2px 4px; 
	border: .4px solid #efefef;
}
.slight{
	font-size: 14px; 
	font-family: merriweather; 
	opacity: 1; 
	color: #008; 
	font-weight: 400;
}
.startbutton{
	margin: 1px; 
	border: 2px solid #efefef;  
	box-shadow: 3px 7px 17px 2px #dedede; 
	font-size: 14px; 
	font-weight: 600; 
	text-align: center; 
	padding: 2px; 
	margin-bottom: 5px; 
	width: 100%;
}
.startbutton:hover{ 
	box-shadow: 1px 3px 4px 1px; 
	font-weight: 700;
}
fc-input-prime{
	max-width: 102%;

}
.clockname{
	font-size:18px;
	color: #008; 
	font-family: times;
}
.clockname::after{
	font-size: 10px;
	color: white;
	display: block;
	content: " .";
}
.clockname:hover::after{
	font-size: 10px; 
	color: brown;
	display: block;
	content: " Tap to Change Clock Type";

}
</style>

<template>
<div style="padding: 2px; border: 1px #efefef solid; width: 240px; outline: 3px solid #efefef">
<div style="padding: 2px; border: 2px #008 double; text-align: center;" class="layout vertical" on-track="_focusedDraggable" drags>
			<div style="padding: 2px; border: 1px #008 solid; text-align: center; overflow-x: hidden; background: white;" class="layout vertical">
			<template is="dom-repeat" items="{{soundingAlarms}}" as="alarm">
					<paper-item two-line style="border: silver 1px solid; font-size: 12px;" on-tap="alarmoff">
							<paper-item-body>
								<div class="primary">
										[[alarm.alarmName]] [[alarm.alarmTime]]
								</div>
							</paper-item-body>
					</paper-item>
				</template>
					<div class="layout horizontal flex center-justified">
					

				<paper-material style$="width: 165px; margin: 24px 20px {{toggleMargin}} 20px;" class="layout vertical" elevation="3">
					<span draggable drags on-tap="toggle" class="slight">{{date}}</span>
					<section id="theClock" cursor:pointer; on-dblclick="opencollapser" class="timer">{{theTime}} </section>	
				</paper-material>
				</div>
  <iron-collapse id="collapser"  class="vertical layout center-justified glass"> 
 <div class="layout horizontal flex center-justified nowrap">
	<iron-selector selected="{{selected}}" class="vertical layout center-justified nowrap" items="{{clockArray}}" as="clock">
	<section style="font-weight: 600; font-size: 16px;" class="horizontal layout flex nowrap center-justified"
	>
	<section class="layout horizontal flex-2">
<iron-icon style="width: 32px; height: 32px;z-index: 22; color: silver; opacity: .85" on-tap="selectPrevious" icon="icons:chevron-left">
			</iron-icon>
			</section>
<section class="layout horizontal flex-10  center-justified" style="cursor:pointer;">
<span class="clockname"><span on-tap="selectApi">{{currentClock.clockType}}</span>{{computeTheSes(currentClock.clockType)}}</span>
</section>

<section class="layout horizontal flex-2">
<iron-icon icon="icons:chevron-right" 
on-tap="selectNext" 
style="width: 32px; height: 32px;z-index: 22; color: silver; opacity: .85">
</iron-icon>
</section>
		
	</section>
	<div class="horizontal layout flex center-justified nowrap" style="width: 235px;">
	<section on-tap="selectPrevious" style="">
			
	</section>
	
				<section  class="vertical layout around-justified nowrap" style="max-width: 220px!important; padding-right: 0px;">
						<section hidden$="{{clockPrimarySwitch}}"class="horizontal flex layout nowrap self-shrink">
							<section class="horizontal layout nowrap" style="overflow-x: scroll;">
								<fc-clobjid-prime 
									id="dsv"
									input-style="text-align: left; margin-left: 1px; margin-left: -3px; padding: 0px 1px; border: 1px silver solid; font-weight: 600;min-width: 6px;max-width: 13px;{{computeFontSize(currentClock.clockData)}};" 
									orientation="horizontal" 
									dataobject="{{currentClock.clockData}}"
									>
								</fc-clobjid-prime>
							</section>
						</section>
						<div style="min-height: 50px" hidden$="{{!clockPrimarySwitch}}">
 							<template is="dom-repeat" items="{{alarmArray}}">
 								<div style="color:{{computeAlarmColor(item.isActive)}}">{{_computeAlarms(item.alarmName, item.alarmTime, currentClock)}}</div>
 							</template>
 							<iron-collapse id="collapse" class="vertical layout flex">
 							<audio controls loop id="myAlarmNoise" style="border: green 2px solid; width: 220px; height: 35px;">
  									<source src="fc-clock/beep-06.mp3" type="audio/mp3">
  										<source src="fc-clock/beep-10.mp3" type="audio/mp3">
											Your browser does not support the audio element.
							</audio>
								<form>
									<fc-input-prime 
										input-type="datetime-local" value="{{alarmTime}}" 
										label="Set Alarm Date & Time"
										style="text-align: left; text-indent: 9px; font-weight: 500; font-size: 10px;" 
										input-style="text-align: left; font-size: 14px;" 
										is-current-time="true">
									</fc-input-prime>
									<fc-input-prime 
										style="text-align: left;"
										input-type"text" 
										label="Alarm Name" 
										value="{{alarmName}}">
									</fc-input-prime>
									<section class="horizontal layout flex">
									<fc-input-prime
										style="text-align: left;" 
										input-type="checkbox" 
										label="Add Sound" 
										value="addSound">
									</fc-input-prime>
									<fc-input-prime
										style="text-align: left;"
										input-type="checkbox" 
										label="Add Alert" 
										value="addAlert">
									</fc-input-prime>
									</section>
								</form>
							</iron-collapse>
 						</div>
						<paper-button 
							class="horizontal flex layout nowrap self-stretch center-justified startbutton" 
							style$="color:{{onOffColor}};"
							on-tap="toggleRunning">
									[[currentClock.clockName]]
						</paper-button>
				</section>
			
		</div>
				
			</iron-selector>
		
</div>
		<section class="horizontal flex layout nowrap center
					 center-justified" style="width: 100%; font-size: 13px; font-weight:600; font-family: merriweather; color: #007; margin-left: 0px;">
					<paper-button style="text-align: center; border: 2px solid #efefef;" on-tap="addNewAlarm" class="horizontal layout flex center-justified">Add</paper-button>
						<paper-button class="horizontal layout flex center-justified" style="text-align: center;border: 2px solid #efefef;" on-tap="resetCurrentClock">[[_computeResetButton(currentClock.isRunning)]]</paper-button>

					<paper-button class="horizontal layout flex center-justified" style="text-align: center; border: 2px solid #efefef;" on-tap="alarmoff">off</paper-button>
		</section>
	</iron-collapse>

	</div>


</div>
</div>
</template>
<script>



function FcClockData(argTenths, argFirstDigit, argLastDigit)
{	
	var firstDigit = argFirstDigit || 0;
	var lastDigit = argLastDigit || 7;
	var digitArray = [
		{name: "thours", value: 0, inputType: "digit", label:" "+" H"},
		{name: "hours", value: 0, inputType: "digit", label:"H", colon:":"},
		{name: "tmin", value: 0, inputType: "digit", label:"M"},
		{name: "min",value: 0, inputType: "digit", label:"M", colon:":"},
		{name: "tsec",value:0, inputType: "digit", label:"S"},
		{name: "sec",value: 0, inputType: "digit", label:"S", colon:":"},
		{name: "tenth", value: 0, inputType: "digit", label:"s"},
		{name: "hundredth", value: 0, inputType: "digit", label:"s"}
	];
	for(var i = 0; i < 8; i++)
	{
		var obj = digitArray[i];
		this[obj.name] = obj;
		if(i < firstDigit || i > lastDigit)
		{
			this[obj.name].hidden = true;
		}
	}

	
	this.convertFromTenths(argTenths);
	
}

FcClockData.prototype.convertToTenths = function()
{
	var result = 0;
	result += this.hundredth.value;
	result += this.tenth.value * 1;
	result += this.sec.value * 10;
	result += this.tsec.value * 100;
	result += this.min.value * 600;
	result += this.tmin.value * 6000;
	result += this.hours.value * 36000;
	result += this.thours.value * 360000;
	return result;
};


FcClockData.prototype.convertFromTenths = function(argTenths)
{	
	
	this.tenth.value = argTenths % 10;
	var fullsec = Math.floor(argTenths / 10) % 60;
	this.sec.value = fullsec % 10;
	this.tsec.value = Math.floor(fullsec / 10);
	var fullmin;
	if(argTenths>35999 && argTenths<60000)
	{
		fullmin = Math.floor(argTenths / 600) % 100;
	}
	else
	{
		fullmin = Math.floor(argTenths / 600) % 60;
	}
	this.min.value = fullmin % 10;
	var fullhour = Math.floor(argTenths / 36000);
	this.hours.value = fullhour % 10;
	this.tmin.value = Math.floor(fullmin / 10);
	if(argTenths>35999 && argTenths<60000)
	{
		this.hours.value = 0;
	}
	else
	{
		//this.tmin.value = fullmin % 60;
	}

};

FcClockData.prototype.soundAlarm = function(argAlertTarget, argTime)
{
	
	var numDate=argTime.getTime() +30000;
	var self=this;
	while(this.now<numDate)
	{
	var handle =setTimeOut(function(argAlertTarget) {
	self.$$(argAlertTarget).style.background=(self.$$(argAlertTarget).style.background=="red")?"black":"red";
	self.$$(argAlertTarget).style.color=(self.$$(argAlertTarget).style.color=="black")?"red":"black";
	}, 2000);
	handle=(handle!==null)?null:setTimeOut(function(argAlertTarget) {
	self.$$(argAlertTarget).style.background=(self.$$(argAlertTarget).style.background=="red")?"black":"red";
	self.$$(argAlertTarget).style.color=(self.$$(argAlertTarget).style.color=="black")?"red":"black";},
		2000);
	handle=null;
	}
	argAlertTarget.style.background="white";
	argAlertTarget.style.background="#008";
}; 

class FcClock
{
	constructor(argName, argType, argTenths, argFirstDigit, argLastDigit)
	{
		this.clockName = argName;
		this.clockType = argType;
		this.startTenths = argTenths;
		this.isRunning = false;
		this.firstDigit = argFirstDigit;
		this.lastDigit = argLastDigit;
		this.clockData = new FcClockData(argTenths, argFirstDigit, argLastDigit);
	}
	convertFromTenths(argTenths)
	{
		this.clockData.convertFromTenths(argTenths);
	}
	convertToTenths()
	{
		return this.clockData.convertToTenths();
	}
	toggleRunning()
	{
		var d = (new Date()).getTime();
		if(this.isRunning)
		{
			this.lastTurnedOff = d;
			this.lastTurnedOffTenths = this.clockData.convertToTenths();
		}
		else
		{
			this.lastTurnedOn = d;
			this.lastTurnedOnTenths = this.clockData.convertToTenths();
		}
		this.isRunning = !this.isRunning;
	}
}

Polymer({
	is: "fc-clock",
	listeners:{"on-tap": "addNewAlarm"},
	properties: {
		currentClock: {
			type: FcClock,
			value: {},
			notify: true,
		},
		clockType: {
			type: String, 
			notify: true,
		},
		openingArray:{
			type: Array,
			value:[],
			notify: true,
		},
		alarmArray: {
			type: Array,
			value: [],
			notify: true
		},
		fcClockArray: {
			type: Array,
			value: [],
			notify: true
		},
		displayedArray:{
			type: Array,
			computed: "_computeDisplayedArray(fcClockArray, clockApi, openingArray)",
			observer: "watchDisplayed",
			notify: true
		},
		clockApi:{
			type: String,
			value: function(){return "Countdown";},
			notify: true,
		},
		apiChoices:{
			type:Array,
			value:function(){
				return ["Countdown",
						"Stopwatch",
						"Alarmclock",
						"Alltimers"
							];
			},
			notify: true

		},
		clockPrimarySwitch:{
			type: Boolean, 
			value: false,
			notify: true
		},
		 swapIcon: {
		 	type: String,
		 	value: function(){return "query-builder";},
		 	notify: true
		 },
		 onOffColor: {
		 	type: String,
		 	value: "green",
		 	notify: true
		 },
		
		drags:{
			type: Boolean,
			value: true,
			notify: true
		},
		dragCounter:{
			type: Number,
			value: 0,
			notify: true
		},
		alarmTime:{
				type: String,
				notify: true,
		},
		theTime:{
			type: String,
			value:function(){
				var newtime = new Date();
				var update = newtime.toLocaleTimeString();
				return update;
			},
			notify: true
		}, 
		
		clockIndex: {
			type: Number, 
			value: 0,
			notify: true
		},
		toggleMargin:{
			type: String, 
			value: "32px",
			notify: true
		},
		soundingAlarms:{
			type: Array,
			value:[],
			notify: true
		},
		date:{
			type: Date,
			value:function(){
				var d=new Date();
				return d.toDateString();
			},
			notify: true
		},
		alarmName:{
			type: String,
			notify: true,
		},
		theCountdown:{
			type: Number,
			value: 0,
			notify: true
			}, 
		
      	now:{
      		type: Date, 
      		notify: true
      	}
    
	},
	behaviors:[],

	
	clockwatcher: function(newVal, oldVal)
	{
		console.log(newVal, oldVal);
	},

	ready: function()
	{
		this.setClockConstructor();
	},
	attached: function()
	{	
		
		this.initializeClocks();
	},

	resetCurrentClock: function(e){
		if(this.currentClock.isRunning===true)
		{
				this.set("currentClock.isRunning", false);
				this.set("onOffColor", "green");
		}
		else{
		this.set("currentClock.clockData", new FcClockData(this.currentClock.startTenths, this.currentClock.firstDigit, this.currentClock.lastDigit));
		this.set("displayedArray." + this.currentIndex, this.currentClock);
		}
	},
	_computeResetButton: function(running){
		var retVal=(running===true)?"STOP":"RESET";
		return retVal;
	},
	_computeAlarms: function(name, time){
		console.log(name, this.currentClock, this.currentClock.clockName);
			if(name==this.currentClock.clockName){
			var retVal= time.toLocaleString();
			return retVal;
		}
	},
	_computeDisplayedArray: function(fcClockArray, api, openingArray){
		if(fcClockArray!==[] && this.openingArray!==[])
			{
				if(api!=="Alarmclock" && api!="Alltimers")
				{
					var retVal = fcClockArray.filter(function(val, index, arr){
						return (val.clockType==api);
						});
					console.log(retVal, api);
		
					return retVal;
				}
				else if(api=="Alarmclock" && this.alarmArray)
				{    console.log(api, this.alarmArray);
					return this.alarmArray;
				}
				else{return openingArray;}
			}
	}, 

	
	computeFontSize: function(ccd){
		console.log(ccd, ccd,ccd,ccd);
	}, 
	selectApi: function(e){
		console.log(e, e.target, e);
		var compareVal=e.target.firstChild.data;
		var retVal= "";
		this.apiChoices.forEach(function(val, index, array){
			if(array[index-1]==compareVal){retVal=val;}
			else if(index==array.length-1 && compareVal==val){retVal=array[0];
					}				
			else if(compareVal=="Stopwatch"){this.set("clockPrimarySwitch",true); retVal="Alarmclock";}
			else if (compareVal=="Alarmclock"){this.set("clockPrimarySwitch",false); retVal=array[0];} 
		}, this);
		console.log(retVal, "look here for value");
		this.set("clockApi",retVal);

	},
	toggleRunning: function(event)
	{	
		var bool= !this.currentClock.isRunning;
		this.currentClock.toggleRunning();
		var setVal = this.onOffIcon=="icons:forward"?"icons:close":"icons:forward";
		this.set("onOffIcon", setVal);
		this.set("onOffColor", this.onOffColor=="green"?"red":"green");
		this.set("currentClock.isRunning",bool);
	},
	
computeTheSes: function(clockType){
	if(clockType=="Stopwatch"){return "es";}
	else return "s";
},
	computeAlarmColor: function(argActive)
	{
		return argActive?"green":"red";
	},


opencollapser: function()
{
this.$.collapser.opened=!this.$.collapser.opened;
var tm =(this.toggleMargin=="32px")?"12px": "32px";
this.set("toggleMargin",tm);

},

    dragYes: function()
    {
    	this.drags=true;
    },
  

	toggle: function(e)
	{	
		this.$.collapse.opened=!this.$.collapse.opened;
		//this.$.collapsey.opened=!this.$.collapsey.opened;
		
	},

	
	selectPrevious: function(e){
		var num =(this.clockIndex>0)?(this.clockIndex-1):0;
			this.switchClock(num);
	},
	selectNext: function(){
		var last=this.displayedArray.length-1;
		var num =(this.clockIndex<last)?(this.clockIndex+1):last;
			this.switchClock(num);			
	},
	watchDisplayed: function(newVal, oldVal){
		console.log(oldVal, newVal);
		if(newVal.length){this.switchClock(0);}
	},
	switchClock: function(num){	if(this.displayedArray && this.clockApi!="Alarmclock"){
		this.set("clockIndex", num);
		this.set("currentClock", this.displayedArray[num]);
		this.set("onOffIcon", this.currentClock.isRunning?"icons:close":"icons:forward");
		this.set("onOffColor", this.currentClock.isRunning?"red":"green");
		}
		else if(this.displayedArray && this.clockApi=="Alarmclock"){   
			if(!num){num=0;}
			this.set("clockIndex", num);
			this.set("currentClock", this.alarmArray[num]);
			this.set("onOffIcon", this.currentClock.isRunning?"icons:close":"icons:forward");
			this.set("onOffColor", this.currentClock.isRunning?"red":"green");
		}
		// else{this.set("clockApi", this.clockApi);}
	},
	_focusedDraggable:function(e)
	{
	  	if(this.drags==true){
	        var self=this;
	        e.preventDefault();
			switch(e.detail.state)
			{
	          case 'start':
	            // console.log('START NoWayAreWe Draggin');
	            self._leftprime = parseInt(window.getComputedStyle(self, null).getPropertyValue("left"))-e.detail.x;
	            self._topprime = parseInt(window.getComputedStyle(self, null).getPropertyValue("top"))-e.detail.y;
	            console.log('top distance differenced?' + self._topprime);
	            // }
	            self.changeX=0;
	            self.changeY=0;
	            Polymer.dom.flush();
	            break;
	          case 'track':
	            self.changeX=e.detail.ddx + self.changeX;
	            self.changeY=e.detail.ddy + self.changeY;
	            self.translate3d(self.changeX.toString() + 'px', self.changeY.toString() + 'px', 0);
	            break;
	          case 'end':
	            console.log(self._topprime);
	            self._right = parseInt(window.getComputedStyle(self, null).getPropertyValue("right"))
	            self._bottom = self.getBoundingClientRect().top;
	            self._x= ((self._leftprime + e.detail.x)>=0)?(self._leftprime + e.detail.x): 0;
	            self._y=((self._topprime + e.detail.y)>=0)?Math.ceil(self._topprime + e.detail.y):0;
	            self.translate3d(0, 0, 0);

	            console.log("ENDING", self._x);
	            self.style.left=self._x.toString()+'px';
	            self.style.top=self._y.toString()+'px';
	            console.log('y: ' + e.detail.y);
	            self.dragging=false;
	            Polymer.dom.flush();
	            break;
	        }
	    }
	},
	setClockConstructor:function(){
		var nowish = (new Date()).getTime()+50000;
		var laterish = (new Date()).getTime()+ 90000;
		this.alarmArray = [];
		this.addAlarm(nowish, "nowish");
		this.addAlarm(laterish, "laterish");
		this.fcClockArray = [];
	  	this.push("fcClockArray", new FcClock("Reading Countdown", "Countdown", 39000, 0, 7));
	 	this.push("fcClockArray", new FcClock("Writing Countdown", "Countdown", 21000, 0, 7));
	 	this.push("fcClockArray", new FcClock("Math Countdown 1", "Countdown", 15000, 0, 7));
	 	this.push("fcClockArray", new FcClock("Math Countdown 2", "Countdown", 33000, 0, 7));
	 	this.push("fcClockArray", new FcClock("Essay Countdown", "Countdown", 30000, 0, 7));
	 	this.push("fcClockArray", new FcClock("Countdown 1", "Countdown", 0, 0, 7));
	 	this.push("fcClockArray", new FcClock("Countdown 2", "Countdown", 0, 0, 7));
        this.push("fcClockArray", new FcClock("Stopwatch 1", "Stopwatch", 0, 0, 7));
        this.push("fcClockArray", new FcClock("Stopwatch 2", "Stopwatch", 0, 0, 7));
	  	this.set("currentClock", this.fcClockArray[0]);
	  	var temp=this.fcClockArray.filter(function(val,index){
	  		return(val.clockType=="Countdown");
	  	})
	  	this.set("openingArray", temp);
	},

	initializeClocks:function(){
		var self = this;
		setInterval(function(){
			var currentTime = new Date();
			var time = currentTime.toLocaleTimeString();
			self.set("theTime", time);
			var numClocks = self.fcClockArray.length;
			var numAlarms = self.alarmArray.length;
			for(var i = 0; i < numClocks; i++)
			{
				var clock = self.fcClockArray[i];
				if(clock.isRunning)
				{
					var stamp = currentTime.getTime();
					var tenths = clock.convertToTenths();
					var deltaTenths = Math.floor((stamp  - clock.lastTurnedOn)/100);
					var newTenths;
					if(clock.clockType == "Countdown")
					{
						newTenths = clock.lastTurnedOnTenths - deltaTenths;
						if(newTenths <= 0)
						{
							newTenths = 0;
							console.log("clock named " + clock.clockName + " ran out at " + currentTime);
							clock.isRunning = false;
						}
					}
					else if(clock.clockType == "Stopwatch")
					{
						newTenths = clock.lastTurnedOnTenths + deltaTenths;
						//tenths+=1;
					}
					if(self.currentClock.clockType!="Alarmclock")
					{
						clock.convertFromTenths(newTenths);
						var path = "currentClock.clockData.tenth.value";
						var pathlight = "fcClockArray." + i + ".clockData";
						self.notifyPath(path, self.currentClock.clockData.tenth.value);
					}

				}
			}
			for(i = 0; i < numAlarms; i++)
			{
				var alarm = self.alarmArray[i];
				var alarmTime = alarm.alarmTime;
				if(alarm.isActive && (currentTime.getTime() > alarmTime.getTime()) )
				{
					console.log("Alarm went off at " + currentTime, alarm);
					self.ringAlarm(alarm);
					alarm.isActive = false;
					self.notifyPath("alarmArray." + i + ".isActive", false);
				}
			}
		}, 100);


	},
	ringAlarm: function(alarm){
		this.$.myAlarmNoise.play();
		this.push("soundingAlarms", alarm);
	},
	alarmoff: function(){
		this.$.myAlarmNoise.pause();
		this.splice("soundingAlarms", 0,1);
	},
	addNewAlarm: function(e){
		console.log(this.alarmTime);
		var dtl = this.alarmTime.split("T");
		var dpart=dtl[0].split("-");
		var year = dpart[0];
		var month=parseInt(dpart[1])-1;
		var day=dpart[2];
		var timepart= dtl[1].split(":");
		var hours=timepart[0];
		var minutes=timepart[1];
		var atime = new Date(year, month, day, hours, minutes);
			this.addAlarm(atime, this.alarmName);
	}, 

	addAlarm: function(argTime, argName)
	{		console.log(argTime);
		var alarmTime = new Date(argTime);
		var now = new Date();
		var active = (now < alarmTime);
		this.push("alarmArray", {alarmName: argName, clockName: argName, clockType: "Alarmclock", isRunning: active, clockData: alarmTime, alarmTime: alarmTime, isActive:active});
		console.log(this.alarmArray);
	},

});
</script>
</dom-module>