<dom-module id="fc-clock">
<style is="custom-style">
:host{position: absolute; top: 8px;background: #fff;left: 8px;min-width: 245px; z-index:93;};

paper-material{opacity: 1;position: relative;background: #ffffff;border: 3px ridge #aecdfe;padding: 8px 4px;display: block;@apply(--horizontal-layout);@apply(--nowrap-layout);
}
.query-builder{opacity: 1;width: 24px;height: 24px;border-radius: 180px;padding: 2px;margin: 2px;border: #fff 1px solid;background: #aecdcd;color: gold;
	}

.timer{font-size: 17px; opacity: 1; font-weight: 600; font-family: merriweather; color: #007; padding: 6px 4px 2px 4px; border: .4px solid #efefef;}
.slight{font-size: 14px; font-family: merriweather; opacity: 1; color: #008; font-weight: 400;}
*{-ms-overflow-style: none;}
*{overflow: -moz-scrollbars-none;}
select::webkit-scrollbar { width: 0 !important; visibility: none; }
*{ -ms-overflow-style: none; }

</style>

<template>
<div style="padding: 2px; border: 1px #efefef solid; width: 260px; outline: 3px solid #efefef">
<div style="padding: 2px; border: 2px #008 double; text-align: center;" class="layout vertical" on-track="_focusedDraggable" drags>
<iron-collapse id="collapsey" class="horizontal layout flex">
			
<form>
Select a Clock or Timer Feature
<br>
<select id="mySelect" on-change="selectApi" size="12" style="font-family: merriweather; align: center-justified; font-size: 18px; line-height: 2; font-weight: 700; color: red; width: 240px; height: 44px; background: #fafafa; box-shadow: 10px 5px 5px #afafaf; z-index: 4; border: 2px dashed green; margin: 10px; padding: 10px; text-align: center; outline: none;">
  <option value="alarms">Set Alarms</option>
  <option value="newStopWatch">Begin New Stop Watch</option>
  <option value="newCountdown">Set New Countdown</option>
  <option value="preSetCountdown">Use A Preset Countdown </option>
</select>
</form>
<br>
		</iron-collapse>
			
			<div style="padding: 2px; border: 1px #008 solid; text-align: center;cursor:pointer; overflow-x: hidden; background: white;" class="layout vertical">
					<div class="layout horizontal flex center-justified">		
				<paper-material style$="width: 165px; margin: 24px 20px {{toggleMargin}} 20px;" class="layout vertical" elevation="3">
					<span draggable drags class="slight">{{date}}</span>
					<section id="theClock" on-dblclick="opencollapser" class="timer">{{theTime}} </section>	
				</paper-material>
				</div>

				<!-- <div>
				<u>ALARMS</u>
				<template is="dom-repeat" items="{{alarmArray}}">
					<div style="color:{{computeAlarmColor(item.isActive)}}">{{_computeAlarms(item.alarmName, item.alarmTime)}}</div>
				</template>
				</div> -->
  <iron-collapse id="collapser"  class="vertical layout center-justified glass"> 
 
 <div class="layout horizontal flex center-justified nowrap">
	<iron-selector selected="{{selected}}" class="vertical layout center-justified nowrap" items="{{clockArray}}" as="clock">
	<span style="font-weight: 600; font-size: 16px;">
<iron-icon style="width: 32px; height: 32px;z-index: 22;" on-tap="selectPrevious" icon="icons:chevron-left">
			</iron-icon>
<iron-icon 
icon="icons:dashboard" 
class$="{{swapIcon}}" 
on-tap="toggle">
			</iron-icon>

	{{currentClock.clockType}}

<iron-icon 
icon="icons:{{swapIcon}}" 
class$="{{swapIcon}}" 
on-tap="toggle">
			</iron-icon>

<iron-icon icon="icons:chevron-right" 
on-tap="selectNext" 
style="width: 32px; height: 32px;z-index: 22;">
</iron-icon>
		
	</span>
	<div class="horizontal layout flex center-justified nowrap" style="width: 260px;">
	<section on-tap="selectPrevious" style="">
			
	</section>
	
				<section  class="vertical layout around-justified nowrap" style="max-width: 220px!important; padding-right: 0px;">
						<section class="horizontal flex layout nowrap self-shrink">
							<section class="horizontal layout nowrap" style="overflow: hidden;">
								<fc-clobjid-prime 
									id="dsv"
									input-style="text-align: left;font-size: 15px; font-weight: 600;min-width: 30px;max-width: 32px;" 
									orientation="horizontal" 
									dataobject="{{currentClock.clockData}}">
								</fc-clobjid-prime>
						</section>
						</section>
						<section 
							class="horizontal flex layout nowrap self-stretch center-justified" 
							style$="padding: 1px; margin: 1px; color:{{onOffColor}};  font-size: 16px; font-weight: 600; text-align: center; padding: 3px 0px 4px 0px;"
							on-tap="toggleRunning">
									[[currentClock.clockName]]
						</section>
				</section>
			
		</div>
				
			</iron-selector>
		
</div>
		<section class="horizontal flex layout nowrap center
					 center-justified" style="width: 100%; font-size: 13px; font-weight:600; font-family: merriweather; color: #007; margin-left: 0px;">
					<paper-button style="text-align: center; border: 2px solid #efefef;" class="horizontal layout flex center-justified">CLEAR</paper-button>
						<paper-button class="horizontal layout flex center-justified" style="text-align: center;border: 2px solid #efefef;">RESET</paper-button>

					<paper-button class="horizontal layout flex center-justified" style="text-align: center; border: 2px solid #efefef;">SAVE</paper-button>
					</section>
		</iron-collapse>

	</div>

	<iron-collapse id="collapse" class="horizontal layout flex">
			
<form>
Select a Clock or Timer Feature
<br>
<fc-input-prime input-type="datetime-local" value="{{alarmTime}}" input-style="text-align: right;" is-current-time="true"></fc-input-prime> <br>
<fc-input-prime input-type"text" value="{{alarmName}}"></fc-input-prime>
<iron-icon icon="icons:add" on-tap="addNewAlarm"></iron-icon>
</form>
<br>
		</iron-collapse>
</div>
</div>
</template>
<script>



function FcClockData(argTenths, argFirstDigit, argLastDigit)
{	
	var firstDigit = argFirstDigit || 0;
	var lastDigit = argLastDigit || 7;
	var digitArray = [
		{name: "thours", value: 0, inputType: "digit", label:" "+" H", colon:""},
		{name: "hours", value: 0, inputType: "digit", label:"H", colon:":"},
		{name: "tmin", value: 0, inputType: "digit", label:"M",colon:""},
		{name: "min",value: 0, inputType: "digit", label:"M", colon:":"},
		{name: "tsec",value:0, inputType: "digit", label:"S", colon:""},
		{name: "sec",value: 0, inputType: "digit", label:"S", colon:":"},
		{name: "tenth", value: 0, inputType: "digit", label:"s", colon:""},
		{name: "hundredth", value: 0, inputType: "digit", label:"s", colon:""}
	];
	for(var i = 0; i < 8; i++)
	{
		var obj = digitArray[i];
		this[obj.name] = obj;
		if(i < firstDigit || i > lastDigit)
		{
			this[obj.name].hidden = true;
		}
	}

	
	this.convertFromTenths(argTenths);
	
}

FcClockData.prototype.convertToTenths = function()
{
	var result = 0;
	result += this.hundredth.value;
	result += this.tenth.value * 1;
	result += this.sec.value * 10;
	result += this.tsec.value * 100;
	result += this.min.value * 600;
	result += this.tmin.value * 6000;
	result += this.hours.value * 36000;
	result += this.thours.value * 360000;
	return result;
};


FcClockData.prototype.convertFromTenths = function(argTenths)
{	
	
	this.tenth.value = argTenths % 10;
	var fullsec = Math.floor(argTenths / 10) % 60;
	this.sec.value = fullsec % 10;
	this.tsec.value = Math.floor(fullsec / 10);
	var fullmin;
	if(argTenths>35999 && argTenths<60000)
	{
		fullmin = Math.floor(argTenths / 600) % 100;
	}
	else
	{
		fullmin = Math.floor(argTenths / 600) % 60;
	}
	this.min.value = fullmin % 10;
	var fullhour = Math.floor(argTenths / 36000);
	this.hours.value = fullhour % 10;
	this.tmin.value = Math.floor(fullmin / 10);
	if(argTenths>35999 && argTenths<60000)
	{
		this.hours.value = 0;
	}
	else
	{
		//this.tmin.value = fullmin % 60;
	}

};

FcClockData.prototype.soundAlarm = function(argAlertTarget, argTime)
{
	
	var numDate=argTime.getTime() +30000;
	var self=this;
	while(this.now<numDate)
	{
	var handle =setTimeOut(function(argAlertTarget) {
	self.$$(argAlertTarget).style.background=(self.$$(argAlertTarget).style.background=="red")?"black":"red";
	self.$$(argAlertTarget).style.color=(self.$$(argAlertTarget).style.color=="black")?"red":"black";
	}, 2000);
	handle=(handle!==null)?null:setTimeOut(function(argAlertTarget) {
	self.$$(argAlertTarget).style.background=(self.$$(argAlertTarget).style.background=="red")?"black":"red";
	self.$$(argAlertTarget).style.color=(self.$$(argAlertTarget).style.color=="black")?"red":"black";},
		2000);
	handle=null;
	}
	argAlertTarget.style.background="white";
	argAlertTarget.style.background="#008";
}; 

class FcClock
{
	constructor(argName, argType, argTenths, argFirstDigit, argLastDigit)
	{
		this.clockName = argName;
		this.clockType = argType;
		this.startTenths = argTenths;
		this.isRunning = false;
		this.firstDigit = argFirstDigit;
		this.lastDigit = argLastDigit;
		this.clockData = new FcClockData(argTenths, argFirstDigit, argLastDigit);
	}
	convertFromTenths(argTenths)
	{
		this.clockData.convertFromTenths(argTenths);
	}
	convertToTenths()
	{
		return this.clockData.convertToTenths();
	}
	toggleRunning()
	{
		var d = (new Date()).getTime();
		if(this.isRunning)
		{
			this.lastTurnedOff = d;
			this.lastTurnedOffTenths = this.clockData.convertToTenths();
		}
		else
		{
			this.lastTurnedOn = d;
			this.lastTurnedOnTenths = this.clockData.convertToTenths();
		}
		this.isRunning = !this.isRunning;
	}
}

Polymer({
	is: "fc-clock",
	listeners:{"on-tap": "addNewAlarm"},
	properties: {
		currentClock: {
			type: FcClock,
			value: {},
			notify: true,
		},
		clockType: {
			type: String, 
			notify: true,
		},
		alarmArray: {
			type: Array,
			value: [],
			notify: true
		},
		fcClockArray: {
			type: Array,
			value: [],
			notify: true
		},
		 swapIcon: {
		 	type: String,
		 	value: function(){return "query-builder";},
		 	notify: true
		 },
		 onOffIcon: {
		 	type: String,
		 	value: function(){return "icons:forward";},
		 	notify: true
		 },
		 onOffColor: {
		 	type: String,
		 	value: "green",
		 	notify: true
		 },
		
		drags:{
			type: Boolean,
			value: true,
			notify: true
		},
		dragCounter:{
			type: Number,
			value: 0,
			notify: true
		},
		alarmTime:{
				type: String,
				notify: true,
		},
		theTime:{
			type: String,
			value:function(){
				var newtime = new Date();
				var update = newtime.toLocaleTimeString();
				return update;
			},
			notify: true
		}, 
		
		clockIndex: {
			type: Number, 
			value: 0,
			notify: true
		},
		toggleMargin:{
			type: String, 
			value: "32px",
			notify: true
		},
		date:{
			type: Date,
			value:function(){
				var d=new Date();
				return d.toDateString();
			},
			notify: true
		},
		alarmName:{
			type: String,
			notify: true,
		},
		theCountdown:{
			type: Number,
			value: 0,
			notify: true
			}, 
		
      	now:{
      		type: Date, 
      		notify: true
      	}
    
	},
	behaviors:[],


	_computeAlarms: function(name, time){
			var retVal= name+" " +time.toLocaleString();
			return retVal;
	},
	clockwatcher: function(newVal, oldVal)
	{
		console.log(newVal, oldVal);
	},

	ready: function()
	{
		var nowish = (new Date()).getTime()+50000;
		var laterish = (new Date()).getTime()+ 90000;
		this.fcClockArray = [];
		this.alarmArray = [];
		this.addAlarm(nowish, "nowish");
		this.addAlarm(laterish, "laterish");
	  	this.push("fcClockArray", new FcClock("SAT Reading Countdown", "Countdown", 39000, 1, 6));
	 	this.push("fcClockArray", new FcClock("SAT Writing Countdown", "Countdown", 21000, 1, 6));
	 	this.push("fcClockArray", new FcClock("SAT Math Countdown 1", "Countdown", 15000, 1, 6));
	 	this.push("fcClockArray", new FcClock("SAT Math Countdown 2", "Countdown", 33000, 1, 6));
	 	this.push("fcClockArray", new FcClock("SAT Essay Countdown", "Countdown", 30000, 1, 6));
	 	this.push("fcClockArray", new FcClock("Countdown 1", "Countdown", 0, 1, 6));
	 	this.push("fcClockArray", new FcClock("Countdown 2", "Countdown", 0, 1, 6));
        this.push("fcClockArray", new FcClock("Stopwatch 1", "Stopwatch", 0, 1, 6));
        this.push("fcClockArray", new FcClock("Stopwatch 2", "Stopwatch", 0, 1, 6));
	  	this.set("currentClock", this.fcClockArray[0]);
	},


	attached: function()
	{		
		var self = this;
		setInterval(function(){
			var currentTime = new Date();
			var time = currentTime.toLocaleTimeString();
			self.set("theTime", time);
			var numClocks = self.fcClockArray.length;
			var numAlarms = self.alarmArray.length;
			for(var i = 0; i < numClocks; i++)
			{
				var clock = self.fcClockArray[i];
				if(clock.isRunning)
				{
					var stamp = currentTime.getTime();
					var tenths = clock.convertToTenths();
					var deltaTenths = Math.floor((stamp  - clock.lastTurnedOn)/100);
					var newTenths;
					if(clock.clockType == "Countdown")
					{
						newTenths = clock.lastTurnedOnTenths - deltaTenths;
						if(newTenths <= 0)
						{
							newTenths = 0;
							console.log("clock named " + clock.clockName + " ran out at " + currentTime);
							clock.isRunning = false;
						}
					}
					else if(clock.clockType == "Stopwatch")
					{
						newTenths = clock.lastTurnedOnTenths + deltaTenths;
						//tenths+=1;
					}

					clock.convertFromTenths(newTenths);
					//var cd = new FcClockData(tenths);
					var path = "currentClock.clockData.tenth.value";
					var pathlight = "fcClockArray." + i + ".clockData";
					//self.set(pathlight, cd);
					self.notifyPath(path, self.currentClock.clockData.tenth.value);

				}
			}
			for(i = 0; i < numAlarms; i++)
			{
				var alarm = self.alarmArray[i];
				//console.log(alarm, alarm.alarmTime, currentTime);
				var alarmTime = alarm.alarmTime;
				if(alarm.isActive && (currentTime.getTime() > alarmTime.getTime()) )
				{
					//alert("Alarm " + alarm.alarmName + " went off at " + currentTime);
					console.log("Alarm went off at " + currentTime);
					alarm.isActive = false;
					self.notifyPath("alarmArray." + i + ".isActive", false);
				}
			}
		}, 100);
	},


	selectApi: function(e){
		console.log(e, e.target, e);

	},
	toggleRunning: function(event)
	{
		this.currentClock.toggleRunning();
		var setVal = this.onOffIcon=="icons:forward"?"icons:close":"icons:forward";
		this.set("onOffIcon", setVal);
		this.set("onOffColor", this.onOffColor=="green"?"red":"green");
	},
	addNewAlarm: function(e){
		console.log(this.alarmTime, this.alarmName, e, new Date(this.alarmTime));

		
		var dtl = this.alarmTime.split("T");
		var dpart=dtl[0].split("-");
		var year = dpart[0];
		var month=dpart[1];
		var day=dpart[2];
		var timepart= dtl[1].split(":");
		var hours=timepart[0];
		var minutes=timepart[1];
		var atime = new Date(year, month, day, hours, minutes);
			this.addAlarm(atime, this.alarmName);


	}, 

	addAlarm: function(argTime, argName)
	{		console.log(argTime);
		var alarmTime = new Date(argTime);
		var now = new Date();
		var active = (now < alarmTime);
		this.push("alarmArray", {alarmName: argName, alarmTime: alarmTime, isActive:active});
		console.log(this.alarmArray);
	},

	computeAlarmColor: function(argActive)
	{
		return argActive?"green":"red";
	},


opencollapser: function()
{
this.$.collapser.opened=!this.$.collapser.opened;
var tm =(this.toggleMargin=="32px")?"12px": "32px";
this.set("toggleMargin",tm);

},

    dragYes: function()
    {
    	this.drags=true;
    },
  

	toggle: function(e)
	{	
		this.$.collapse.opened=!this.$.collapse.opened;
		this.$.collapsey.opened=!this.$.collapsey.opened;
		
	},

	
	selectPrevious: function(e){
		var num =(this.clockIndex>0)?(this.clockIndex-1):0;
			this.switchClock(num);
	},
	selectNext: function(){
		var last=this.fcClockArray.length-1;
		var num =(this.clockIndex<last)?(this.clockIndex+1):last;
			this.switchClock(num);			
	},

	switchClock: function(num)
	{
		this.set("clockIndex", num);
		this.set("currentClock", this.fcClockArray[num]);
		this.set("onOffIcon", this.currentClock.isRunning?"icons:close":"icons:forward");
		this.set("onOffColor", this.currentClock.isRunning?"red":"green");
	},
	_focusedDraggable:function(e)
	{
	  	if(this.drags==true){
	        var self=this;
	        e.preventDefault();
			switch(e.detail.state)
			{
	          case 'start':
	            // console.log('START NoWayAreWe Draggin');
	            self._leftprime = parseInt(window.getComputedStyle(self, null).getPropertyValue("left"))-e.detail.x;
	            self._topprime = parseInt(window.getComputedStyle(self, null).getPropertyValue("top"))-e.detail.y;
	            console.log('top distance differenced?' + self._topprime);
	            // }
	            self.changeX=0;
	            self.changeY=0;
	            Polymer.dom.flush();
	            break;
	          case 'track':
	            self.changeX=e.detail.ddx + self.changeX;
	            self.changeY=e.detail.ddy + self.changeY;
	            self.translate3d(self.changeX.toString() + 'px', self.changeY.toString() + 'px', 0);
	            break;
	          case 'end':
	            console.log(self._topprime);
	            self._right = parseInt(window.getComputedStyle(self, null).getPropertyValue("right"))
	            self._bottom = self.getBoundingClientRect().top;
	            self._x= ((self._leftprime + e.detail.x)>=0)?(self._leftprime + e.detail.x): 0;
	            self._y=((self._topprime + e.detail.y)>=0)?Math.ceil(self._topprime + e.detail.y):0;
	            self.translate3d(0, 0, 0);

	            console.log("ENDING", self._x);
	            self.style.left=self._x.toString()+'px';
	            self.style.top=self._y.toString()+'px';
	            console.log('y: ' + e.detail.y);
	            self.dragging=false;
	            Polymer.dom.flush();
	            break;
	        }
	    }
	}

});
</script>
</dom-module>