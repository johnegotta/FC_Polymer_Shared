<dom-module id="fc-passage-display-dashboard">
<template>
<style>
div.line-number {
	width: 28px;
	line-height: 1.0;
	font-size: 1.0em;
	font-family: merriweather;
	font-weight: 500;
	font-style: italic;
	padding: 6px 0px 6px 0px;
	margin: 6px 0px 6px 0px;
	
}
div.columnContainer{
	overflow-y: scroll;
}
div.passageContainer{ 
	height:calc(100vh-290px);
	margin: 1vh 1vw 1vh 0vh;
}
.highlighted {
	background: yellow;
}
div.blurb{
	line-height: 1.0;
	font-size: .9em;
	font-family: merriweather;
	font-weight: 500;
	font-style: italic;
}
#pringles {
	margin: 0px 4px 6px 4px;
	padding: 16px;
	width:calc(100%+64px);
	max-width:1280px;
	max-height:1080px;
	
}
div.text {
	max-width: 720px;
	line-height: 1.0;
	font-size: 1.0em;
	font-family: merriweather;
	font-weight: 500;
	padding: 6px;
	margin: 6px 0px 6px 0px;
	max-height: 1900px;
	min-height: 480px;
	display: flex;
	min-width: 280px !important;
	max-width: 680px !important;
	
	
}
br {text-indent: 18px;}
</style>
	<firebase-collection location="https://focused0ne.firebaseio.com/readingPassageOne/Passage_1_%40%3A_620" data='{{passageArrayOne}}'></firebase-collection>
		<!-- <fc-splitter-jc orientation="horizontal" style="height: 1900px; width: 100vw;">	
		-->	
<!--double-column line-number and passage vertical container--> 
			<div id="noJudge" class="layout vertical flex container left passageContainer" style="border: 2px ridge silver;">
	<!--blurb full width container-->
					<div class="layout horizontal blurb" style="margin: 12px 36px 0px 36px; max-height: 140px; border: 1px ridge red;">
					This passage is from Lydia Minatoya, The Strangeness of Beauty. Â©1999 by Lydia Minatoya. The setting is Japan in 1920. Chie and her daughter Naomi are members of the House of Fuji, a noble family.<span id="tester"> </span>
					</div>

	<!--passage-columns container-->
					<div id="pringles" class="layout horizontal flex container" style="border: 1px solid goldenrod;">
		<!--column-1-container line numbs and passage | Flex-1 keeps the columns even-->
						<div id="doritos" class="layout horizontal flex-1 container columnContainer" style="border: 1px solid #000066; padding-right: 12px;">
			<!--Line number container-->
					 		<div id="linenumbers" class="layout vertical line-number">
					 		<span id="lines">Lines</span>
					 			<template is="dom-repeat" items="{{firstColumnLineNumberArray}}">
     								<span hidden="{{!columnOneShowLines}}" id="col_one_line_{{index}}">{{item}}</span>
     							
    							</template>
					 		</div>
			<!--passage-1-column-1 container-->
					 		<div id="colUno" class="layout horizontal flex wrap text">
					 		<article>
					 	    	<template is="dom-repeat" items="{{firstColumnWordArray}}">
 									<template is="dom-if" if="{{item.paragraphBreak}}">
 										<br><span>&nbsp&nbsp&nbsp&nbsp</span>
 									</template>
 									<a id="one_{{item.order}}_{{item.word}}" hidden="{{!columnOneShow}}">{{item.word}}</a>
								</template>
							</article>
					 		</div>
					 	</div>
		<!-- end-of-column-1 line number and text container-->

		<!--column-2-container line numbs and passage | Flex-1 keeps the columns veen-->
					 	<div id="secondColumnContainer" hidden="false" class="layout horizontal flex-1 container" style="border: 1px solid brown; padding-left: 12px;">
			<!--Line number container-->
					 		<div id="linenumbersright" class="layout vertical line-number">
					 			<span id="lines">Lines</span>

					 		 	<template is="dom-repeat" items="{{secondColumnLineNumberArray}}">
     								<span id="col_two_line_{{index}}" hidden="{{!columnOneShowLines}}">{{item}}</span>
     								
    							</template>	
					 		</div>
			<!--end of passage-1-column-1 line number container-->
			<!--passage-1-column-2 container-->
					 		<div id="colDos" class="layout vertical text">
					 		<article>
					 		<br>
								<template is="dom-repeat" items="{{secondColumnWordArray}}">
 									<template is="dom-if" if="{{item.paragraphBreak}}">
 										<br><span>&nbsp&nbsp&nbsp&nbsp</span>
 									</template>
 									<a id="two_{{item.order}}_{{item.word}}" hidden="{{columnOneShow}}">{{item.word}}</a>
								</template>
							</article>
					 		</div>
		<!--passage-1-column-2 container-->
					 	</div>
	<!--end of flex passage column container-->
				</div>
<!--End of top container horizontal-->
			</div>
<!--End of Vertical passage container-->
		<!--
		</fc-splitter-jc>
		-->
		<content class="left horizontal layout container" select="fc-student-intake-form, fc-grid-card-portrait">		
		</content>	
	<fc-data-administrator id="scottAdmin"></fc-data-administrator>
	<paper-button on-tap="columnize">2 Columnize</paper-button>
</template>
<script>
/*FcTopViewDashboard=*/
Polymer({
	is: "fc-passage-display-dashboard", 
	behaviors: [Polymer.IronResizableBehavior],
	properties: {
		iPath: 'http://www.focusedstaging.com/Fresh_Attempt%20/index-jason.html',
		topClassHidden: {
			type: Boolean, 
			value: true, 
		/*	observe: however you do this Scott,*/
			reflectToAttributes: true,
			notify: true
			},
		shitty: String,
		bottomLeftClassHidden: {
			type: Boolean, 
			value: true, 
		/*	observe: however you do this Scott,*/
			reflectToAttributes: true,
			notify: true
			}, 
		bottomRightClassHidden: {
			type: Boolean, 
			value: true, 
		/*	observe: however you do this Scott,*/
			reflectToAttributes: true,
			notify: true
			},
		numColumns: {
			type: Number,
			value: 1
		},
		lowerRight: String,
		lowerLeft: String,
		/*
		passageWidth: {
			type: String, 
			value: function(){return this.$.noJudge.clientWidth;},
			notify: true, 
			reflectToAttributes: true
		},
		*/
		largestLineNumberArray: {
			type: Array,
			value: [],
			notify: true
		},
		firstColumnLineNumberArray: {
			type: Array,
			value: [],
			notify: true
		},
		secondColumnLineNumberArray: {
			type: Array,
			value: [],
			notify: true
		},
		passageArrayOne:{
			type: Array, 
			value: [],
			notify: true, 
			reflectToAttibutes: true
		}, 
		passageDimensions: {
			type: Object,
			value: {
				passageWidth: Number,
				passageHeight: Number,
				lineNumCellHeight: Number,
				numberOfLinesColOne: Number, 
				passageInnerHeight: Number, 
				passagePositionX: Number, 
				passagePositionY: Number, 
				passagePositionZ: Number
			},
			notify: true, 
			reflectToAttributes: true
		},
		passageObject: {
			type: Object,
			value:{}, 
			notify: true,
			reflectToAttributes: true
		},
		passageTitle: {
			type: String, 
			notify: true,
			reflectToAttributes: true
		},
		contentEdit: {
			type: Boolean,
			value: false, 
			notify: true,
			reflectToAttributes: true
		},
		firstColumnWordArray: {
			type: Array,
			value: [],
			notify: true,
			reflectToAttributes: true
		},
		secondColumnWordArray: {
			type: Array,
			value: [],
			notify: true,
			reflectToAttributes: true
		},
		flitty: {
			type: Array,
			value: [],
			notify: true,
			reflectToAttributes: true
		},
		pending: {
			type: Boolean,
			value: false
		},
		notify: true,
		reflectToAttributes: true
	},
	created: function(){
	},
	ready: function(){
		
	},
	attached: function(){
		//var passageTitle = self.passageTitle = "stanleySucks";
		//this.passageDimensions.passageWidth = document.querySelector('#stanleySucks').clientWidth;
		var lines = document.querySelector('#lines');
		console.log(lines);
		for(i=1; i <= 400; i++)
		{
			this.push("largestLineNumberArray", i % 5 ? ".": i.toString());
		}
	},
	attributeChanged: function(){
		var nooSpans = document.querySelector('[name|=false]');
		this.passageDimensions.passageWidth = document.querySelector('#pringles').clientWidth;
		
	},
	columnize: function()
	{
		console.log("columnize");
		this.splitIntoColumns(2);
	},
	destroyed: function(){
		
	},
	timer: function(){
	},
	_outputpassageObject: function() {
		console.log( " " + JSON.stringify(this.passageObject) + "\n" + "\n");
	},
	highlightWord: function(e)
	{
		var highlighted = (e.target.className.indexOf("highlighted") > -1);
		var classString = e.target.className;
		if(!highlighted)
		{
			classString += " highlighted";
			e.target.setAttribute("class", classString);
		}
		else
		{
			classString = classString.replace(" highlighted", "");
			e.target.className = classString;
		}
	},
	notifyResize: function()
	{
		this.splitIntoColumns(2);
	},
	
	splitIntoColumns: function(argNumColumns){
        var screenTrueHeight = (window.innerHeight - 180);
        console.log(screenTrueHeight);
        var lines = document.querySelector('#lines');
        var linesH=lines.clientHeight;
		console.log(linesH);
        console.log(screenTrueHeight);
 		var colOneLines; 
 		if(linesH !== 0 && screenTrueHeight>900)
 		{
 			this.$.pringles.style.height = screenTrueHeight;
        }
        else
        {
        	screenTrueHeight=1080;
        	this.$.pringles.style.height = 1080;
        	this.$.colUno.style.maxHeight = 1080;
        	this.$.colUno.style.height = 1080;
        	this.$.pringles.style.maxHeight = 1080;
        }
        var maxLinesColOne = Math.floor(screenTrueHeight / linesH);
        //maxLinesColOne = 107;
        console.log(maxLinesColOne);
        var fcNumColumns;
		//var oneColumn = document.querySelector('#noJudge').clientWidth;
		var pWidth = document.querySelector('#pringles').clientWidth;
       	if(pWidth > 0 && pWidth < 680)
        {
        	fcNumColumns=1;
        	document.querySelector("#secondColumnContainer").hidden=true;
        	//colOneLines = numLines;
        }
        else {
        	fcNumColumns=2;
        	document.querySelector("#secondColumnContainer").hidden=false;

			//colOneLines = Math.floor(numLines / 2) + 1; //Math.floor(screenTrueHeight/linesH);
    	}
    	console.log(fcNumColumns);
        //colOneLines = Math.floor(screenTrueHeight/linesH);
		var i = 0;
		var canvas = document.createElement('canvas');
		var context = canvas.getContext("2d");
		var calcFontSize = window.getComputedStyle(this.$.pringles, null).getPropertyValue('font-size');
		var fontSizeInt = parseInt(calcFontSize.replace('px','')); 
		console.log(calcFontSize);
		fontSizeInt*=.75;
		calcFontSize = fontSizeInt.toString() + 'pt';
		console.log(calcFontSize);
		var calcFontFam = window.getComputedStyle(this.$.pringles, null).getPropertyValue('font-family');
		var fontComma = calcFontFam.indexOf(",");
		if(fontComma > -1)
		{
			calcFontFam = calcFontFam.slice(0, fontComma)
		}
		var ref = new Firebase("https://focused0ne.firebaseio.com/readingPassageOne/Passage_1_%40%3A_620"); //https://focused0ne.firebaseio.com/readingPassageOne");
		console.log(calcFontSize + " " + calcFontFam);;
		context.font = calcFontSize + " " + calcFontFam; //"13.2pt merriweather";
		var self = this;
		var containerWidth;
		/*
		if(this.pending == true)
		{
			return;
		}
		this.pending = true;
		*/
		ref.on("value", function(snap){
			var words = snap.val();
			console.log(words);
			var numWords = words.length;
			//console.log(self.secondColumnWordArray);
		var line = "";
		var numLines = 0;
		//containerWidth = document.querySelector('#colUno').clientWidth - 11.0;
		containerWidth = parseFloat(window.getComputedStyle(document.querySelector("#colUno"), null).getPropertyValue('width'));
		//containerWidth = (pWidth / numColumns) - 40;
		console.log("containerWidth = " + containerWidth);
		console.log(numWords);
		var colOneWordIndex = numWords;
		for(i=0; i < numWords; i++)
		{
			//console.log(words[i]);
			var word = words[i].word;
			if(words[i].paragraphBreak == true) //paragraph begin
			{
				//console.log("a paragraph break");
				line = "all";
				numLines++;
			}
			else if(word == "" || word == " ")
			{
			}
			else
			{
				line = line + " " + word;
				currentWidth = context.measureText(line).width;
				if (numLines == maxLinesColOne && fcNumColumns == 2)
				{
					//reached end of first column
					var dos = document.querySelector('#colDos');
					var space = document.createElement("span");
					space.innerHTML = "a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a";
					dos.appendChild(space);
					containerWidth = parseFloat(window.getComputedStyle(dos, null).getPropertyValue('width'));
					console.log("containerWidth = " + containerWidth);
					dos.removeChild(space);
				}
				if(currentWidth > containerWidth)
				{
					//console.log("*" + word + "* " + currentWidth);
					line = word;
					numLines++;
				}
			}
		}
		console.log(numLines);
		var numColumnsSwitched = false;
		if(fcNumColumns == 1)
		{
			console.log("fcNumColumns is 1");
			colOneLines = numLines;
			//document.querySelector("#secondColumnContainer").hidden=true;
			//containerWidth = parseFloat(window.getComputedStyle(document.querySelector("#colUno"), null).getPropertyValue('width'));
		}
		else
		{
			console.log("fcNumColumns is 2");
			//var halfy = Math.floor(numLines / 2) + 1;
			//console.log("halfy = " + halfy);
			console.log("maxLinesColOne = " + maxLinesColOne + " and numLines = " + numLines);
			if(maxLinesColOne >= numLines)
			{
				colOneLines = numLines;
				fcNumColumns = 1;
				numColumnsSwitched = true;
				console.log("all lines fit in col one so set fcNumColumns=1");
				//containerWidth = document.querySelector("#colUno").getBoundingClientRect().width;
				document.querySelector("#secondColumnContainer").hidden=true;
				var dt = new Date();
				while ((new Date()) - dt <= 100){}
				containerWidth = parseFloat(window.getComputedStyle(document.querySelector("#colUno"), null).getPropertyValue('width'));

				console.log("new containerWidth = " + containerWidth);
				//self.$.pringles.style.width = window.getComputedStyle(document.querySelector("#colUno"), null).getPropertyValue('width');
				//self.$.colUno.style.width;
				//self.$.pringles.width = self.$.colUno.width;

			}
			else
			{
				colOneLines = maxLinesColOne;
				console.log("colOneLines = " + colOneLines);
			}
		}
		console.log(colOneLines);
		//in case we switched to colDos above, switch back
		containerWidth = parseFloat(window.getComputedStyle(document.querySelector("#colUno"), null).getPropertyValue('width'));
		console.log("containerWidth = " + containerWidth + " between for loops");
		var lineCounter = 0;
		for(i=0; i < numWords; i++)
		{
			//console.log(words[i]);
			var word = words[i].word;
			if(words[i].paragraphBreak == true) //paragraph begin
			{
				//console.log("a paragraph break");
				line = "all";
				console.log("lineCounter = " + lineCounter + " and colOneLines = " + colOneLines);
				if (lineCounter == colOneLines)
				{
					colOneWordIndex = i;
					console.log("just set colOneWordIndex to " + colOneWordIndex + " for word = " + words[colOneWordIndex].word);
				}
				if (lineCounter == colOneLines && fcNumColumns == 2)
				{
					//reached end of first column
					var dos = document.querySelector('#colDos');
					var space = document.createElement("span");
					space.innerHTML = "a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a";
					dos.appendChild(space);
					var dt = new Date();
					while ((new Date()) - dt <= 100){}
					containerWidth = parseFloat(window.getComputedStyle(dos, null).getPropertyValue('width'));
					console.log("containerWidth = " + containerWidth);
					dos.removeChild(space);
				}
				//if(lineCounter != 0)
				//{
					lineCounter++;
				//}
			}
			else if(word == "" || word == " ")
			{
				//continue;
			}
			else
			{
				line = line + " " + word;
				currentWidth = context.measureText(line).width; //- context.measureText(spaceOffset).width;
				
				if(currentWidth > containerWidth)
				{
					//console.log(word + " " + currentWidth);
					console.log("lineCounter = " + lineCounter + " and colOneLines = " + colOneLines + " and word = " + word);
					if (lineCounter == colOneLines)
					{
						colOneWordIndex = i;
						console.log("just set colOneWordIndex to " + colOneWordIndex + " for word = " + words[colOneWordIndex].word);
					}	
					if (lineCounter == colOneLines && fcNumColumns == 2)
					{
						//reached end of first column
						var dos = document.querySelector('#colDos');
						var space = document.createElement("span");
						space.innerHTML = "a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a a";
						dos.appendChild(space);
						var dt = new Date();
						while ((new Date()) - dt <= 100){}
						containerWidth = parseFloat(window.getComputedStyle(dos, null).getPropertyValue('width'));
						console.log("containerWidth = " + containerWidth);
						dos.removeChild(space);
					}
					lineCounter++;
					line = word;
				}
			}
		}
		if(numColumnsSwitched)
		{
			colOneLines = lineCounter;
		}	
			var j = 0;
			self.firstColumnWordArray = [];
			self.secondColumnWordArray = [];
			if (fcNumColumns==1)
			{
				//colOneWordIndex=numWords;
				document.querySelector("#secondColumnContainer").hidden=true;

			}
			else
			{
				//colOneWordIndex already set
				document.querySelector("#secondColumnContainer").hidden = false;

			}
			console.log('colOneWordIndex = ' + (colOneWordIndex));
			//console.log(words[colOneWordIndex-1].word);
			for(j=0; j<colOneWordIndex; j++)
			{
				self.push("firstColumnWordArray", words[j]);
			}
			for(j=colOneWordIndex;j<numWords;j++)
			{
				self.push("secondColumnWordArray", words[j]);
			}
        
		console.log(numLines);
		self.numRows = numLines;
		self.set("firstColumnLineNumberArray", self.largestLineNumberArray.slice(0, colOneLines));
		self.set("secondColumnLineNumberArray", self.largestLineNumberArray.slice(colOneLines, numLines));
	
		var pring = self.$.pringles.getBoundingClientRect();
		//console.log(pring.bottom + " " + pring.left + " " + cell);
		self.pending = false;
		});
			
	},
	measuring:function(){
		
	}
});
</script>
</dom-module>
