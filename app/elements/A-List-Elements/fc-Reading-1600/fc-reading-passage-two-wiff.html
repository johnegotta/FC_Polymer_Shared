<dom-module id="fc-reading-passage-two">	
<template>
<style is="custom-style">
		div.line-number {
			width: 28px;
			line-height: 1.2;
			font-size: 14pt;
			font-size: 1.25em;
			font-family: merriweather;
			font-weight: 500;
			font-style: italic;
			padding: 6px 0px 6px 0px;
			margin: 6px 0px 6px 0px;
			
		}
		div.columnContainer{
			overflow-y: scroll;
		}
		div.passageContainer{ 
			max-width: 1450px !important;
			margin: 48px;
		}
		.highlighted {
			background: yellow;
		}
		div.blurb{
			line-height: 1.2;
			font-size: 1em;
			font-family: merriweather;
			font-weight: 500;
			font-style: italic;
			display: block;
		}
		div.text {
			line-height: 1.2;
			font-size: 14pt;
			font-size: 1.25em;
			font-family: merriweather;
			font-weight: 500;
			padding: 6px;
			margin: 6px 0px 6px 0px;
			min-height: 720px !important;
			display: flex;
			min-width: 260px !important;
			max-width: 680px !important;	
		}
</style>
<!--double-column line-number and passage vertical container--> 
			<div id="noJudge" class="layout vertical flex container left passageContainer">
	<!--blurb full width container-->
					<div class="layout horizontal blurb" style="margin: 12px 24px 0px 24px;min-width: 240px !important; max-width: 680px !important; max-height: 140px;">
					{{passageBlurb}}
					</div>

	<!--single column container-->
			<div id="singleColumnContainer" class="layout horizontal container columnContainer" style="padding-right: 8px;">
			<!--Line number container-->
					 		<div id="linenumbersA1" class="layout vertical line-number">
					 		<span class="line-numbers" id="linesA1">Lines</span>
					 			<template is="dom-repeat" items="{{firstColumnLineNumberArrayOne}}" filter="{{__filter_lineNumbersForOneColumnLayout(showSecond, num_lines}}">
     								<span hidden="{{!item.show}}" id="lines_{{item.number}}">{{item.number}}</span><span hidden="{{item.show}}">&nbsp</span>
     							
    							</template>
					 		</div>
			<!--passage-1-column-1 container-->
					 		<div id="colUno" class="layout horizontal flex wrap text">
					 		<article id="textColumnOne">
					 	    	<template is="dom-repeat" items="{{passageArrayOne}}">
 									<template is="dom-if" if="{{item.newPara}}">
 										<br><span>&nbsp&nbsp&nbsp&nbsp</span>
 									</template>
 									<a id="oneA_{{index}}" hidden="{{!columnOneShow}}">{{item.word}}</a>
								</template>
									<br class="line-numbers">
									<hr>
								<span class="right-justified line-numbers" style="float:right; text-align: right;" id="singleColumnBounder"> Focused Coaching (c) 2016</span>
							</article>
					 		</div>
					 	</div>					
		<!-- end-of-column-1 line number and text container-->
		




					<div id="doubleColumnContainer" class="layout horizontal flex container">
						<div id="firstColumnContainer" class="layout horizontal flex-1 container columnContainer" style="padding-right: 12px; overflow-y:scroll;">
			<!--Line number container-->
					 		<div id="linenumbers" class="layout vertical line-number">
					 		<span id="lines" class="line-numbers">Lines</span>
					 			<template is="dom-repeat" items="{{LineNumberArray}}" filter='ColOneIn_TwoCol_Filter{{(showingSecondColumn, ref_1)}}'>
     								<span hidden="{{!item.show}}" id$="{{item.number}}">{{item.number}}</span><span hidden="{{item.show}}">&nbsp</span>
    							</template>
    							
					 		</div>
			<!--passage-1-column-1 container-->
					 		<div id="colUno" class="layout horizontal flex wrap text">
					 		<article id="textColumnOne">
					 	    	<template id='columnOneDomRepeat' is="dom-repeat" items="{{passageArrayOne}}" filter="{{passageOneFilter(showingSecondColumn,finalColumnOneWordIndex)}}">
 									<template is="dom-if" if="{{item.newPara}}">
 										<br><span>&nbsp&nbsp&nbsp&nbsp</span>
 									</template>
 									<a id$="one_{{item.order}}" invisibility="false" hidden$="{{oneGone}}">{{item.word}}</a>
								</template>
								<br id="measurer" class="line-numbers">
								<hr>
								<span class="right right-justified line-numbers" style="float:right; text-align: right;" id="doubleColumnBounderOne"> Focused Coaching (c) 2016</span>
							</article>
					 		</div>
					 	</div>
		<!-- end-of-column-1 line number and text container-->



		<!--column-2-container line numbs and passage | Flex-1 keeps the columns veen-->
					 	<div id="secondColumnContainer" class="layout horizontal flex-1 columnContainer" >
			<!--Line number container-->
					 		<div id="linenumbersright" class="layout vertical line-number">
					 	
					 		 	<template is="dom-repeat" items="{{LineNumberArrayTwo}}">
     								<span hidden="{{!item.show}}" filter='{{ColTwoIn_Col_Two_Filter(showingSecondColumn, ref_1, ref_2)}}'>{{item.number}}</span><span hidden="{{item.show}}">&nbsp</span><!--btw nothing better than a hidden text node in node hopping-->
     								
    							</template>	
					 		</div>
			<!--end of passage-1-column-1 line number container-->
			<!--passage-1-column-2 container-->
					 		<div id="colDos" class="layout vertical text">
					 		<article id="textColumnTwo">
								<template is="dom-repeat" items="{{passageArrayOne}}" filter="{{passageTwoFilter(showingSecondColumn,finalColumnOneWordIndex)}}">
 									<template is="dom-if" if="{{item.newPara}}">
 										<br><span>&nbsp&nbsp&nbsp&nbsp</span>
 									</template>
 									<a id$="one_{{item.order}}" hidden$="{{!oneGone}}">{{item.word}}</a>
								</template>
								<br class="line-numbers">
								<hr>
								<span class="right right-justified line-numbers" style="float:right; text-align: right;" id="doubleColumnBounderTwo"> End of Passage</span>
							</article>
					 		</div>
		<!--passage-1-column-2 container-->
					 	</div>
	<!--end of flex passage column container-->
				</div>
<!--End of top container horizontal-->
			</div>
<!--End of Vertical passage container-->
</template>
<script>
Polymer({
	is:'fc-reading-passage-two',
	behaviors: [Polymer.IronResizableBehavior],
	properties: {
		passagePath: {
			type: String,
			value: 'new_Passage_0',
			notify: true,
			reflectToAttributes: true
		},
		passageArrayOne:{
			type: Array, 
			value: [],
			notify: true, 
			reflectToAttibutes: true 
		},
		longestLineNumberArray:{
			type: Array,
			value: [],
			notify: true,

		},
		ColumnOneWordArray: {
			type: Array,
			value: [],
			notify: true,
			reflectToAttributes: true
		},
		ColumnTwoWordArray: {
			type: Array,
			value: [],
			notify: true,
			reflectToAttributes: true
		},
		firstColumnLineNumberArrayOne:{
			type: Array,
			value: [],
			notify: true
		},
		passageWordArray: {
			type: Array,
			value: [],
			notify: true
		},
		goldenDist:{
			type: Number,
			notify: true
		},
		wordArray: {
			type: Array,
			value: [],
			notify: true
		},
		firstColumnLineNumberArrayOne:{
			type: Array,
			value: [],
			notify: true
		},
		longestLineNumberArray:{
			type: Array,
			value: [],
			notify: true
		},

		LineNumberArray: {
			type: Array,
			value: [],
			notify: true
		},
		LineNumberArrayTwo: {
			type: Array,
			value: [],
			notify: true
		},
		
		passageTitle: {
			type: String, 
			notify: true,
			reflectToAttributes: true
		},
		numWords: {
			type: Number,
			notify: true,
			reflectToAttributes: true
		},
		passageBlurb:{
			type: String,
			value: 'none',
			reflectToAttributes: true,
			notify: true
		},
		linesH: {
			type: String,
			value: '',
			notify: true
		},
		showingSecondColumn: {
			type: Boolean,
			value: false,
			notify: true
		},
		lastRow:{
			type: Number,
			notify: true,
		},
		goldenRatio: {
			type: Number,
			notify: true,
			reflectToAttributes: true
		},
		finalColumnOneWordIndex: {
			type: Number,
			notify: true
		},
		middleWordsArray:{
			type: Array,
			value: [],
			notify: true
		},
		idPlus:{
			type: Number,
			notify: true
		},
		lastWordIndex:{
			type: Number,
			notify: true
		},
		deltaWords:{
			type: Number,
			value: 0,
			notify: true
		},
		secondColumnFirstWordIndex:{
			type: Number,
			notify: true
		},
		counter: {
			type: Number,
			value: 0,
			notify: true
		},
		rowLast: {
			type: Array,
			value: [],
			notify: true
		},
		numbersAssigned:{
			type: Array,
			value: [],
			notify: true
		},
		notify: true,
		reflectToAttributes: true
	},
	attached: function(){
		for(i=1; i <= 200; i++)
			{
			j=	i % 5 ? false: true;
			 this.push("LineNumberArray", {'number': i, 'show': j});
			 this.push("LineNumberArrayTwo", {'number': i, 'show': j});
			 this.push("firstColumnLineNumberArrayOne", {'number': i, 'show': j});
			this.push("longestLineNumberArray", {'number': i, 'show': j});
		
			}
			this.counter=0;
		this.loadPassages();
		},
	logjunk: function(){
	
	},
	loadPassages: function(passagePath){
		passagePath = passagePath === undefined ? 'new_Passage_2' : passagePath;
	//added path here--really want admin to rain down property
		this.passageArrayOne=[];
		var self = this;
		var ref = new Firebase("https://focused0ne.firebaseio.com/passagesDestinations/" + passagePath);
		ref.on("value", function(snap){
			self.passageArrayOne=[];
			self.wordArray =[];
			self.ColumnOneWordArray=[];
			self.ColumnTwoWordArray=[];
			self.passageArrayOne = snap.val();
			self.numWords = self.passageArrayOne.length;
			self.lastWordIndex = self.numWords-2;
			self.goldenRatio = Math.floor(.618*self.numWords);
			self.finalColumnOneWordIndex = self.goldenRatio;
			self.secondColumnFirstWordIndex = self.finalColumnOneWordIndex+1;
			self.passageTitle = self.passageArrayOne[0].passageTitle;
			self.passageBlurb = self.passageArrayOne[0].passageBlurb;
		
			var j=0;
			for(j=0; j<self.numWords;j++){
				self.push("wordArray", self.passageArrayOne[j].word.replace('&nbsp&nbsp&nbsp&nbsp','aaaa'));
					}
		});
	},
	
	notifyResize: function(){		
		this.setUp();
	},
	
	setUp: function()
	{
		this.screenTrueHeight =  (window.innerHeight-340);
		this.textColumnOneHeight=this.$.textColumnOne.scrollHeight;
		if(this.textColumnOneHeight!=undefined && this.textColumnOneHeight >=50)
		{
			if(this.$.noJudge.clientWidth >= 650 && this.textColumnOneHeight>this.screenTrueHeight)
			{
				this.$.doubleColumnContainer.hidden = false;
				this.$.singleColumnContainer.hidden = true; 
				this.showingSecondColumn = true;
				this._adjustDoubleColumns();
				this._measureWords(true);
			}
			else
			{ 
				this.$.doubleColumnContainer.hidden = true;
				this.$.singleColumnContainer.hidden = false;
				this.showingSecondColumn = false;
				this._measureWords(false);
				
			}
		}
		else 
		{
			if(this.$.noJudge.clientWidth >= 650)
			{
				this.$.doubleColumnContainer.hidden = false;
				this.textColumnOneHeight=this.$.textColumnOne.scrollHeight;
				if(this.textColumnOneHeight < this.screenTrueHeight)
				{
					this.$.doubleColumnContainer.hidden = false;
					this.$.singleColumnContainer.hidden = true; 
					this.showingSecondColumn = true;
					this._adjustDoubleColumns();
					this._measureWords(true);
				}
			}
			else
			{
				this.$.doubleColumnContainer.hidden = true;
				this.$.singleColumnContainer.hidden = false;
				this.showingSecondColumn=false;
				this._measureWords(false);
				
				
			}
					
		}
		
	},


	growFirstColumn: function(anchorOne){
				var self=this;
				console.log("growing the right side");
				console.log('do we ever enter this function?');
				var numberAhead=anchorOne;
				while(numberAhead>=8 && top_of_line_to_reclaim == top_of_next_anchor){
				self.firstWordAnchor =  (this.$$('#one_'+ self.secondColumnFirstWordIndex.toString()) != undefined) ? this.$$('#one_'+ self.secondColumnFirstWordIndex.toString()): setTimeout(alert("one of these terniary functions worked"),1400);
		console.log('do we ever enter this function?');
					var top_of_line_to_reclaim = self.firstWordAnchor.getBoundingClientRect().top;
					var nextAnchor = self.firstWordAnchor;
					var top_of_next_anchor = top_of_line_to_reclaim;
					self.numberPlus--;
				while(top_of_line_to_reclaim == top_of_next_anchor){
					console.log("growing the right side");				
					nextAnchor = nextAnchor.nextSibling;	
					if(nextAnchor.nodeName == self.firstWordAnchor.nodeName){
						console.log(nextAnchor.nodeName +  ' node two: ' + self.firstWordAnchor.nodeName);
						top_of_next_anchor = nextAnchor.getBoundingClientRect().top;
						self.numberPlus--;
					}
				}
			}
			//this._measureWords(true);

		},

	_adjustDoubleColumns: function(lastRow){
				Polymer.dom.flush();
				this.finalColumnOneWordIndex = (this.finalColumnOneWordIndex<.54*this.numWords) ? this.goldenRatio: this.finalColumnOneWordIndex;
				var theId = '#one_'+ this.finalColumnOneWordIndex.toString()
				var finalWordAnchor = this.$$(theId);
				var bottom_of_line_to_cut = finalWordAnchor.getBoundingClientRect().bottom;
				var previousAnchor = finalWordAnchor;
				var bottom_of_previous_anchor = bottom_of_line_to_cut;
				var howManyAheadOfFinalColumnOneWord = 0;

				
				while(howManyAheadOfFinalColumnOneWord <18 && bottom_of_previous_anchor == bottom_of_line_to_cut){
					previousAnchor = previousAnchor.previousSibling;
					if(previousAnchor.nodeName == finalWordAnchor.nodeName){
						console.log(previousAnchor.nodeName +  ' : compare node to node : ' + finalWordAnchor.nodeName);
						bottom_of_previous_anchor = previousAnchor.getBoundingClientRect().bottom;
						howManyAheadOfFinalColumnOneWord++;
						

					};
				}
				
			this.finalColumnOneWordIndex = this.finalColumnOneWordIndex - howManyAheadOfFinalColumnOneWord;
					this.numberPlus = this.goldenRatio - this.finalColumnOneWordIndex;
					console.log('this is the two column adjustment and col one anchor: ' + this.numberPlus);
					//this._measureWords(true);
					this.growFirstColumn(this.numberPlus);
					console.log(this.numberPlus);

			},

	


	numberTwoColumns: function(colOne, colTwo){
		ColOneIn_TwoCol_Filter(true, num_lines);
		ColTwoIn_TwoCol_Filter(true, num_lines)

		
	},

	numberOneColumn: function(RowsEstimate){
		 var top_of_first_word = this.$$('#oneA_1').getBoundingClientRect().top;
		 var last_word_rect = this.$$('#oneA_'+ this.lastWordIndex.toString()).getBoundingClientRect();
		 var line_height = last_word_rect.height;
		 var delta = last_word_rect.bottom - top_of_first_word;
		 var num_lines = Math.round(delta/24);
		 num_lines=(num_lines>35 || num_lines < 160 && num_lines<RowsEstimate) ? num_lines: RowsEstimate;
		 //this.firstColumnLineNumberArrayOne = [];
		 //this.set("firstColumnLineNumberArrayOne", this.longestLineNumberArray.slice(0, num_lines));
		 __filter_lineNumbersForOneColumnLayout(false, num_lines);

		},

		
	passageOneFilter: function(showSecond, finalWordCol){
		if(showSecond==true && (this.finalColumnOneWordIndex-10)<this.secondColumnFirstWordIndex){
			return (item)=>{
				this.numberTwoColumns(65, 102);
				return (item.order <= this.finalColumnOneWordIndex);
			};
		} 
		else if(showSecond==true){
			return (item)=>{
				return (item.order < this.secondColumnFirstWordIndex);
				}
			}
		else{
			return (items)=>{ return false
			};
		}
	},
	
	passageTwoFilter: function(showSecond, finalWord){
		if(showSecond==true && (this.finalColumnOneWordIndex-10)<this.secondColumnFirstWordIndex){
			return (item)=>{
				return (item.order > this.finalColumnOneWordIndex);
			};
		} else if(showSecond==true){
			return (item)=>{
				return (item.order >= this.secondColumnFirstWordIndex);
				}
			}
		else {
			return (item)=>{
				return false;
				};
			}
		}, 

	__filter_lineNumbersForOneColumnLayout: function(showSecond, num_lines){
		if(showSecond==false && num_lines >30){
		return (item) =>{
			consol.log(num_lines);
			return(item.number<=num_lines);
			};
		}
		else{
			return (item)=> {
				return false;
				}
			}
		},
	ColOneIn_TwoCol_Filter: function(showSecond, num_lines){
		if(showSecond==true && num_lines >40){
			return (item) =>{
				return(item.number<=num_lines);
				};
			}
			else{
				return (item)=> {
					return false;
					}
				}
			},
	ColTwoIn_Col_Two_Filter: function(showSecond, ref_1, num_lines){
		if(showSecond==true && num_lines>40){
			return (item) =>{
				return(item.number<=num_lines && item.number>=ref_);
				};
			}
			else{
				return (item)=>{
					return false;
				}
			}
	}
});
</script>
</dom-module>

_masureWords:function(showSecondColumn){
		//var referencePassage = this.passageArrayOne;
		this.passageWordArray =[];
		var lastWord=this.numWords;
		var canvas = document.createElement('canvas');
		var context = canvas.getContext("2d");
		context = this.measureFont();
		context.font = this.measureFont().font;
		console.log(context.font);
		var passageWidth = (this.$.textColumnOne != undefined && this.showingSecondColumn ==true) ? this.$.textColumnOne.clientWidth: this.$.singleColumnText.clientWidth;
		while(passageWidth < 240 && showSecondColumn == true && this.$.textColumnOne == undefined )
		{
			this.$.textColumnOne.clientWidth;
		}
		console.log("this.is_passage_width: "  + passageWidth);
		var currentRow = 0;
		var passageTitle = this.passageTitle;
		var numParagraphs = this.paragraphs;
			var numWords = lastWord;
			var wordCount = 0;
			var currentLine = "";
			var currentWidth = 0;
			for(wordCount=0; wordCount < numWords; wordCount++)
			{	
				var indentOffset = (context.measureText("\x20").width)*5;
				var currentWord = this.wordArray[wordCount];
				var wordMeasure = " " + this.wordArray[wordCount];
				var newPara = this.passageArrayOne[wordCount].newPara;
				var isLastWordOfPara = this.passageArrayOne[wordCount].isLastWordOfPara;
				if(newPara == true || wordCount==0){
					currentWidth= indentOffset + context.measureText(currentWord).width;
					currentLine = this.wordArray[wordCount];
					currentRow++;
				}
				else if(currentWidth+context.measureText(wordMeasure).width < passageWidth)
				{
					currentLine += wordMeasure; //add a word and space
					currentWidth = context.measureText(currentLine).width;
				} 
				else{
					currentLine = this.wordArray[wordCount];
					currentWidth = context.measureText(currentLine).width;
					currentRow++;
				}
				if(this.order!==lastWord){
					this.push("passageWordArray",
					{ 	
						'currentLine': currentLine,
						'lastWordofPara': isLastWordOfPara,
						'order': wordCount,
						'word' : currentWord, 
						"currentLineWidth": currentWidth, 
						'row':currentRow,
						'passage_width': passageWidth,
						'newPara': newPara,
						'lastRow': 'unknown',
						'word-width': context.measureText(currentWord).width
					}
				);
					
				}
				else { console.log('in the loop for last word');
					this.push("passageWordArray",
					{ 	
						'currentLine': currentLine,
						'order': wordCount,
						'word' : currentWord, 
						"currentLineWidth": currentWidth, 
						'row':currentRow,
						'passage_width': passageWidth,
						'lastWordofPara': isLastWordOfPara,
						'newPara': newPara,
						'lastRow': currentRow,
						'word-width': context.measureText(currentWord).width
					});
					
				}		
			}
			var lastRowLast=this.pop('passageWordArray');
			this.lastRow=lastRowLast.currentLine;
			alert("the Last Row " + this.lastRow + ' ' + ' ' + lastRowLast.currentLine);
		},

	measureFont: function(){
		var lines = this.$.textColumnOne;		
		var canvas = document.createElement('canvas');
		var context = canvas.getContext("2d");
		this.context = context;
		var calcFontSize = window.getComputedStyle(lines, null).getPropertyValue('font-size');
		var calcFontFam = window.getComputedStyle(lines, null).getPropertyValue('font-family');
		this.context.font = context.font = calcFontSize + " " + calcFontFam;
		return this.context;			
	 },

	 /*
		var guess_previous_sibling = Polymer.dom(guess).previousSibling; 
		alert(guess + ' ' + guess_previous_sibling);
		alert(guess.nodeName);
		while(guess.nodeName != guess_previous_sibling.nodeName){
			guess = guess_previous_sibling;
			guess_previous_sibling = Polymer.dom(guess_previous_sibling).previousSibling;
		} 
		var bottom_checker = guess.getBoundingClientRect().bottom;
		this.bottom_checker = bottom_checker;
		var last_lines_child = Polymer.dom("linenumbersA1").lastChild;
		var previous_sibling = Polymer.dom(last_lines_child).previousSibling;
		while(last_lines_child.nodeName !=previous_sibling.nodeName && last_lines_child.nodeName!='SPAN'){
			last_lines_child=previous_sibling;
			previous_sibling=Polymer.dom(last_lines_child).previousSibling;
			console.log(previous_sibling.nodeName + " and the last child: " + "last_lines_child.nodeName");
		}
		var last_lines_child_bottom=last_lines_child.getBoundingClientRect().bottom;
		var previous_sibling_bottom=previous_sibling.getBoundingClientRect().bottom;
		this.last_lines_child =null;
		while(last_lines_child.nodeName ==previous_sibling.nodeName && this.last_lines_child ==null){
			last_lines_child=previous_sibling;
			previous_sibling=Polymer.dom(last_lines_child).previousSibling;
			last_lines_child_bottom=previous_sibling_bottom;
			previous_sibling_bottom=Polymer.dom(previous_sibling).previousSibling.getBoundingClientRect().bottom;
			if(last_lines_child_bottom==this.bottom_checker){
				this.last_lines_child =last_lines_child;
			}
		}
		var burger = this.last_lines_child.number;
		console.log(burger);	
		alert(burger);
				
*/
