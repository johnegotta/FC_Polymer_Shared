<dom-module id="fc-double-column-layout">
<template>
<style>
		div.line-number {
			width: 28px;
			line-height: 1.2;
			font-size: 14pt;
			font-size: 1.25em;
			font-family: merriweather;
			font-weight: 500;
			font-style: italic;
			padding: 6px 0px 6px 0px;
			margin: 6px 0px 6px 0px;
			
		}
		div.columnContainer{
			overflow-y: scroll;
		}
		
		.highlighted {
			background: yellow;
		}
		
		div.text {
			line-height: 1.2;
			font-size: 14pt;
			font-size: 1.25em;
			font-family: merriweather;
			font-weight: 500;
			padding: 6px;
			margin: 6px 0px 6px 0px;
			min-height: 720px !important;
			display: flex;
			min-width: 260px !important;
			max-width: 680px !important;	
		}
</style>
		
		<div class="layout horizontal flex container">

				<div id="firstColumnContainer" class="layout horizontal flex-1 container columnContainer" style="padding-right: 12px; overflow-y:scroll;">
					 	<div id="linenumbers" class="layout vertical line-number">
					 			<span id="lines" class="line-numbers">Lines</span>
					 			<template is="dom-repeat" items="{{longestLineNumberArray}}" filter='{{columnOneLineNumbersFilter()}}'>
     								<span hidden="{{!item.show}}" id$="{{item.number}}">{{item.number}}</span>
     								<span hidden="{{item.show}}">&nbsp</span>
    							</template>
    				
					 	</div>
			<!--passage-1-column-1 container-->
					 	<div id="colUno" class="layout horizontal flex wrap text">
					 		<article id="textColumnOne">
					 	    	<template id='columnOneDomRepeat' is="dom-repeat" items="{{theContent}}" filter="{{columnOneWordFilter()}}">
 									<template is="dom-if" if="{{item.newPara}}">
 										<br><span>&nbsp&nbsp&nbsp&nbsp</span>
 									</template>
 									<a id$="oneTwoWords_{{item.order}}" invisibility="false" hidden$="{{oneGone}}">{{item.word}}</a>
								</template>
								<br id="measurer" class="line-numbers">
								<hr>
								<span class="right right-justified line-numbers" style="float:right; text-align: right;" id="doubleColumnBounderOne"> Focused Coaching (c) 2016</span>
							</article>
					 	</div>
					</div>
		<!-- end-of-column-1 line number and text container-->



		<!--column-2-container line numbs and passage | Flex-1 keeps the columns veen-->
					 <div id="secondColumnContainer" class="layout horizontal flex-1 columnContainer" >
					 	<div id="linenumbersright" class="layout vertical line-number">

					 		 	<template is="dom-repeat" items="{{longestLineNumberArray}}">	
     								<span hidden="{{!item.show}}" filter='{{columnTwoLineNumbersFilter()}}'>{{item.number}}</span>
     								<span hidden="{{item.show}}">&nbsp</span>
    							</template>	
					 	</div>


						<div id="colDos" class="layout vertical text">
					 		<article id="textColumnTwo">
									
									<template is="dom-repeat" items="{{theContent}}" filter="{{columnTwoWordFilter()}}">
	 									<template is="dom-if" if="{{item.newPara}}">
 											<br>
 											<span>&nbsp&nbsp&nbsp&nbsp</span>
	 									</template>
 										<a id$="twoTwoWords_{{item.order}}" hidden$="{{!oneGone}}">{{item.word}}</a>
									</template>
									<br>
									<hr>
									<span class="right right-justified line-numbers" style="float:right; text-align: right;" id="doubleColumnBounderTwo"> End of Passage</span>
							</article>
						</div>
		</div>
	<!--end of flex passage column container-->
</div>
</template>
<script>
Polymer({
	is: 'fc-double-column-layout',
		properties: {

		theContent:{
			type: Array, 
			value: [],
			notify: true, 
			reflectToAttibutes: true 
		},
		lastWordIndex:{
			type: Number,
			notify: true,
			reflectToAttributes: true
		},
		
		longestLineNumberArray:{
			type: Array,
			value: [],
			notify: true,

		},
		goldenRatio: {
			type: Number,
			notify: true,
			reflectToAttributes: true
		},
		firstColumnLastWordIndex: {
			type: Number,
			notify: true
		},

		secondColumnFirstWordIndex: {
			type: Number,
			notify: true
		},
		
		lastRow:{
			type: Number,
			notify: true,
		},
		columnOneLastRow:{
			type: Number,
			value: 70,
			notify: true

		},
		
		deltaWords:{
			type: Number,
			value: 0,
			notify: true
		},

		shown:{
			type: Boolean,
			value: false,
			notify: true,
			reflectToAttributes: true
		}

	},

ready: function(){
	this.goldenRatio = Math.floor(.618*this.lastWordIndex);
	this.firstColumnLastWordIndex = this.goldenRatio;
	this.secondColumnFirstWordIndex = this.finalColumnOneWordIndex+1;
},

attached: function(){
		this.longestLineNumberArray=[];
		for(i=1; i <= 280; i++)
			{
			j=	i % 5 ? false: true;
			this.push("longestLineNumberArray", {'number': i, 'show': j});
		
			}
		this.loadContent();
	},

loadContent:function(){
			this.goldenRatio = Math.floor(.618*self.numWords);
			this.firstColumnLastWordIndex = this.goldenRatio;
			this.secondColumnFirstWordIndex = this.finalColumnOneWordIndex+1;
			this.numberTwoColumns();
			this.notifyResize();
			alert(this.firstColumnLastWordIndex );

},
notifyResize: function(){
	//this._adjustDoubleColumns();

},

_adjustDoubleColumns: function(lastRow){
				this.firstColumnLastWordIndex = (this.firstColumnLastWordIndex<.54*this.lastWordIndex) ? this.goldenRatio: this.firstColumnLastWordIndex;
				var finalWordAnchor = this.$$('#oneTwoWords_'+ this.firstColumnLastWordIndex.toString());
				console.log(finalWordAnchor);
				var bottom_of_line_to_cut = finalWordAnchor.getBoundingClientRect().bottom;
				var previousAnchor = finalWordAnchor;
				var bottom_of_previous_anchor = bottom_of_line_to_cut;
				var howManyAheadOfFinalColumnOneWord = 0;
				
				while(howManyAheadOfFinalColumnOneWord <18 && bottom_of_previous_anchor == bottom_of_line_to_cut){
					previousAnchor = previousAnchor.previousSibling;
					if(previousAnchor.nodeName == finalWordAnchor.nodeName){
		console.log(previousAnchor.nodeName +  ' : compare node to node : ' + finalWordAnchor.nodeName);
						bottom_of_previous_anchor = previousAnchor.getBoundingClientRect().bottom;
						howManyAheadOfFinalColumnOneWord++;
						
					}
					else{
						console.log("words ahead" + howManyAheadOfFinalColumnOneWord + 'broken');


					}
				}
				
			this.firstColumnLastWordIndex = this.firstColumnLastWordIndex - howManyAheadOfFinalColumnOneWord;
					this.deltaWords = this.goldenRatio - this.finalColumnOneWordIndex;
	console.log('this is the words added in total to column two and the adjustment to col one anchor: ' + this.deltaWords);
					this.growFirstColumn(this.deltaWords);
	console.log(this.deltaWords);

			},

growFirstColumn: function(anchorOne){	
	console.log("growing the right side");
				var numberAhead=anchorOne;
				while(numberAhead>=8 && top_of_line_to_reclaim == top_of_next_anchor){
				this.firstWordAnchor =  (this.$$('#one_'+ this.secondColumnFirstWordIndex.toString()) != undefined) ? this.$$('#one_'+ this.secondColumnFirstWordIndex.toString()): setTimeout(alert("one of these terniary functions worked"),1400);
		
					var top_of_line_to_reclaim = this.firstWordAnchor.getBoundingClientRect().top;
					var nextAnchor = this.firstWordAnchor;
					var top_of_next_anchor = top_of_line_to_reclaim;
					this.numberPlus--;
				while(top_of_line_to_reclaim == top_of_next_anchor){
		console.log("growing the right side");				
					nextAnchor = nextAnchor.nextSibling;	
					if(nextAnchor.nodeName == this.firstWordAnchor.nodeName){
		console.log(nextAnchor.nodeName +  ' node two: ' + this.firstWordAnchor.nodeName);
						top_of_next_anchor = nextAnchor.getBoundingClientRect().top;
						this.deltaWords--;
						console.log('do we ever enter this function?');
					}
				}
			}
			this.numberTwoColumns();
		},

	numberTwoColumns: function(colOne, colTwo){
		 var bottom_of_first_word = this.$.lines.getBoundingClientRect().bottom;
		 var last_word = this.$.doubleColumnBounderOne;
		 var last_word_rect =  last_word.getBoundingClientRect();
		 var line_height = this.$.lines.clientHeight;
		 var delta = last_word_rect.bottom - bottom_of_first_word;
		 this.num_lines = Math.round(delta/line_height) - 2;
		 var deltaTwo = bottom_of_first_word - this.$.doubleColumnBounderTwo.getBoundingClientRect().bottom;
		 var num_lines_two = Math.round(deltaTwo/line_height) - 1;
		 this.last_row = this.num_lines + num_lines_two;

		this.columnOneLineNumbersFilter();
		this.columnTwoLineNumbersFilter();
	},

	columnOneWordFilter: function(finalWordCol){
		if(this.firstColumnLastWordIndex > 0){
			return (item)=>{
				return (item.order <= this.finalColumnOneWordIndex);
			};
		} 

		else{
			return (items)=>{ return false;
			};
		}
	},
	
	columnTwoWordFilter: function(finalWord, lastWord){
		if(this.firstColumnLastWordIndex > 0){
			return (item)=>{
				return (item.order > this.firstColumnLastWordIndex);
			};
		} 
		else {
			return (item)=>{
				return false;
				};
			}
		}, 

	columnOneLineNumbersFilter: function(){
		if(this.num_lines >0){
			return (item) =>{
				return(item.number<=this.num_lines);
				};
			}
			else{
				return (item)=> {
					return false;
					}
				}
			},
	columnTwoLineNumbersFilter: function(){
		if(this.num_lines>40){
			return (item) =>{
				return(item.number>this.num_lines && item.number<=this.last_row);
				};
			}
			else{
				return (item)=>{
					return false;
				}
			}
	}
});

</script>
</dom-module>