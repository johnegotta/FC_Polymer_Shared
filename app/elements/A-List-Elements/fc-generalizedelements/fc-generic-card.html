<dom-module id="fc-generic-card">
  <template>
    <style>
    paper-header-panel {
      height: 600px;
      width: 400px;
      overflow-y: scroll;
      border: 1px solid black;
    }
    paper-input {
      padding: 10px;
    }
    #submitChangedInputsButton {
      background: green;
      color: white;
    }
    #mainCardContent {
      padding-top: 5px;
    }
    #mainCardContentTabbedInfo {
      height: 400px;
      border: 1px dashed red;
      overflow-x:scroll;
    }
    </style>
    <paper-header-panel id="fullCard">
        <paper-tabs class="paper-header" scrollable id="fullCardHeaderTabs" selected="{{selectedTab}}">
        </paper-tabs>
      <div id="mainCardContent">
        <paper-button id="inputEnablerButton" raised hidden$="[[editingDataInputs]]" on-tap="toggleInputs">Edit Info</paper-button>
        <paper-button id="submitChangedInputsButton" raised hidden$="[[!editingDataInputs]]" on-tap="submitInputChanges">Submit Changes</paper-button>
        <div id="mainCardContentTopInfo" class="horizontal layout wrap">
        </div>
        <div id="mainCardContentTabbedInfo">
          <iron-pages id="mainCardContentTabbedInfoPages" selected="{{selectedTab}}">
          </iron-pages>
        </div>
      </div>
    </paper-header-panel>
  </template>
  <script>
    fcGeneralCard = Polymer({
      is: "fc-generic-card",
      properties: {
        firebaseUrl: {
          type: String,
          value: "focusedstaging1.firebaseio.com"
        },
        cardTopLevel: {
          type: String,
          value: "",
        },
        cardTopLevelRoute: {
          type: String,
          computed: "computeFullRoute(firebaseUrl,cardTopLevel)"
        },
        selectedTab: {
          type: Number,
          value: 0,
          notify: true
        },
        editingDataInputs: {
          type: Boolean,
          value: false
        },
        pageTabs: {
          type: Array,
          value: [],
          notify: true
        }
      },
      ready: function(){
        //console.log(this.cardTopLevel);
        //this.createCardData();
      },
      computeFullRoute: function(first_part,second_part){
        return first_part + "/" + second_part;
      },
      factoryImpl: function(argCardTopLevel){
        this.cardTopLevel = argCardTopLevel;
        this.createCardData();
      },
      toggleInputs: function() {
        var inputsToEnable = Polymer.dom(this.$.mainCardContentTopInfo).querySelectorAll("paper-input");
        inputsToEnable.map(function(singleInput){
          singleInput.disabled = !singleInput.disabled;
        });
        this.editingDataInputs = !this.editingDataInputs;
      },
      submitInputChanges: function(){
        var inputsToEnable = Polymer.dom(this.$.mainCardContentTopInfo).querySelectorAll("paper-input");
        inputsToEnable.map(function(singleInput){
          //console.log(singleInput.getAttribute("data-location"));
          var ref = new Firebase(singleInput.getAttribute("data-location"));
          ref.set(singleInput.value);
        });
        this.toggleInputs();
      },
      createCardData: function(){
        var self = this;
        var ref = new Firebase(self.firebaseUrl);
        ref.child(self.cardTopLevel).once("value", function(snap){
          var snapKey = snap.key();
          var snapObject = snap.val();
          //var snapRoute = ref.toString() + self.cardTopLevel;
          for (var subKey in snapObject){
            //console.log(typeof snapObject[subKey]);
            switch (typeof snapObject[subKey]){
              case "string" :
                var newDisabledInput = document.createElement("paper-input");
                newDisabledInput.id = self.cardTopLevelRoute + "/" + subKey + "_input";
                newDisabledInput.setAttribute("data-location",self.cardTopLevelRoute + "/" + subKey);
                newDisabledInput.setAttribute("always-float-label",true);
                newDisabledInput.disabled = true;
                newDisabledInput.label = subKey;
                newDisabledInput.value = snapObject[subKey];
                Polymer.dom(self.$.mainCardContentTopInfo).appendChild(newDisabledInput);
                break;
              case "object" :
                var newCardTab = document.createElement("paper-tab");
                newCardTab.innerHTML = subKey;
                Polymer.dom(self.$.fullCardHeaderTabs).appendChild(newCardTab);
                var pageToAdd = document.createElement("div");
                var pageToAddId = subKey + "_page"
                pageToAdd.id = pageToAddId;
                console.log(pageToAddId);
                var pageToAddUL = document.createElement("ul");
                pageToAdd.appendChild(pageToAddUL);
                Polymer.dom(self.$.mainCardContentTabbedInfoPages).appendChild(pageToAdd);
                var objToGetMoreOf = snapObject[subKey];
                for (var lowerKey in objToGetMoreOf){
                  var lowerRoute = subKey + "/" + lowerKey;
                  self.addNewLiToCorrectPage(pageToAddId,lowerRoute);
                }
                break;
            }
          }
        });
      },
      addNewLiToCorrectPage: function(pageID,routeForNewLi){
        var self = this;
        var ref = new Firebase(self.firebaseUrl + "/" + routeForNewLi);
         ref.once("value", function(newLiSnap){
          var newLiToAdd = document.createElement("li");
          newLiToAdd.innerHTML = JSON.stringify(newLiSnap.val());
          Polymer.dom(self.$.mainCardContentTabbedInfo).querySelector('#' + pageID).querySelector("ul").appendChild(newLiToAdd);
        });
      }
    });
  </script>
</dom-module>