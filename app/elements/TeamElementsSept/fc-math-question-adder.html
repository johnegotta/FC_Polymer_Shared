<script src="../../bower_components/math-tex/mathjax-loader.js"></script>
<script src="../../bower_components/math-tex/math-tex.js"></script>
<script src="../../bower_components/Sortable/Sortable.min.js"></script>

<dom-module id="fc-math-question-adder">
  <template>
    <style>
      #main_question_toolbar {
        background-color: gray;
        height: 20px;
      }
      #input_choices_area,#desired_questions_inputs_area,#question_preview_area {
        margin: 15px;
        min-height:50px;
        border: 1px dashed gray;
      }
      .addable_input {
        border: 1px solid black;
        padding: 5px;
      }
      #input_choices_area .js-remove {
        -webkit-transition: opacity .2s;
        transition: opacity .2s;
        opacity: 0;
        display: none;
        cursor: pointer;
        color: #c00;
        position: relative;
        font-style: normal;
      }
      #desired_questions_inputs_area .js-remove {
        -webkit-transition: opacity .2s;
        transition: opacity .2s;
        opacity: 0;
        display: block;
        cursor: pointer;
        color: #c00;
        position: relative;
        font-style: normal;
      }
      #input_choices_area .handle {
        -webkit-transition: opacity .2s;
        transition: opacity .2s;
        opacity: 0;
        display: block;
        cursor: pointer;
        position: relative;
        font-style: normal;
      }
      #desired_questions_inputs_area .handle {
        -webkit-transition: opacity .2s;
        transition: opacity .2s;
        opacity: 0;
        display: block;
        cursor: pointer;
        position: relative;
        font-style: normal;
      }
      #desired_questions_inputs_area div:hover .handle{
        opacity: 1;
      }
      #desired_questions_inputs_area div:hover .js-remove{
        opacity: 1;
      }
      #input_choices_area div:hover .handle {
        opacity: 1;
      }
      math-tex.display-equation:last-of-type {
        margin-bottom: 10px;
      }
      #question_preview_area {
        width: 300px;
        height: 420px;
        padding: 5px;
        z-index: 0;
      }
    </style>

    <firebase-document id="math_questions_loc" location="https://amber-inferno-3827.firebaseio.com/questions"></firebase-document>
    <div id="main_question_toolbar"class="flex horizontal"></div>
    <div class="horizontal layout">

      <div id="input_choices_area" class="flex-1">
        <div class="horizontal layout center addable_input"><iron-icon class="handle" icon="hardware:gamepad"></iron-icon><paper-input class="in_value flex" on-focus="sayHi" data-inputtype="Display Equation" label="Display Equation"></paper-input><iron-icon class="js-remove" icon="clear"></iron-icon></div>

        <div class="horizontal layout center addable_input"><iron-icon class="handle" icon="hardware:gamepad"></iron-icon>
          <fc-image-upload raised class="in_value flex" data-inputtype="Question Image">Add Images</fc-image-upload>
          <iron-icon class="js-remove" icon="clear"></iron-icon>
        </div>

        <div class="horizontal layout center addable_input"><iron-icon class="handle" icon="hardware:gamepad"></iron-icon><paper-textarea class="in_value flex" data-inputtype="Question Text" label="Question Text"></paper-textarea><iron-icon class="js-remove" icon="clear"></iron-icon></div>

        <div class="horizontal layout center addable_input"><iron-icon class="handle" icon="hardware:gamepad"></iron-icon>
          <div class="in_value flex" data-inputtype="Answer Choices">
            <paper-input label="A"></paper-input>
            <paper-input label="B"></paper-input>
            <paper-input label="C"></paper-input>
            <paper-input label="D"></paper-input>
          </div>
          <iron-icon class="js-remove" icon="clear"></iron-icon>
        </div>
      </div>

      <div "question_input_area" class="flex-2">
        <form is="iron-form" id="math_question_adder_form" on-iron-submit>
          <div id="desired_questions_inputs_area">

          </div>
        </form>
        <paper-button id="preview_button" raised on-tap="showFormContents">Preview</paper-button>
      </div>

      <!--<div id="question_preview_area" class="vertical layout" on-mousedown="onMouseClickOnMyCanvas" on-mousemove="onMouseMoveOnMyCanvas">-->
      <div id="question_preview_area" class="vertical layout">
      </div>

    </div>
  </template>
  <script>
    Polymer({
      is: 'fc-math-question-adder',

      behaviors: [
        Polymer.IronA11yKeysBehavior
      ],

      keyBindings: {
      'ctrl+shift+m': '_insertMathTex'
      },

      properties: {
        boundKeys: {
          type: Array,
          value: function() {
            return Object.keys(this.keyBindings).join(' ').split(' ');
          }
        },
        keyEventTarget: {
          type: Object,
          value: function() {
            return document.body;
          }
        }
      },

      ready: function(){
        var input_choices = this.$.input_choices_area
        Sortable.create(input_choices, {
          group: {
            name: 'grouped',
            pull: 'clone',
            put: false
          },
          sort: false,
          handle: '.handle'
        });
        var desired_questions_inputs = this.$.desired_questions_inputs_area
        Sortable.create(desired_questions_inputs, {
          group: {
            name: 'grouped',
            put: 'input_choices'
          },
          handle: '.handle',
          filter: '.js-remove',
          onFilter: function (e) {
            desired_questions_inputs.removeChild(e.item.parentNode);
          }
        });
        //this.createCanvasOverlay('','question_preview_area');
      },

      readImage: function(input,after_index){
        var self = this;

        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function (e) {
              var after_node = Polymer.dom(self.$.question_preview_area).childNodes[after_index];
              var image_element = document.createElement('img');
              image_element.className="self-center preview_mode"
              image_element.src = e.target.result;
              Polymer.dom(self.$.question_preview_area).insertBefore(image_element,after_node);
            };

            reader.readAsDataURL(input.files[0]);
        }
      },

      showFormContents: function(e){
        Polymer.dom(this.$.question_preview_area).innerHTML='';
        var whoa = this.$.math_question_adder_form.serialize();
        var whoa_array = Polymer.dom(this.$.desired_questions_inputs_area).querySelectorAll('.in_value');

        for(var i =0; i<whoa_array.length;i++){
          console.log(whoa_array[i].getAttribute('data-inputtype'));
          switch(whoa_array[i].getAttribute('data-inputtype')){
            case 'Display Equation':
              var mtel = document.createElement('math-tex');
              mtel.className="self-center display-equation preview_mode"
              mtel.textContent = whoa_array[i].value;
              Polymer.dom(this.$.question_preview_area).appendChild(mtel);
              break;
            case 'Question Text':
              var qtel = document.createElement('p');
              qtel.style.wordWrap = "break-word";
              qtel.className="preview_mode";
              qtel.innerHTML = whoa_array[i].value;
              Polymer.dom(this.$.question_preview_area).appendChild(qtel);
              break;
            case 'Question Image':
              var input = whoa_array[i];
              this.readImage(input,i);
              break;
            case 'Answer Choices':
              var acel = document.createElement('ol');
              acel.type = 'A';
              var choice_array = whoa_array[i].querySelectorAll('paper-input');
              for(var j=0; j<choice_array.length; j++){
                var next_choice = document.createElement('li');
                next_choice.innerHTML = choice_array[j].value;
                acel.appendChild(next_choice);
              }
              Polymer.dom(this.$.question_preview_area).appendChild(acel);
              break;
          }
        }
        //this.createCanvasOverlay('','question_preview_area');
      },

      _insertMathTex: function(e){
        console.log(e.detail);
        console.log(this.keyEventTarget);
      },

      sayHi: function(e){
        console.log(e.target);
        this.keyEventTarget=e.target;
      }

      /*createCanvasOverlay: function(color, canvasContainer){
            myCanvas = document.createElement('canvas');
            var superContainer = this.$[canvasContainer];
            myCanvas.style.width = '300px';
            myCanvas.style.height = '420px';
            myCanvas.style.zIndex = 1000;
            // You must set this otherwise the canvas will be stretched to fit the container
            myCanvas.width = 300;
            myCanvas.height = 420;
            myCanvas.style.overflow = 'visible';
            myCanvas.style.position = 'relative';
            myCanvas.style.top = '0px';
            myCanvas.style.left = '0px';
            myCanvas.style.display = 'block';

            var context=myCanvas.getContext('2d');
            superContainer.appendChild(myCanvas);

      },

      onMouseMoveOnMyCanvas: function(event){
        var myCanvas = Polymer.dom(this.$.question_preview_area).querySelector('canvas');

        if (myCanvas.drawing){
          var mouseX= event.layerX;
          var mouseY=event.layerY;

          var context = myCanvas.getContext("2d");
          if (myCanvas.pathBegun==false)
          {
            context.beginPath();
            myCanvas.pathBegun=true;
          }
          else
          {
            context.lineTo(mouseX, mouseY);
            context.stroke();
          }
        }
      },

      onMouseClickOnMyCanvas: function(event){
        var myCanvas = Polymer.dom(this.$.question_preview_area).querySelector('canvas');
        console.log(event);
        myCanvas.drawing=!myCanvas.drawing;
        // reset the path when starting over
        if (myCanvas.drawing)
          myCanvas.pathBegun=false;
      }*/
    });
  </script>
</dom-module>