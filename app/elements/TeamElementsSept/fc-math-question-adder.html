<!-- <script src="../../bower_components/math-tex/mathjax-loader.js"></script>
<script src="../../bower_components/math-tex/math-tex.js"></script> -->

<dom-module id="fc-math-question-adder">
  <template>
    <style>
      #main_question_toolbar {
        background-color: white;
      }
      #main_question_toolbar *{
        padding: 10px;
      }
      #main_question_toolbar paper-input {
        width: 100px;
      }
      #input_choices_box,#desired_questions_inputs_box,#question_preview_box {
        margin: 15px;
        min-height:50px;
      }
      .addable_input {
        border: 1px solid black;
        padding: 5px;
      }
      #input_choices_area .js-remove {
        -webkit-transition: opacity .2s;
        transition: opacity .2s;
        opacity: 0;
        display: none;
        cursor: pointer;
        color: #c00;
        position: relative;
        font-style: normal;
      }
      #input_choices_area .handle {
        -webkit-transition: opacity .2s;
        transition: opacity .2s;
        opacity: 0;
        display: block;
        cursor: pointer;
        position: relative;
        font-style: normal;
      }
      #input_choices_area div:hover .handle {
        opacity: 1;
      }
      #input_choices_area paper-input paper-icon-button {
        display: none;
      }
      #question_instructions_area {
        border-top: 1px solid black;
        border-left: 1px solid black;
        border-right: 1px solid black;
        border-bottom: 1px solid rgba(186, 185, 185, .5);
        background: rgba(63, 81, 181, .5);
        padding: 0px 10px 10px 10px;
      }
      #question_instructions_area>paper-input-container{
        background: white;
        padding: 8px 5px 8px 5px;
      }
      #question_tagging_area {
        border-top: 1px solid black;
        border-left: 1px solid black;
        border-right: 1px solid black;
        border-bottom: 1px solid white;
        padding: 10px;
      }
      #desired_questions_inputs_area {
        min-width: 100px;
        min-height: 100px;
        padding-bottom: 10px;
        border: 1px solid black;
      }
      #desired_questions_inputs_area .js-remove {
        -webkit-transition: opacity .2s;
        transition: opacity .2s;
        opacity: 0;
        display: block;
        cursor: pointer;
        color: #c00;
        position: relative;
        font-style: normal;
      }
      #desired_questions_inputs_area .handle {
        -webkit-transition: opacity .2s;
        transition: opacity .2s;
        opacity: 0;
        display: block;
        cursor: pointer;
        position: relative;
        font-style: normal;
      }
      #desired_questions_inputs_area div:hover .handle{
        opacity: 1;
      }
      #desired_questions_inputs_area div:hover .js-remove{
        opacity: 1;
      }
      #question_preview_area {
        width: 300px;
        height: 420px;
        border: 1px solid gray;
        padding: 5px 5px 5px 5px;
        z-index: 0;
        overflow-y: scroll;
      }
      #question_preview_area *:not(math-tex) {
        margin: 6px 0px 6px 0px;
      }
      #question_preview_area li,p {
        word-wrap: break-word;
        font-family: STIX-Web;
        font-size: 1em;
      }
      #question_preview_area p[data-correct=true],li[data-correct=true] {
        padding: 5px;
        background: rgba(77, 255, 136, .75);
      }
      #question_preview_area *:not(math-tex)+math-tex {
        margin-top: 6px;
      }
      #question_preview_area math-tex+*:not(math-tex) {
        margin-top: 12px;
        margin-bottom: 6px;
      }
       #question_preview_area math-tex.display-equation+math-tex.display-equation {
        margin-top: 0px;
      }
      #question_tag_preview_area {
        border-top: 1px solid black;
        border-left: 1px solid black;
        border-right: 1px solid black;
        border-bottom: 1px solid rgba(186, 185, 185, .5);
        background: rgba(63, 81, 181, .5);
        padding: 10px 5px 10px 5px;
        width: 300px;
      }
      #question_tag_preview_area .js-remove {
        -webkit-transition: opacity .2s;
        transition: opacity .2s;
        opacity: 0;
        display: block;
        cursor: pointer;
        color: #c00;
        position: relative;
        font-style: normal;
      }
      #question_tag_preview_area div{
        margin: 2px;
        border-radius: 4px;
        font-size: 10px;
        height: 16px;
      }
      #question_tag_preview_area div:hover .js-remove {
        opacity: 1;
      }
      paper-button {
        background: var(--default-primary-color);
        color: white;
      }
      #save_button {
        background: green;
      }
      paper-toolbar {
        border-top: 1px solid black;
        border-left: 1px solid black;
        border-right: 1px solid black;
      }
      paper-input paper-icon-button {
        opacity: 0;
        border-radius: 50%;
      }
      paper-input:hover paper-icon-button {
        opacity: 1;
      }
      paper-input[data-correct=true] paper-icon-button {
          opacity: 1;
          color: white;
          background: green;
          margin-right: 5px;
      }
    </style>

    <firebase-document id="questions_loc" data="{{all_questions}}" location="https://amber-inferno-3827.firebaseio.com/questions"></firebase-document>
    <firebase-collection id="question_tags_loc" data="{{question_tags}}" location="https://focusedstaging1.firebaseio.com/Question Tags"></firebase-collection>
    <paper-material id="main_question_toolbar" class="flex horizontal center layout">
        <paper-toggle-button checked='{{specificTestTrue}}'>For A Specific Test?</paper-toggle-button>
        <!-- <form is="iron-form" id="specific_test_input_area" action="/"> -->
          <paper-dropdown-menu name="Test Name" always-float-label label="Test" value="{{specificTest}}" disabled='{{!specificTestTrue}}'>
            <paper-menu id="locationListMenu" class="dropdown-content" attr-for-selected="value" selected="{{selectedTest}}">
              <paper-item value="SAT (1600) - Test 1">SAT (1600) - Test 1</paper-item>
              <paper-item value="SAT (1600) - Test 2">SAT (1600) - Test 2</paper-item>
              <paper-item value="SAT (1600) - Test 3">SAT (1600) - Test 3</paper-item>
              <paper-item value="SAT (1600) - Test 4">SAT (1600) - Test 4</paper-item>
            </paper-menu>
          </paper-dropdown-menu>
          <paper-dropdown-menu name="Section" always-float-label label="Section" value="{{specificSection}}" disabled='{{!specificTestTrue}}'>
            <paper-menu id="locationListMenu" class="dropdown-content" attr-for-selected="value" selected="{{selectedSection}}">
              <paper-item value="Section 1 - Reading">Section 1 - Reading</paper-item>
              <paper-item value="Section 2 - Writing">Section 2 - Writing</paper-item>
              <paper-item value="Section 3 - Math (No Calculator)">Section 3 - Math (No Calculator)</paper-item>
              <paper-item value="Section 4 - Math (Calculator)">Section 4 - Math (Calculator)</paper-item>
            </paper-menu>
          </paper-dropdown-menu>
          <paper-input name="Question Number" always-float-label label="Question Number" value="{{specificQuestion}}" disabled='{{!specificTestTrue}}' auto-validate pattern="\d{1,2}"></paper-input>
        <!-- </form> -->
        <paper-button id="preview_button" raised on-tap="showFormContents">Preview Question</paper-button>
        <paper-button id="save_button" raised on-tap="saveQuestion">Save Question</paper-button>
    </paper-material>

    <div class="horizontal layout">

      <div id="input_choices_box" class="flex-1">
        <paper-toolbar><div>Drag Question Elements to Center Area</div></paper-toolbar>
        <div id="input_choices_area">
          <div class="horizontal layout center addable_input"><iron-icon class="handle" icon="hardware:gamepad"></iron-icon><paper-input class="in_value flex"  data-inputtype="Display Equation" label="Display Equation"></paper-input><iron-icon class="js-remove" icon="clear"></iron-icon></div>

          <div class="horizontal layout center addable_input"><iron-icon class="handle" icon="hardware:gamepad"></iron-icon>
            <fc-image-upload raised class="in_value flex" data-inputtype="Question Image">Add Display Image</fc-image-upload>
            <iron-icon class="js-remove" icon="clear"></iron-icon>
          </div>

          <div class="horizontal layout center addable_input"><iron-icon class="handle" icon="hardware:gamepad"></iron-icon><paper-textarea class="in_value flex" data-inputtype="Question Text" label="Question Text" ></paper-textarea><iron-icon class="js-remove" icon="clear"></iron-icon></div>

          <div class="horizontal layout center addable_input"><iron-icon class="handle" icon="hardware:gamepad"></iron-icon>
            <div class="in_value flex" data-inputtype="Answer Choices">
              <paper-input label="A" >
                <paper-icon-button prefix icon="check" on-tap="markAsCorrect" tabindex="-1"></paper-icon-button>
              </paper-input>
              <paper-input label="B" >
                <paper-icon-button prefix icon="check" on-tap="markAsCorrect" tabindex="-1"></paper-icon-button>
              </paper-input>
              <paper-input label="C" >
                <paper-icon-button prefix icon="check" on-tap="markAsCorrect" tabindex="-1"></paper-icon-button>
              </paper-input>
              <paper-input label="D" >
                <paper-icon-button prefix icon="check" on-tap="markAsCorrect" tabindex="-1"></paper-icon-button>
              </paper-input>
            </div>
            <iron-icon class="js-remove" icon="clear"></iron-icon>
          </div>

          <div class="horizontal layout center addable_input"><iron-icon class="handle" icon="hardware:gamepad"></iron-icon>
            <fc-image-answer-choice-upload raised multi answer-choices class="in_value flex" data-inputtype="Answer Choice Images">Add 4 Answer Images</fc-image-answer-choice-upload>
            <iron-icon class="js-remove" icon="clear"></iron-icon>
          </div>

          <div class="horizontal layout center addable_input"><iron-icon class="handle" icon="hardware:gamepad"></iron-icon><paper-input class="in_value flex"  data-inputtype="Free Response Answer" label="Free Response Answer"></paper-input><iron-icon class="js-remove" icon="clear"></iron-icon></div>
        </div>
      </div>

      <!-- <div "question_input_area" class="flex-2">
        <form is="iron-form" id="math_question_adder_form" on-iron-submit> -->
      <div id="desired_questions_inputs_box" class="flex-2">
        <paper-toolbar><div>Drag Question Elements Here to Make Question</div></paper-toolbar>
        <div id="question_instructions_area">
          <ul>
            <li>Ctrl+Shift+m to add math type tags</li>
            <li>Math-tex tags are not necessary in display equations</li>
            <li>Click the check mark to mark an answer as correct</li>
          </ul>
          <paper-input-container style="background:white">
            <label for="question_tag_input">Add Question Tags</label>
            <input name="question_tag_input" id="tag_input_area" is="iron-input" type="text" list="question_tags_datalist" autocomplete="on" list="question_tags_datalist" always-float-label label="Add Question Tags" on-focus="_startQuestionTagging" on-blur="_stopQuestionTagging"></input>
          </paper-input-container>
        </div>
        <div id="desired_questions_inputs_area">
        </div>
      </div>

      <datalist id="question_tags_datalist">
        <template is="dom-repeat" items="{{question_tags}}" sort="_sortTags">
          <option value="{{item.value}}"></option>
        </template>
      </datalist>
        <!-- </form>
      </div> -->

      <!--<div id="question_preview_area" class="vertical layout" on-mousedown="onMouseClickOnMyCanvas" on-mousemove="onMouseMoveOnMyCanvas">-->
      <div id="question_preview_box">
        <paper-toolbar><div>Question Preview</div></paper-toolbar>
        <div id="question_tag_preview_area" class="horizontal layout wrap"></div>
        <div id="question_preview_area" class="vertical layout">
        </div>
      </div>

    </div>
       <p>kjashkh akjhkajh ehoiwoiu owieuoid \(45x^2\) khakhiuehiuwhkjhkhsd ohkjahk</p>
  </template>
  <script>
    Polymer({
      is: 'fc-math-question-adder',

      behaviors: [
        Polymer.IronA11yKeysBehavior
      ],

      keyBindings: {
      'ctrl+shift+m': '_insertMathTex',
      'enter': '_addQuestionTag'
      },

      properties: {
        availableQuestionTags: {
          type: Array,
          value: function(){
            return [];
          }
        },
        all_questions: {
          type: Object,
          value: {},
          notify: true
        },
        boundKeys: {
          type: Array,
          value: function() {
            return Object.keys(this.keyBindings).join(' ').split(' ');
          }
        },
        keyEventTarget: {
          type: Object,
          value: function() {
            return this;
          }
        }
      },

      ready: function(){
        var self = this;

        var input_choices = self.$.input_choices_area;
        Sortable.create(input_choices, {
          group: {
            name: 'grouped',
            pull: 'clone',
            put: false
          },
          sort: false,
          handle: '.handle'
        });
        var desired_questions_inputs = self.$.desired_questions_inputs_area;
        Sortable.create(desired_questions_inputs, {
          group: {
            name: 'grouped',
            put: 'input_choices'
          },
          handle: '.handle',
          filter: '.js-remove',
          onFilter: function (e) {
            desired_questions_inputs.removeChild(e.item.parentNode);
          },
          onAdd: function(e) {
            var all_checkmarks = e.item.querySelectorAll("paper-icon-button[icon=check]");
            for(var i = 0; i < all_checkmarks.length; i++){
              all_checkmarks[i].addEventListener('tap',function(e){
                self.markAsCorrect(e);
              });
            }
                    var crap = self.$.input_choices_area.querySelector('fc-image-answer-choice-upload');
          crap.clear();
          }
        });
        var applied_questions_tags = self.$.question_tag_preview_area;
        Sortable.create(applied_questions_tags, {
          sort: false,
          filter: '.js-remove',
          onFilter: function (e) {
            applied_questions_tags.removeChild(e.item);
          }
        });
      },

      readImage: function(input,after_index,multiple){
        var self = this;

        if (input.files && input.files[0] && multiple == false) {
            var filename = input.files[0].name;
            var reader = new FileReader();
            reader.onload = function (e) {
              var after_node = Polymer.dom(self.$.question_preview_area).childNodes[after_index];
              var image_element = document.createElement('img');
              image_element.className="self-center preview_mode"
              image_element.src = e.target.result;
              image_element.style.width = '275px';
              image_element.setAttribute('data-questionpart', "Display Image");
              image_element.setAttribute('data-filepath', "Math Images/" + filename);
              Polymer.dom(self.$.question_preview_area).insertBefore(image_element,after_node);
            };
            reader.readAsDataURL(input.files[0]);

        } else if (input.files && input.files[0] && multiple == true) {

          var after_node = Polymer.dom(self.$.question_preview_area).childNodes[after_index];
          var image_ol = document.createElement('ol');
          image_ol.type = 'A';
          Polymer.dom(self.$.question_preview_area).appendChild(image_ol);

          for (var i = 0; i < input.files.length; i++) {
            (function(file,index) {
                var filename = file.name;
                var reader = new FileReader();
                reader.onload = function(e) {
                  var image_element_li = document.createElement('li');
                  image_element_li.setAttribute('data-correct', file.correct);
                  var image_element = document.createElement('img');
                  image_element.className="self-center preview_mode"
                  image_element.src = e.target.result;
                  image_element.style.width = '100px';
                  image_element.align = 'top';
                  image_element_li.appendChild(image_element);
                  image_element_li.setAttribute('data-questionpart','Answer Choice Image');
                  image_element_li.setAttribute('data-filepath', "Math Images/" + filename);
                  image_ol.insertBefore(image_element_li,image_ol.childNodes[index]);
                }
                reader.readAsDataURL(file);
            })(input.files[i],i);
          }
        }
      },

      showFormContents: function(e){
        Polymer.dom(this.$.question_preview_area).innerHTML='';
        var desired_question_elements_array = Polymer.dom(this.$.desired_questions_inputs_area).querySelectorAll('.in_value');

        for(var i =0; i<desired_question_elements_array.length;i++){
          switch(desired_question_elements_array[i].getAttribute('data-inputtype')){
            case 'Display Equation':
              var mtel = document.createElement('math-tex');
              mtel.className="self-center display-equation preview_mode"
              mtel.setAttribute('data-questionpart','Display Equation');
              mtel.textContent = desired_question_elements_array[i].value;
              Polymer.dom(this.$.question_preview_area).appendChild(mtel);
              break;
            case 'Question Text':
              var qtel = document.createElement('p');
              qtel.style.wordWrap = "break-word";
              qtel.className="preview_mode";
              qtel.setAttribute('data-questionpart','Question Text');
              qtel.innerHTML = desired_question_elements_array[i].value;
              Polymer.dom(this.$.question_preview_area).appendChild(qtel);
              break;
            case 'Question Image':
              var input = desired_question_elements_array[i];
              this.readImage(input,i,false);
              break;
            case 'Answer Choices':
              var acel = document.createElement('ol');
              acel.type = 'A';
              var choice_array = desired_question_elements_array[i].querySelectorAll('paper-input');
              for(var j=0; j<choice_array.length; j++){
                var answer_choice_li = document.createElement('li');
                answer_choice_li.setAttribute('data-correct', choice_array[j].getAttribute('data-correct'));
                answer_choice_li.setAttribute('data-questionpart','Answer Choice');
                answer_choice_li.innerHTML = choice_array[j].value;
                acel.appendChild(answer_choice_li);
              }
              Polymer.dom(this.$.question_preview_area).appendChild(acel);
              break;
            case 'Answer Choice Images':
              var input = desired_question_elements_array[i];
              this.readImage(input,i,true);
              break;
            case 'Free Response Answer':
              var frel = document.createElement('p');
              frel.style.wordWrap = "break-word";
              frel.className="preview_mode";
              frel.setAttribute('data-questionpart','Free Response Answer');
              frel.setAttribute('data-correct', true);
              frel.innerHTML = desired_question_elements_array[i].value;
              Polymer.dom(this.$.question_preview_area).appendChild(frel);
              break;
          }
        }
      },

      _insertMathTex: function(e){
        var current_typing_area = e.detail.keyboardEvent.path[0];
        var current_typing_area_start = current_typing_area.selectionStart;
        var current_typing_area_end = current_typing_area.selectionEnd;
        current_typing_area.value = current_typing_area.value.substring(0, current_typing_area_start)
            + '<math-tex>' + current_typing_area.value.substring(current_typing_area_start, current_typing_area_end) + '</math-tex>'
            + current_typing_area.value.substring(current_typing_area_end, current_typing_area.value.length);
        current_typing_area.setSelectionRange(current_typing_area_end+10,current_typing_area_end+10);
      },

      _addQuestionTag: function(e){
        if(this.keyEventTarget.id = 'tag_input_area' && this.keyEventTarget.value.length > 0){
          var qtel = document.createElement('div');
          qtel.className = "horizontal layout center addable_input";
          qtel.innerText = this.keyEventTarget.value;
          if(!this.question_tags.some(single_tag => single_tag.value == this.keyEventTarget.value)){
            this.push('question_tags',this.keyEventTarget.value);
          }
          var icel = document.createElement('iron-icon');
          icel.className = "js-remove";
          icel.icon = "clear";
          qtel.appendChild(icel);
          Polymer.dom(this.$.question_tag_preview_area).appendChild(qtel);
          this.keyEventTarget.value = '';
        }
      },

      _sortTags: function(a_tag, b_tag){
        return a_tag.value < b_tag.value ? -1 : 1;
      },

      _startQuestionTagging: function(e){
        this.keyEventTarget = e.path[0];
      },

      _stopQuestionTagging: function(e){
        this.keyEventTarget = this;
      },

      markAsCorrect: function(e){
        var correct_choice = e.path[0].domHost.parentNode;
        var all_choices_holder = correct_choice.parentNode;
        var all_choices = all_choices_holder.querySelectorAll('paper-input');

        for(var i = 0; i < all_choices.length; i++){
          if (all_choices[i].label == correct_choice.label){
            all_choices[i].setAttribute('data-correct',true);
          } else {
            all_choices[i].setAttribute('data-correct',false);
          }
        }
      },

      saveQuestion: function(){
        var this_question_parts = Polymer.dom(this.$.question_preview_area).childNodes;
        var this_question_tags = Polymer.dom(this.$.question_tag_preview_area).childNodes;
        var this_question_obj = {};

        if(this.specificTestTrue == true){
          this_question_obj['Test'] = this.specificTest;
          this_question_obj['Section'] = this.specificSection;
          this_question_obj['Question'] = this.specificQuestion;
        }

        for(var i = 0; i < this_question_parts.length; i++){
          if(this_question_parts[i].nodeName == 'OL'){
            this_question_obj['Answer Choices'] = {
              'order' : i + 1
            };
            for(var j = 0; j < this_question_parts[i].childNodes.length; j++){
              var choice_letter = String.fromCharCode(65 + j);
              this_question_obj["Answer Choices"][choice_letter] = {
                'correct' : this_question_parts[i].childNodes[j].getAttribute('data-correct')
              };
              if (this_question_parts[i].childNodes[j].getAttribute('data-correct') == "true") {
                this_question_obj['Correct Answer'] = choice_letter;
              }
              this_question_obj["Answer Choices"][choice_letter].value = this_question_parts[i].childNodes[j].getAttribute('data-filepath') != null ? this_question_parts[i].childNodes[j].getAttribute('data-filepath') : this_question_parts[i].childNodes[j].innerHTML;
            }
          } else if(this_question_parts[i].dataset.questionpart != null) {
            if(this_question_parts[i].dataset.questionpart == "Display Image"){
              this_question_obj[this_question_parts[i].dataset.questionpart] = {
                'order' : i + 1,
                'value' : this_question_parts[i].getAttribute('data-filepath')
              };
            } else {
              this_question_obj[this_question_parts[i].dataset.questionpart] = {
                'order' : i + 1,
                'value' : this_question_parts[i].innerHTML
              };
            }
          }
        }
        this_question_obj['Question Tags'] = {};
        for(var i = 0; i < this_question_tags.length; i++){
          this_question_obj['Question Tags'][this_question_tags[i].innerText.substring(0,this_question_tags[i].innerText.length-1)] = true;
        }
        if(this.specificTestTrue == true){
          var this_question_name = "T" + this.specificTest.match(/\d+/g)[1].toString() + "S" + this.specificSection.match(/\d+/g)[0].toString() + "Q" + this.specificQuestion.toString();
          this.$.questions_loc._setRemoteDocumentChild(this_question_name, this_question_obj);
          this.$.desired_questions_inputs_area.innerHTML = '';
          this.$.question_tag_preview_area.innerHTML = '';
          var crap = parseInt(this.specificQuestion) + 1;
          this.specificQuestion = crap < 10 ? '0' + crap.toString() : crap.toString();
        }

      }

//**********************************************************************************
// ALL OF THIS WAS JUST CANVAS DRAWING STUFF
      // _toArray: function(obj) {
      //       return Object.keys(obj).map(function(key) {
      //           return {
      //               name: key,
      //               value: obj[key]
      //           };
      //       });
      // }
      /*createCanvasOverlay: function(color, canvasContainer){
            myCanvas = document.createElement('canvas');
            var superContainer = this.$[canvasContainer];
            myCanvas.style.width = '300px';
            myCanvas.style.height = '420px';
            myCanvas.style.zIndex = 1000;
            // You must set this otherwise the canvas will be stretched to fit the container
            myCanvas.width = 300;
            myCanvas.height = 420;
            myCanvas.style.overflow = 'visible';
            myCanvas.style.position = 'relative';
            myCanvas.style.top = '0px';
            myCanvas.style.left = '0px';
            myCanvas.style.display = 'block';

            var context=myCanvas.getContext('2d');
            superContainer.appendChild(myCanvas);

      },

      onMouseMoveOnMyCanvas: function(event){
        var myCanvas = Polymer.dom(this.$.question_preview_area).querySelector('canvas');

        if (myCanvas.drawing){
          var mouseX= event.layerX;
          var mouseY=event.layerY;

          var context = myCanvas.getContext("2d");
          if (myCanvas.pathBegun==false)
          {
            context.beginPath();
            myCanvas.pathBegun=true;
          }
          else
          {
            context.lineTo(mouseX, mouseY);
            context.stroke();
          }
        }
      },

      onMouseClickOnMyCanvas: function(event){
        var myCanvas = Polymer.dom(this.$.question_preview_area).querySelector('canvas');
        console.log(event);
        myCanvas.drawing=!myCanvas.drawing;
        // reset the path when starting over
        if (myCanvas.drawing)
          myCanvas.pathBegun=false;
      }*/
    });
  </script>
</dom-module>