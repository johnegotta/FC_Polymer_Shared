<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-progress/paper-progress.html">
<link rel="import" href="../iron-icons/iron-icons.html">

<dom-module id="fc-image-upload">

  <style type="text/css">
    .enabled {
      border: 1px dashed #555;
    }

    .hover {
      opacity: .7;
      border: 1px dashed #111;
    }

    #UploadBorder{
      vertical-align: middle;
      color: #555;
      padding: 20px;
      max-height: 300px;
      overflow-y: auto;
      display: inline-block;
    }

    #dropArea {
      text-align: center;
    }

    paper-button {
      background: var(--default-primary-color);
      color: white;
    }

    .file {
      padding: 10px 0px;
    }

    .commands {
      float: right;
    }

    .commands iron-icon:not([icon="check-circle"]) {
      cursor: pointer;
      opacity: .9;
    }

    .commands iron-icon:hover {
      opacity: 1;
    }

    [hidden] {
      display: none;
    }

    .error {
      color: #f40303;
      font-size: 11px;
      margin: 2px 0px -3px;
    }

    paper-progress {
      --paper-progress-active-color: #03a9f4;
    }

    paper-progress[error] {
      --paper-progress-active-color: #f40303;
    }
  </style>

  <template>
    <div>
      <paper-button id="button" icon="file-upload" class="blue" on-click="_fileClick">
        <iron-icon icon="input"></iron-icon>
        <content></content>
      </paper-button>
      <div id='UploadBorder'>
        <div id="dropArea" hidden$="{{_hiddenDropText}}">{{dropText}}</div>
        <template is="dom-repeat" items="{{files}}">
          <div class="file">
            <div class="name">
              <span>{{item.name}}</span>
              <div class="commands">
                <iron-icon icon="cancel" title="Remove" on-click="_cancelUpload" hidden$="{{item.complete}}"></iron-icon>
              </div>
            </div>
          </div>
        </template>
      </div>
    </div>
    <input type="file" id="fileInput" on-change="_fileChange" hidden multiple="{{multi}}" accept=".png, .jpg, .jpeg, .svg, .pdf">
  </template>
  <script>

    Polymer({

      is: 'fc-image-upload',

       /**
        * Fired when a response is received status code 200.
        *
        * @event success
      */
       /**
        * Fired when a response is received other status code.
        *
        * @event error
      */

      properties: {
        /**
         * `droppable` indicates whether or not to allow file drop.
        */
        droppable: {
          type: Boolean,
          value: false
        },

        /**
         * `dropText` is the  text to display in the file drop area.
        */
        dropText: {
          type: String,
          value: "Drop Image Files Here"
        },

        /**
         * `multi` indicates whether or not to allow multiple files to be uploaded.
        */
        multi: {
          type: Boolean,
          value: true
        },

        /**
         * `files` is the list of files to be uploaded
        */
        files: {
          type: Array,
          value: [],
          notify: true
        },

        raised: {
          type: Boolean,
          value: false
        },

        /**
         * `noink` indicates that the button should not have an ink effect
        */
        noink: {
          type: Boolean,
          value: false
        },

        /**
         * `_hiddenDropText` indicates whether or not the drop text should be shown
        */
        _hiddenDropText: {
          type: Boolean,
          value: true
        },

        /**
         * `headers` is a key value map of header names and values
        */
        headers: {
          type: Object,
          value: {},
        }
      },

      /**
       * Clears the list of files
      */
      clear: function() {
        this.set("files", []);
        this._showDropText();
      },

      ready: function() {
        if (this.raised) {
          this.toggleAttribute("raised", true, this.$.button);
        }
        if (this.noink) {
          this.toggleAttribute("noink", true, this.$.button);
        }
        if (this.droppable) {
          this._showDropText();
          this.setupDrop();
        }
      },

      /**
       * A function to set up a drop area for drag-and-drop file uploads
      */
      setupDrop: function() {
        var uploadBorder = this.$.UploadBorder;
        this.toggleClass("enabled", true, uploadBorder);

        this.ondragover = function(e) {
          e.stopPropagation();
          this.toggleClass("hover", true, uploadBorder);
          return false;
        }

        this.ondragleave = function() {
          this.toggleClass("hover", false, uploadBorder);
          return false;
        }

        this.ondrop = function(event) {
          this.toggleClass("hover", false, uploadBorder);
          event.preventDefault();
          var length = event.dataTransfer.files.length;
          for (var i = 0; i < length; i++) {
            var file = event.dataTransfer.files[i];
            file.progress = 0;
            file.error = false;
            file.complete = false;
            this.push("files", file);
            //this.uploadFile(file);
          }
        }
      },

      /**
       * Clicks the invisible file input
      */
      _fileClick: function() {
        var elem = this.$.fileInput;
        if (elem && document.createEvent) { // sanity check
          var evt = document.createEvent("MouseEvents");
          evt.initEvent("click", true, false);
          elem.dispatchEvent(evt);
        }
      },

      /**
       * Called whenever the list of selected files changes
      */
      _fileChange: function(e) {
        var length = e.target.files.length;
        for (var i = 0; i < length; i++) {
          var file = e.target.files[i];
          file.progress = 0;
          file.error = false;
          file.complete = false;
          this.push("files", file);
          //this.uploadFile(file);
        }
      },

      /**
       * Cancels the file upload for a specific file
       *
       * @param {object} a file, an element of the files array
      */
      cancel: function(file) {
        if (file) {
          this.splice("files", this.files.indexOf(file), 1);
          this._showDropText();
        }
      },

      /**
       * Cancels the file upload
       *
       * @param {object}, an event object
      */
      _cancelUpload: function(e) {
        this.cancel(e.model.__data__.item);
      },

      /**
       * Retries to upload the file
       *
       * @param {object}, an event object
      */
      _retryUpload: function(e) {
        e.model.set("item.error", false);
        e.model.set("item.progress", 0);
        // The async helps give visual feedback of a retry occurring, even though it's less efficient.
        var self = this;
        this.async(function() {
          self.uploadFile(e.model.__data__.item);
        }, 50);
      },

      /**
       * Whether or not to display the drop text
      */
      _showDropText: function() {
        this.set("_hiddenDropText", !(!this.files.length && this.droppable));
      }
    });

  </script>
</dom-module>