<dom-module id="fc-class-creator">
  <style>
    .menuContainer{
      margin-left: 5px;
      margin-right: 5px;
      margin-bottom: 5px;
      border: 1px solid black;
      border-radius: 5px;
      align: center;
      text-align: center;
      max-height: 400px;
      overflow-y: scroll;
      width: 230px;
    }
    #classCreationFormContainer h1, h4, paper-input{
      margin: 5px;
    }
    paper-dropdown-menu > paper-menu {
      background: white;
    }
    paper-menu {
      background: none;
    }
    paper-menu > paper-item {
      -webkit-box-shadow: inset 0px -20px 56px -26px rgba(122,122,122,0.48);
      -moz-box-shadow: inset 0px -20px 56px -26px rgba(122,122,122,0.48);
      box-shadow: inset 0px -20px 56px -26px rgba(122,122,122,0.48);
    }
    paper-menu > .iron-selected {
      font-weight: 300;
      color: #002593;
      background: #A9E9FF;
      -webkit-box-shadow: inset 0px -20px 89px -26px rgba(0,37,147,1);
      -moz-box-shadow: inset 0px -20px 89px -26px rgba(0,37,147,1);
      box-shadow: inset 0px -20px 89px -26px rgba(0,37,147,1);
    }
    paper-button {
      margin: 5px;
    }

  </style>
  <template>
    <custom-validator id="teacherValid" validator-name="teacherValidator"></custom-validator>
    <custom-validator id="practiceTestDayValid" validator-name="practiceTestDayValidator"></custom-validator>
    <custom-validator id="classDaysValid" validator-name="classDaysValidator"></custom-validator>
    <custom-validator id="startDateValid" validator-name="startDateValidator"></custom-validator>
    <paper-material class="vertical layout center">
      <h1>Create New Class</h1>
      <form is="iron-form" id="classCreationForm" action="/" method="post">
        <div id="classCreationFormContainer" class="horizontal layout wrap">

          <div class="menuContainer">
            <paper-dropdown-menu name="formLocation" always-float-label label="Location" auto-validate required on-iron-select="showCorrectTeachers">
              <paper-menu id="locationListMenu" class="dropdown-content" attr-for-selected="value" selected="{{selectedLocation}}">
                <template is="dom-repeat" items="{{locationList}}">
                  <paper-item value="{{item.firebaseKey}}">{{item.Nickname}}</paper-item>
                </template>
              </paper-menu>
            </paper-dropdown-menu>

            <h4 id="teacherMenuHeader">Teacher(s)</h4>
            <paper-menu name="formTeacher" id="teacherListMenu" multi required attr-for-selected="value" selected-values="{{selectedTeachers}}">
              <template is="dom-repeat" items="{{teacherList}}">
                <paper-item value="{{item.firebaseKey}}"><p><span>{{item.First Name}}</span> <span>{{item.Last Name}}</span></p></paper-item>
              </template>
            </paper-menu>
            <paper-input is="iron-input" name="formTeacher" hidden required value="[[selectedTeachers]]" validator="teacherValidator" auto-validate></paper-input>
          </div>

          <div class="vertical layout menuContainer">
            <paper-input type="time" name="formStartTime" value="{{selectedStartTime}}" required auto-validate always-float-label label="Class Start Time"></paper-input>
            <paper-input type="time" name="formEndTime" value="{{selectedEndTime}}" required auto-validate always-float-label label="Class End Time"></paper-input>
            <paper-input id="startDateInput" type="date" name="formStartDate" required always-float-label label="Pretest Date" value="{{selectedStartDate}}" validator="startDateValidator"></paper-input>
            <paper-input id="endDateInput" type="date" name="formEndDate" required always-float-label label="Real SAT Date" value="{{selectedEndDate}}" validator="startDateValidator"></paper-input>
          </div>

          <div class="menuContainer">
            <h4 id="practiceTestDayMenuHeader">Practice Test Day</h4>
            <paper-menu id="PracticeTestDayListMenu" class="dropdown-content" attr-for-selected="value" selected="{{selectedPracticeTestDay}}">
              <paper-item value="Saturday">Saturday</paper-item>
              <paper-item value="Sunday">Sunday</paper-item>
            </paper-menu>
            <paper-input is="iron-input" name="formPracticeTestDay" hidden required value="[[selectedPracticeTestDay]]" validator="practiceTestDayValidator" auto-validate></paper-input>

            <h4 id="classDaysMenuHeader">Class Days</h4>
            <paper-menu id="ClassDaysListMenu" class="dropdown-content" multi attr-for-selected="value" selected-values="{{selectedClassDays}}">
              <paper-item value="Monday">Monday</paper-item>
              <paper-item value="Tuesday">Tuesday</paper-item>
              <paper-item value="Wednesday">Wednesday</paper-item>
              <paper-item value="Thursday">Thursday</paper-item>
              <paper-item value="Friday">Friday</paper-item>
            </paper-menu>
            <paper-input is="iron-input" name="formClassDays" required hidden multi value="[[selectedClassDays]]" validator="classDaysValidator" auto-validate></paper-input>
          </div>

          <div class="menuContainer" style="width:460px">
            <h4>Class Events</h4>
            <iron-list>
              <template is="dom-repeat" items="{{classEvents}}">
                <paper-item on-dblclick="sayHi">
                  <div>{{item.type}}</div>
                  <div><paper-input type="date" disabled always-float-label value="{{item.date}}"></paper-input></div>
                </paper-item>
              </template>
            </iron-list>
          </div>
        </div>

        <paper-button type="submit" on-tap="submitForm" raised>Add New Class</paper-button>
      </form>
    </paper-material>
  </template>
  <script>
    Polymer({
      is: "fc-class-creator",
      properties: {
        teacherList: {
          type: Array,
          value: []
        },
        locationList: {
          type: Array,
          value: []
        },
        selectedStartTime: {
          type: Date,
          value: null
        },
        selectedEndTime: {
          type: Date,
          value: null
        },
        selectedStartDate: {
          type: Date,
          value: null,
          notify: true
        },
        selectedEndDate: {
          type: Date,
          value: null,
          notify: true
        },
        selectedLocation: {
          type: String,
          value: null
        },
        selectedTeachers: {
          type: String,
          value: null
        },
        selectedPracticeTestDay: {
          type: String,
          value: null
        },
        selectedClassDays: {
          type: Array,
          value: []
        },
        classEvents: {
          type: Array,
          value: []
        },
        listeners: {
          "iron-form-invalid": "formIsInvalid"
        }
      },
      observers: [
        "addPracticeTestDates(selectedStartDate,selectedEndDate,selectedPracticeTestDay)",
        "classDaysChangedAfterDatesPicked(selectedClassDays.splices)"
      ],
      /* -- Validator Functions -- */
      validateSelectedTeacher: function(){
        if(this.selectedTeachers != "" && this.selectedTeachers != null && this.selectedTeachers != []){
          this.$.teacherMenuHeader.style.color = "black";
          return true;
        } else {
          this.$.teacherMenuHeader.style.color = "red";
          return false;
        }
      },
      validateSelectedPracticeTestDay: function(){
        if(this.selectedPracticeTestDay != "" && this.selectedPracticeTestDay != null && this.selectedPracticeTestDay != []){
          this.$.practiceTestDayMenuHeader.style.color = "black";
          return true;
        } else {
          this.$.practiceTestDayMenuHeader.style.color = "red";
          return false;
        }
      },
      validateSelectedClassDays: function(){
        if(this.selectedClassDays != "" && this.selectedClassDays != null && this.selectedClassDays != []){
          this.$.classDaysMenuHeader.style.color = "black";
          return true;
        } else {
          this.$.classDaysMenuHeader.style.color = "red";
          return false;
        }
      },
      validateStartDate: function(){
        if(this.selectedStartDate == "" || this.selectedStartDate == null || this.selectedEndDate == "" || this.selectedEndDate == null){
          console.log("Fail 1");
          console.log(this.selectedStartDate);
          console.log(this.selectedEndDate);
          return false;
        }
        var start_date = new Date(this.selectedStartDate);
        var end_date = new Date(this.selectedEndDate);
        var dayIndexObj = {"Sunday":0,"Monday":1,"Tuesday":2,"Wednesday":3,"Thursday":4,"Friday":5,"Saturday":6};
        if(end_date - start_date > 0 &&  start_date.getDay() == dayIndexObj[this.selectedPracticeTestDay] && end_date.getDay() == 6){
          return true;
        } else {
          console.log("Fail 2");
          return false;
        }
      },
      /* -- Initialization Functions -- */
      ready: function(){
        this.$.teacherValid.validate = this.validateSelectedTeacher.bind(this);
        this.$.practiceTestDayValid.validate = this.validateSelectedPracticeTestDay.bind(this);
        this.$.classDaysValid.validate = this.validateSelectedClassDays.bind(this);
        this.$.startDateValid.validate = this.validateStartDate.bind(this);
      },
      created: function(){
        var self = this;
        var ref = new Firebase("focusedstaging1.firebaseio.com");
        ref.child("Locations").on("child_added", function(childSnapshot){
          var locationObject = childSnapshot.val();
          locationObject['firebaseKey'] = childSnapshot.key();
          self.push("locationList", locationObject);

        });
      },
      /* -- Other Fucking Functions -- */
      showCorrectTeachers: function(e){
        var self = this;
        self.teacherList = [];
        var ref = new Firebase("focusedstaging1.firebaseio.com");
        ref.child("Locations/" + self.selectedLocation + "/teachers").on("child_added", function(locationSnapshot){
          ref.child("teachers/" + locationSnapshot.key()).once("value", function(teacherSnapshot){
            var teacherObject = teacherSnapshot.val();
            teacherObject['firebaseKey'] = teacherSnapshot.key();
            self.push("teacherList",teacherObject);
          });
        });
      },
      classDaysChangedAfterDatesPicked: function(){
        this.addPracticeTestDates(this.selectedStartDate,this.selectedEndDate,this.selectedPracticeTestDay);
      },
      addPracticeTestDates: function(start_date,end_date,test_day){
        start_date = new Date(start_date);
        end_date = new Date(end_date);
        var self = this;

        if(self.$.startDateInput.validate() && self.$.endDateInput.validate() && self.selectedClassDays != []){
          self.classEvents = [];
          var dayIndexObj = {"Sunday":0,"Monday":1,"Tuesday":2,"Wednesday":3,"Thursday":4,"Friday":5,"Saturday":6};
          var daysToAddArr = self.selectedClassDays.map(function(one_day){
            switch(dayIndexObj[test_day]) {
              case 0:
                return dayIndexObj[one_day]%7;
                break;
              case 6:
                return (dayIndexObj[one_day] + 1)%7;
                break;
            }
          });
          daysToAddArr.sort();
          var eventObj = {};
          eventObj["type"] = "Practice Test";
          eventObj["date"] = self.getDateInStringFormForInputs(start_date);
          eventObj["start_time"] = "9:00AM";
          eventObj["end_time"] = "1:00PM";
          self.push("classEvents",eventObj);

          for(var loop_date = start_date; end_date - loop_date.setDate(loop_date.getDate() + 7) > 0; loop_date){
            eventObj = {};
            eventObj["type"] = "Practice Test";
            eventObj["date"] = self.getDateInStringFormForInputs(loop_date);
            eventObj["start_time"] = "9:00AM";
            eventObj["end_time"] = "1:00PM";
            self.push("classEvents",eventObj);
            console.log(self.classEvents);

            daysToAddArr.map(function(one_day_index){
              var week_date = new Date(loop_date);
              week_date.setDate(loop_date.getDate() + one_day_index);
              eventObj = {};
              eventObj["type"] = "Class";
              eventObj["date"] = self.getDateInStringFormForInputs(week_date);
              eventObj["start_time"] = self.selectedStartTime;
              eventObj["end_time"] = self.selectedEndTime;
              self.push("classEvents",eventObj);
            });
          }
        }
      },
      getDateInStringFormForInputs: function(inDate){
        return parseInt(inDate.getFullYear()) + "-" + parseInt(inDate.getMonth() + 1) + "-" + parseInt(inDate.getDate());
      },
      submitForm: function(e){
        console.log(this.selectedClassDays);
        this.$.classCreationForm.validate();
        var crap = this.$.classCreationForm.serialize();
        console.log(crap);
      },
      sayHi: function(e){
        alert(e);
      }

    });
  </script>
</dom-module>