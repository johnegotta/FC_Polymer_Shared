<dom-module id="fc-reading-zero">	
<template>
<style is="custom-style">
		div.line-number {
			width: 28px;
			line-height: 1.2;
			font-size: 14pt;
			font-size: 1.25em;
			font-family: merriweather;
			font-weight: 500;
			font-style: italic;
			padding: 6px 0px 6px 0px;
			margin: 6px 0px 6px 0px;
			
		}
		div.columnContainer{
			overflow-y: scroll;
			padding: 25px;
			margin: 36px;
		}
		div.passageContainer{ 
			max-width: 1450px !important;
			margin: 36px;
		}
		.highlighted {
			background: yellow;
		}
		div.blurb{
			line-height: 1.2;
			font-size: 1.2em;
			font-family: merriweather;
			font-weight: 500;
			font-style: italic;
			display: block;
		}
		div.text {
			line-height: 1.2;
			font-size: 14pt;
			font-size: 1.25em;
			font-family: merriweather;
			font-weight: 500;
			padding: 6px;
			margin: 6px 0px 6px 0px;
			min-height: 720px !important;
			display: flex;
			min-width: 280px !important;
			max-width: 680px !important;
			overflow-y: scroll;	
		}
</style>
<!--double-column line-number and passage vertical container--> 
			<div id="noJudge" class="layout vertical flex container left passageContainer">
	<!--blurb full width container-->
					<div class="layout horizontal blurb" style="margin: 12px 24px 0px 24px;min-width: 240px !important; max-width: 680px !important; max-height: 140px;">
					{{passageBlurb}}
					</div>

	<!--single column container-->
			<div id="singleColumnContainer" class="layout horizontal container columnContainer" style="padding-right: 12px; overflow-y: scroll;">
			<!--Line number container-->
					 		<div id="linenumbersA1" class="layout vertical line-number">
					 	
					 			<div id="linesA1">&nbsp</div>
					 			<template is="dom-repeat" items="{{firstColumnLineNumberArrayOne}}" filter="{{_numberRowsFilter(num_lines,showingSecondColumn)}}">
     								<span hidden="{{!item.show}}" id="col_one_line_{{index}}">{{item.number}}</span><span hidden="{{item.show}}">&nbsp</span>
     							
    							</template>
					 		</div>
			<!--passage-1-column-1 container-->
					 		<div id="colUnoA" class="layout horizontal flex wrap text">
					 		<article id="singleColumnText">
					 	    	<template is="dom-repeat" items="{{passageArrayOne}}">
 									<template is="dom-if" if="{{item.newPara}}">
 										<br><span>&nbsp&nbsp&nbsp&nbsp</span>
 									</template>
 									<a id="oneA_{{index}}" hidden="{{!columnOneShow}}">{{item.word}}</a>
								</template>
									<br class="line-numbers">
									<hr>
								<span class="right-justified line-numbers" style="float:right; text-align: right;" id="singleColumnBounder"> Focused Coaching (c) 2016</span>
							</article>
					 		</div>
					 	</div>					
		<!-- end-of-column-1 line number and text container-->
		






					<div id="doubleColumnContainer" class="layout horizontal flex container">
						<div id="firstColumnContainer" class="layout horizontal flex-1 container columnContainer" style="padding-right: 8px; overflow-y:scroll;">
			<!--Line number container-->
					 		<div id="linenumbers" class="layout vertical line-number">
					 		<div id="lines">Lines</div>
					 			<div class="line-numbers" id="linersoace">&nbsp</div>
					 			<template is="dom-repeat" items="{{lineNumberArray}}" filter="{{passageOneLineNumberFilter(num_lines_one)}}">
     								<span hidden="{{!item.show}}" id$="col_one_line_{{item.number}}">{{item.number}}</span><span hidden="{{item.show}}">&nbsp</span>
    							</template>
    							
					 		</div>
			<!--passage-1-column-1 container-->
					 		<div id="colUno" class="layout horizontal flex wrap text">
					 		<article id="textColumnOne">
					 	    	<template id='columnOneDomRepeat' is="dom-repeat" items="{{passageArrayOne}}" filter="{{passageOneFilter(showingSecondColumn,finalColumnOneWordIndex)}}">
 									<template is="dom-if" if="{{item.newPara}}">
 										<br><span>&nbsp&nbsp&nbsp&nbsp</span>
 									</template>
 									<a id$="one_{{item.order}}" hidden$="{{oneGone}}">{{item.word}}</a>
								</template>
								<br>
								<hr>
								<span class="right right-justified" style="float:right; text-align: right;" id="doubleColumnBounderOne"> Focused Coaching (c) 2016</span>
							</article>
					 		</div>
					 	</div>
		<!-- end-of-column-1 line number and text container-->



		<!--column-2-container line numbs and passage | Flex-1 keeps the columns veen-->
					 	<div id="secondColumnContainer" class="layout horizontal flex-1 container" style="padding-left: 8px;overflow-y:scroll;">
			<!--Line number container-->
					 		<div id="linenumbersright" class="layout vertical line-number">
					 			<div id="linesB2">Lines</div>
					 		 	<template is="dom-repeat" items="{{lineNumberArrayTwo}}" filter="{{passageTwoLineNumberFilter(start_lines_two,num_lines_two)}}">
     								<span hidden="{{!item.show}}" id$="col_one_line_{{index}}">{{item.number}}</span><span hidden="{{item.show}}">&nbsp</span>
     								
    							</template>	
					 		</div>
			<!--end of passage-1-column-1 line number container-->
			<!--passage-1-column-2 container-->
					 		<div id="colDos" class="layout vertical text">
					 		<article id="textColumnTwo">
					 			<div class="line-numbers"><span>&nbsp </span></div>
								<template is="dom-repeat" items="{{passageArrayOne}}" filter="{{passageTwoFilter(showingSecondColumn,finalColumnOneWordIndex)}}">
 									<template is="dom-if" if="{{item.newPara}}">
 										<br><span>&nbsp&nbsp&nbsp&nbsp</span>
 									</template>
 									<a id$="one_{{item.order}}" hidden$="{{!oneGone}}">{{item.word}}</a>
								</template>
								<br class="line-numbers">
								<hr>
								<span class="right right-justified line-numbers" style="float:right; text-align: right;" id="doubleColumnBounderTwo"> End of Passage</span>
							</article>
					 		</div>
		<!--passage-1-column-2 container-->
					 	</div>
	<!--end of flex passage column container-->
				</div>
<!--End of top container horizontal-->
			</div>
<!--End of Vertical passage container-->
</template>
<script>
Polymer({
	is:'fc-reading-zero',
	behaviors: [Polymer.IronResizableBehavior],
	properties: {
		passagePath: {
			type: String,
			value: 'new_Test_1',
			notify: true,
			reflectToAttributes: true
		},
		numberPlus: {
			type: Number,
			value: 0,
			notify: true
		},
		passageFullPath: {
			type: String,
			value: '',
			notify: true,
			reflectToAttributes: true
		},
		passageArrayOne:{
			type: Array, 
			value: function(){
				return [];
			},
			notify: true, 
			reflectToAttibutes: true 
		},
		longestLineNumberArray:{
			type: Array,
			value: function(){
				return [];
			},
			notify: true,
		},
		ColumnOneWordArray: {
			type: Array,
			value: function(){
				return [];
			},
			notify: true,
			reflectToAttributes: true
		},
		ColumnTwoWordArray: {
			type: Array,
			value: function(){
				return [];
			},
			notify: true,
			reflectToAttributes: true
		},
		firstColumnLineNumberArrayOne:{
			type: Array,
			value: function(){
				return [];
			},
			notify: true
		},
		passageWordArray: {
			type: Array,
			value: function(){
				return [];
			},
			notify: true
		},
		goldenDist:{
			type: Number,
			notify: true
		},
		wordArray: {
			type: Array,
			value: function(){
				return [];
			},
			notify: true
		},
		
		lineNumberArray: {
			type: Array,
			value: function(){
				return [];
			},
			notify: true
		},
		lineNumberArrayTwo: {
			type: Array,
			value: function(){
				return [];
			},
			notify: true
		},
		
		passageTitle: {
			type: String, 
			notify: true,
			reflectToAttributes: true
		},
		numWords: {
			type: Number,
			notify: true,
			reflectToAttributes: true
		},
		passageBlurb:{
			type: String,
			value: 'Get The Blurbs',
			reflectToAttributes: true,
			notify: true
		},
		linesH: {
			type: String,
			value: '',
			notify: true
		},
		showingSecondColumn: {
			type: Boolean,
			value: false,
			notify: true
		},
		lastRow:{
			type: Number,
			notify: true,
		},
		goldenRatio: {
			type: Number,
			notify: true,
			reflectToAttributes: true
		},
		finalColumnOneWordIndex: {
			type: Number,
			notify: true
		},
		
		idPlus:{
			type: Number,
			notify: true
		},
		lastWord:{
			type: String,
			notify: true
		},
		deltaWords:{
			type: Number,
			value: 0,
			notify: true
		},
		secondColumnFirstWordIndex:{
			type: Number,
			notify: true
		}
	},
	// observers: ['passageExistsNow(passageArrayOne.*)'],
	// passageExistsNow: function(changeRecord){
	// 	//console.log('PASSAGE EXISTS NOW');
	// 	//console.log(changeRecord);
	// 	// if(changeRecord.value.length > 0){
	// 	// 	//console.log("We Have Words");
	// 	// 	this.setUp();
	// 	// }
	// },
	ready: function(){
		////console.log("READY");
		this.passageArrayOne=[];
		var self = this;
		var ref = new Firebase("https://focusedstaging1.firebaseio.com/passagesDestinations/" + self.passagePath);
		ref.on("value", function(snap){
			
			self.set('passageArrayOne', snap.val());
			self.numWords = self.passageArrayOne.length;
			self.lastWord = self.numWords-1;
			self.goldenRatio = Math.ceil(.618*self.numWords);
			self.finalColumnOneWordIndex = self.goldenRatio;
			self.secondColumnFirstWordIndex = self.finalColumnOneWordIndex+1;
			//self.passageTitle = self.passageArrayOne[58].passageTitle;
			self.passageBlurb = self.passageArrayOne[58].passageBlurb;
			self.fillNumbArrays();
		});
	},
	fillNumbArrays: function(){
		for(i=1; i <= 200; i++)
			{
			j=	i % 5 ? false: true;
			this.push("lineNumberArray", {'number': i, 'show': j});
			this.push("lineNumberArrayTwo", {'number': i, 'show': j});
			this.push("firstColumnLineNumberArrayOne", {'number': i, 'show': j});
			this.push("longestLineNumberArray", {'number': i, 'show': j});
			}	
	},
	attached: function(){
		////console.log("ATTACHED!");
		this.notifyResize();
	},
	
	notifyResize: function(){
		//console.log("NOTIFY RESIZE");		
		this.setUp();
		
	},
	
	setUp: function(){
		//console.log('SETUP');
		this.screenTrueHeight = (window.innerHeight-340);
		this.textColumnOneHeight=this.$.textColumnOne.scrollHeight;
		if(this.textColumnOneHeight!=undefined && this.textColumnOneHeight >=50){
			if(this.$.noJudge.clientWidth >= 670 && this.textColumnOneHeight>this.screenTrueHeight){
				this.$.doubleColumnContainer.hidden = false;
				this.$.singleColumnContainer.hidden = true; 
				this.showingSecondColumn = true;
				this.numberTwoColumns(this._adjustDoubleColumns(true));
				//console.log('setUp2col');
			}
			else{ 
				this.$.doubleColumnContainer.hidden = true;
				this.$.singleColumnContainer.hidden = false;
				  this.showingSecondColumn = false;
				  this.numberOneColumn(this.showingSecondColumn);
				  //console.log('setUp1col');
				
			}
		}
		else {
			if(this.$.noJudge.clientWidth >= 670){
				this.$.secondColumnContainer.hidden = false;
				this.textColumnOneHeight=this.$.textColumnOne.scrollHeight;
				if(this.textColumnOneHeight < this.screenTrueHeight){
					this.$.doubleColumnContainer.hidden = false;
					this.$.singleColumnContainer.hidden = true; 
					this.showingSecondColumn = true;
					//console.log('setUp2col2');
					this.numberTwoColumns(this._adjustDoubleColumns(true));
				}
			}
			else{
				this.$.doubleColumnContainer.hidden = true;
				this.$.singleColumnContainer.hidden = false;
				this.showingSecondColumn=false;
				//console.log('setUp2col1');
				this.numberOneColumn(this.showingSecondColumn);
			}
					
		}
	},
	growFirstColumn: function(numberAhead){
				var self=this;
				//console.log("growing the right side");
				
				while(numberAhead>-8){
				self.firstWordAnchor =  (this.$$('#one_'+ self.secondColumnFirstWordIndex.toString()) != undefined) ? this.$$('#one_'+ self.secondColumnFirstWordIndex.toString()): setTimeout(self._measureWords(true),1400);
					var top_of_line_to_reclaim = self.firstWordAnchor.getBoundingClientRect().top;
					var nextAnchor = self.firstWordAnchor;
					var top_of_next_anchor = top_of_line_to_reclaim;
				while(top_of_line_to_reclaim == top_of_next_anchor){				
					nextAnchor = nextAnchor.nextSibling;	
					if(nextAnchor.nodeName == self.firstWordAnchor.nodeName){
						//console.log(nextAnchor.nodeName +  ' node two: ' + self.firstWordAnchor.nodeName);
						top_of_next_anchor = nextAnchor.getBoundingClientRect().top;
						self.numberPlus--;
						//console.log(self.numberPlus);
					}
				}
			}		
		},
	_adjustDoubleColumns: function(showingSecondColumn){
				this.finalColumnOneWordIndex = (this.finalColumnOneWordIndex<.55*this.numWords) ? this.goldenRatio: this.finalColumnOneWordIndex;
				var theId = '#one_'+ this.finalColumnOneWordIndex.toString()
				var finalWordAnchor = this.$$(theId);
				var bottom_of_line_to_cut = finalWordAnchor.getBoundingClientRect().bottom;
				var previousAnchor = finalWordAnchor;
				var bottom_of_previous_anchor = bottom_of_line_to_cut;
				var howManyAheadOfFinalColumnOneWord = 0;
				//console.log('adjustDoubleCol');
				while(howManyAheadOfFinalColumnOneWord <12 && bottom_of_previous_anchor == bottom_of_line_to_cut){
					previousAnchor = previousAnchor.previousSibling;
					if(previousAnchor.nodeName == finalWordAnchor.nodeName){
						//console.log(previousAnchor.nodeName +  ' : compare node to node : ' + finalWordAnchor.nodeName);
						bottom_of_previous_anchor = previousAnchor.getBoundingClientRect().bottom;
						howManyAheadOfFinalColumnOneWord++;
						this.numberPlus = howManyAheadOfFinalColumnOneWord;
					}
				}
				
			this.finalColumnOneWordIndex = this.finalColumnOneWordIndex - howManyAheadOfFinalColumnOneWord;
			this.growFirstColumn(self.numberPlus);
					
			},
	numberTwoColumns: function(adjustDouble){
		var bottom_of_topBound = this.$.lines.getBoundingClientRect().bottom;
		var bounderOne = this.$.doubleColumnBounderOne;
		var bounderTwo = this.$.doubleColumnBounderTwo;
		var bounderOne_rect =  bounderOne.getBoundingClientRect();
		var bounderTwo_rect =  bounderTwo.getBoundingClientRect();
		var line_height = this.$.lines.clientHeight;
		var deltaOne = bounderOne_rect.bottom - bottom_of_topBound;
		var deltaTwo = bounderTwo_rect.bottom - bottom_of_topBound;
		this.num_lines_one = Math.ceil(deltaOne/line_height) - 2.3;
		this.start_lines_two = this.num_lines_one;
		this.num_lines_two = this.start_lines_two  + Math.ceil(deltaTwo/line_height) - 2.3;
		//console.log('numTwoCol');
	},
	numberOneColumn: function(showingSecondColumn){
		 var bottom_of_first_word = this.$.linesA1.getBoundingClientRect().bottom;
		 var last_word = this.$.singleColumnBounder;
		 var last_word_rect =  last_word.getBoundingClientRect();
		 var line_height = this.$.linesA1.clientHeight;
		 var delta = last_word_rect.bottom - bottom_of_first_word;
		 this.num_lines = Math.round(delta/line_height) - 2.3;
		//console.log('numOneCol');
		
	},
	passageOneFilter: function(showSecond, finalWord){
		if(showSecond==true){
			return (item)=>{
				return (item.order <= this.finalColumnOneWordIndex);
			};
		} 
		else{
			return (items) => { 
				return false;
			};
		}
	},
	
	passageTwoFilter: function(showSecond, finalWord){
		if(showSecond==true){
			return (item)=>{
				return item.order > this.finalColumnOneWordIndex;
			};
		} else {
			return (item)=>{
				return false;
			};
		}
	},
	_numberRowsFilter: function(numLines,showSecond){
		if(showSecond == false){
			return (item) =>{
				return item.number <= numLines;
			};
		} else {
			return (item) => {
				return false;
			};
		}
	},
	passageOneLineNumberFilter: function(numLines){
		return (item) => {
			return item.number <= numLines;
		};
	},
	passageTwoLineNumberFilter: function(firstLine,lastLine){
		return (item) => {
			return (item.number >= firstLine && item.number <= lastLine);
		};
	}
});
</script>
</dom-module>