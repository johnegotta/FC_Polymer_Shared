<dom-module id="fc-double-column-layout">
<template>
<style>
		div.line-number {
			width: 28px;
			line-height: 1.2;
			font-size: 14pt;
			font-size: 1.25em;
			font-family: merriweather;
			font-weight: 500;
			font-style: italic;
			padding: 6px 0px 6px 0px;
			margin: 6px 0px 6px 0px;
			
		}
		div.columnContainer{
			overflow-y: scroll;
		}
		
		.highlighted {
			background: yellow;
		}
		
		div.text {
			line-height: 1.2;
			font-size: 14pt;
			font-size: 1.25em;
			font-family: merriweather;
			font-weight: 500;
			padding: 6px;
			margin: 6px 0px 6px 0px;
			min-height: 720px !important;
			display: flex;
			min-width: 260px !important;
			max-width: 680px !important;	
		}

		.lwanchor {
			border: 2px solid silver;
			background: goldenrod;
			opacity: .78;
		}
		.lofanchor {
			background: #aecdfe;
			opacity: .78;
		}
		.losanchor {
			border: 2px dashed green;
			background: palegreen;
		}
</style>
		


		<div id="doubleColumnContainer" class="layout horizontal flex container">
						<div id="firstColumnContainer" class="layout horizontal flex-1 container columnContainer" style="padding-right: 8px; overflow-y:scroll;">
			<!--Line number container-->
					 		<div id="linenumbers" class="layout vertical line-number">
					 		<div id="lines" class="line-numbers">Lines</div>
					 		<div>&nbsp</div>
					 			<template is="dom-repeat" items="{{lineNumberArrayOne}}" filter="{{columnOneLineNumberFilter(shown, lof)}}">
     								<span hidden="{{!item.show}}" id$="col_one_line_{{item.number}}">{{item.number}}</span><span hidden="{{item.show}}">&nbsp</span>
    							</template>
    							
					 		</div>
			<!--passage-1-column-1 container   filter="{{passageOneLineNumberFilter(num_lines_one)}}"-->
					 		<div id="colUno" class="layout horizontal flex wrap text">
					 		<article id="textColumnOne">
					 	    	<template id='columnOneDomRepeat' is="dom-repeat" items="{{theContent}}" filter="{{columnOneFilter(shown, lwa)}}">
 									<template is="dom-if" if="{{item.newPara}}">
 										<br><span>&nbsp&nbsp&nbsp&nbsp</span>
 									</template>
 									<a id$="dd_one_{{item.order}}" hidden$="{{oneGone}}">{{item.word}}</a>
								</template>
								<br>
								<hr>
								<span class="right right-justified" style="float:right; text-align: right;" id="doubleColumnBounderOne"> Focused Coaching (c) 2016</span>
							</article>
					 		</div>
					 	</div>
		<!-- end-of-column-1 line number and text container-->



		<!--column-2-container line numbs and passage | Flex-1 keeps the columns veen-->
					 	<div id="secondColumnContainer" class="layout horizontal flex-1 container" style="padding-left: 8px;overflow-y:scroll;">
			<!--Line number container-->
					 		<div id="linenumbersright" class="layout vertical line-number">
					 			<div id="linesB2">Lines</div>
					 			<div>&nbsp</div>
					 		 	<template is="dom-repeat" items="{{lineNumberArrayTwo}}" filter="{{columnTwoLineNumberFilter(shown, lof, los)}}" >
     								<span hidden="{{!item.show}}" id$="col_one_line_{{index}}">{{item.number}}</span><span hidden="{{item.show}}">&nbsp</span>
     								
    							</template>	
					 		</div>
			<!--end of passage-1-column-1 line number container-->
			<!--passage-1-column-2 container-->
					 		<div id="colDos" class="layout vertical text">
					 		<div>&nbsp</div>
					 		<article id="textColumnTwo">
					 			<div ><span>&nbsp </span></div>
								<template is="dom-repeat" items="{{theContent}}" filter="{{columnTwoFilter(shown, lwa)}}">
 									<template is="dom-if" if="{{item.newPara}}">
 										<br><span>&nbsp&nbsp&nbsp&nbsp</span>
 									</template>
 									<a id$="dd_one_{{item.order}}" hidden$="{{!oneGone}}">{{item.word}}</a>
								</template>
								<br>
								<hr>
								<span class="right right-justified" style="float:right; text-align: right;" id="doubleColumnBounderTwo"> End of Passage</span>
							</article>
					 		</div>
		<!--passage-1-column-2 container-->
					 	</div>
	<!--end of flex passage column container-->
				</div>
<!--End of top container horizontal-->
			
	<!--end of flex passage column container-->

</template>
<script>
Polymer({
	is: 'fc-double-column-layout',
	//behaviors: ,
	properties: {
		theContent:{
			type: Array, 
			value: [],
			notify: true 
		},
		lastWordIndex:{
			type: Number,
			value: 730,
			notify: true
		},
		lineNumberArrayOne:{
			type: Array,
			value: function(){ 
				var lineNumberArray = [];
				for(var i=1; i <= 120; i++)
				{	
					j=	i % 5 ? false: true;
					lineNumberArray.push({'number': i, 'show': j});
				}
				return lineNumberArray;
			},
			notify: true,
		},
		lineNumberArrayTwo: {
			type: Array,
			value: function(){  
				var lineNumberArray = [];
				for(var i=30; i <= 180; i++)
				{	
					j=	i % 5 ? false: true;
					lineNumberArray.push({'number': i, 'show': j});
				}
				return lineNumberArray;
			},
			notify: true
		},
	
		splitRatio: {
			type: Number,
			computed: 'computeSplitRatio(lastWordIndex)',
			notify: true,
		
		},
		
		lwa: {
			type: Number,
			value: 480,
			notify: true
		},
		bottom_ofc:{
			type: Number,
			value: 480,
			notify: true
		},
		lof:{
			type: Number,
			value: 480,
			notify: true
		},
		los:{
			type: Number,
			notify: true
		},
		secondColumnFirstWordIndex: {
			type: Object,
			value: {
				ratio: this.splitRatio + 1, 
				lineNumberStart: 54, 
				lineNumberEnd: 87,
				notify: true
			},
			notify: true
		},
		
		deltaWords:{
			type: Number,
			value: 0,
			notify: true
		},
		shown:{
			type: Boolean,
			value: false,
			notify: true,
			reflectToAttributes: true
		}, 
	},
	
	ready: function(){
	
	},

	computeSplitRatio: function(lastWordIndex){
	 	var lastWordAnchor = Math.ceil(lastWordIndex*.618);
	 	console.log(lastWordAnchor);
	 	return lastWordAnchor;

	 },
	notifyResize: function(showingSecond){
		
		if(showingSecond==false){this.shown=showingSecond; return this.shown;}
		else {
			this.shown=showingSecond;
			this._adjustDoubleColumns(this.lwa);
		
		}
	},
	
	growFirstColumn: function(numberBehind){
	
		console.log("growing the right side");
			console.log(this.lwa);
			var anchorSecondNumber = this.lwa + 1;
			var firstWordAnchor =  this.$$('#dd_one_' + anchorSecondNumber.toString());
			console.log(firstWordAnchor);
			Polymer.dom(firstWordAnchor).setAttribute('class', 'lwanchor');
			var bottom_of_line_to_reclaim = firstWordAnchor.getBoundingClientRect().bottom;
			var nextAnchor = firstWordAnchor;
			var bottom_of_next_anchor = bottom_of_line_to_reclaim;
			var gainedwords =0;
			while(bottom_of_line_to_reclaim == bottom_of_next_anchor && numberBehind>10){
				this.classFollows('lwanchor', nextAnchor, nextAnchor.nextSibling);				
				nextAnchor = nextAnchor.nextSibling;
				console.log(nextAnchor);
				if(nextAnchor.nodeName == firstWordAnchor.nodeName)
				{
					bottom_of_next_anchor = nextAnchor.getBoundingClientRect().bottom;
					this.deltaWords--;
					numberBehind--;
					gainedwords++;
				}
			}
			
			var pickle = this.lwa+gainedwords;
			this.set('lwa', pickle);
			var lastWordAnchor = this.$$('#dd_one_' + this.lastWordIndex.toString());
			console.log(this.lwa + ' ' + this.lof + ' ' +  this.los);
			this.los=this.lof + Math.floor((lastWordAnchor.getBoundingClientRect().bottom - this.$.linesB2.getBoundingClientRect().bottom)/this.$.linesB2.clientHeight);
			console.log(this.lwa + ' ' + this.lof + ' ' +  this.los);
			
			
	},
	_adjustDoubleColumns: function(newValue){
		this.lwa = (this.lwa==undefined || this.lwa<.58*this.lastWordIndex) ? this.splitRatio: this.lwa;
		//here we need first value to be wiped to right side
		var theId = '#dd_one_'+ this.lwa.toString();
		var finalWordAnchor = this.$$(theId);
		Polymer.dom(finalWordAnchor).setAttribute('class', 'lofanchor');
		var bottom_of_line_to_cut = finalWordAnchor.getBoundingClientRect().bottom;
		var previousAnchor = finalWordAnchor;
		var bottom_of_previous_anchor = bottom_of_line_to_cut;
		var howManyAheadOfFinalColumnOneWord = 0;
		
		while(howManyAheadOfFinalColumnOneWord <18 && bottom_of_previous_anchor == bottom_of_line_to_cut){
			previousAnchor = previousAnchor.previousSibling;
			if(previousAnchor.nodeName == finalWordAnchor.nodeName){
				this.classFollows('lofnchor', finalWordAnchor, finalWordAnchor.nextSibling);	

				//console.log(previousAnchor.nodeName +  ' : compare previous anchor node to node finalAnchor : ' + finalWordAnchor.nodeName);
				bottom_of_previous_anchor = previousAnchor.getBoundingClientRect().bottom;
				howManyAheadOfFinalColumnOneWord++;
				//console.log(bottom_of_previous_anchor);
				this.deltaWords = howManyAheadOfFinalColumnOneWord;
				this.set('bottom_ofc',bottom_of_previous_anchor);
				console.log(this.lwa + ' ' + this.lof + ' ' +  this.los);
				
			}
		}
				this.set('bottom_ofc',bottom_of_previous_anchor);
		var indexer = this.lwa - howManyAheadOfFinalColumnOneWord;
		this.set('lwa', indexer);
		this.lof=Math.floor((this.bottom_ofc-this.$.linesB2.getBoundingClientRect().bottom)/this.$.linesB2.clientHeight);
		console.log(this.lwa + ' ' + this.lof + ' ' +  this.los); 
		this.growFirstColumn(this.deltaWords);
	},
	numberTwoColumns: function(shown){
	},
	columnOneFilter: function(shown, lwa){
		if(shown==true){
			return (item)=>{
				return (item.order <= lwa);
			};
		} 
		else{
			return (item) => { 
				return false;
			};
		}
	},
	
	columnTwoFilter: function(shown, lwa){
		if(shown==true){
			return (item)=>{
				return item.order > lwa;
			};
		} else {
			return (item)=>{
				return false;
			};
		}
	},
	columnOneLineNumberFilter: function(shown, lof){
		if(shown==true){
			return (item)=>{
				return (item.number <= lof);
			};
		} 
		else{
			return (item) => { 
				return false;
			};
		}
	},
	columnTwoLineNumberFilter: function(shown, lof, los){
		if(shown==true){
			return (item)=>{
				return (item.number > lof && item.number <= los);
			};
		} 
		else{
			return (item) => { 
				return false;
			};
		}
	}
});
</script>
</dom-module>