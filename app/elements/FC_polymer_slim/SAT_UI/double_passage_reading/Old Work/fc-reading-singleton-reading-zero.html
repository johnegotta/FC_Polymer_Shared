<dom-module id="fc-reading-zero">	
<template>
<style is="custom-style">
		div.line-number {
			width: 28px;
			line-height: 1.2;
			font-size: 14pt;
			font-size: 1.25em;
			font-family: merriweather;
			font-weight: 500;
			font-style: italic;
			padding: 6px 0px 6px 0px;
			margin: 6px 0px 6px 0px;
			
		}
		div.columnContainer{
			overflow-y: scroll;
			padding: 8 12 8 12px;
			margin: 8px;
		}
		div.passageContainer{ 
			max-width: 1450px !important;
			margin: 4px;
			min-height: 750px;
			overflow-y: scroll;
			padding: 2px;
			margin: 4px;
		}
		.highlighted {
			background: yellow;
		}
		div.blurb{
			line-height: 1.2;
			font-size: 1.2em;
			font-family: merriweather;
			font-weight: 500;
			font-style: italic;
			display: block;
		}
		div.text {
			line-height: 1.2;
			font-size: 14pt;
			font-size: 1.25em;
			font-family: merriweather;
			font-weight: 500;
			padding: 6px;
			margin: 6px 0px 6px 0px;
			min-height: 720px !important;
			display: flex;
			min-width: 280px !important;
			max-width: 720px !important;
			overflow-y: scroll;	
		}
</style>
<span>
<button on-tap="setUp">ReSize</button> [[numLines]]
[[resizeNotice]]
</span>
<button on-tap="loop">ids</button>
<!--double-column line-number and passage vertical container--> 
			<div id="topPassageContainer" class="layout vertical flex container left passageContainer" style$="border:7px ridge silver;">
	<!--blurb full width container-->
					<div class="layout horizontal blurb" style="margin: 12px 24px 0px 24px;min-width: 240px !important; max-width: 680px !important; max-height: 140px;">
					{{passageBlurb}}
					</div>

	<!--single column container-->
			<div id="singleColumnContainer" class="layout horizontal container columnContainer" style="padding-right: 3px; overflow-y: scroll;">
			<!--Line number container-->
				<div id="linenumbersA1" class="layout vertical line-number">
					<div id="linesA1">Lines</div>
					<template 
					 	is="dom-repeat" 
					 	items="{{lineNumberArray}}" 
					 	filter="{{singleColumnFilter(numLines)}}"
					 >
     					<span 
     						hidden="{{!item.show}}" 
     						id="col_one_line_{{index}}">
     						{{item.number}}
     					</span>
     					<span 
     						hidden="{{item.show}}">
     						&nbsp
     					</span>			
    				</template>
				</div>
			<!--passage-1-column-1 container-->
					 		<div id="colUnoA" class="layout horizontal flex wrap text">
					 		<article id="singleColumnText">
					 	    	<template is="dom-repeat" items="{{passageArrayOne}}">
 									<template is="dom-if" if="{{item.newPara}}">
 										<br><span>&nbsp&nbsp&nbsp&nbsp</span>
 									</template>
 									<a id="oneA_{{item.order}}" hidden="{{!columnOneShow}}">{{item.word}}</a>
								</template>
									<br class="line-numbers">
									<hr>
								<span class="right-justified line-numbers" style="float:right; text-align: right;" id="singleColumnBounder"> Focused Coaching (c) 2016</span>
							</article>
					 		</div>
					 	</div>					
		<!-- end-of-column-1 line number and text container-->
		






					<div id="doubleColumnContainer" class="layout horizontal flex container">
						<div id="firstColumnContainer" class="layout horizontal flex-1 container columnContainer" style="padding-right: 4px; overflow-y:scroll;">
			<!--Line number container-->
					 		<div 
					 			id="linenumbers" 
					 			class="layout vertical line-number">
					 		<div 
					 			id="lines">
					 			Lines
					 		</div>
					 			<div>&nbsp</div>
					 			<template 
					 				is="dom-repeat" 
					 				items="{{lineNumberArray}}" 
					 				filter="{{singleColumnFilter(numLines)}}"
					 			>
     								<span hidden="{{!item.show}}" 
     								id$="col_one_line_{{item.number}}">{{item.number}}</span><span hidden="{{item.show}}">&nbsp</span>
    							</template>
    							
					 		</div>
			<!--passage-1-column-1 container-->
					 		<div id="colUno" class="layout horizontal flex wrap text">
					 		<article id="textColumnOne">
					 	    	<template 
					 	    		id='columnOneDomRepeat' 
					 	    		is="dom-repeat" 
					 	    		items="{{passageArrayOne}}" 
					 	    		filter="{{columnOneFilter(showSecond,finalColumnOneWordIndex)}}">
 									<template is="dom-if" if="{{item.newPara}}">
 										<br><span>&nbsp&nbsp&nbsp&nbsp</span>
 									</template>
 									<a id$="one_{{item.order}}" hidden$="{{oneGone}}">{{item.word}}</a>
								</template>
								<br>
								<hr>
								<span class="right right-justified" style="float:right; text-align: right;" id="doubleColumnBounderOne"> Focused Coaching (c) 2016</span>
							</article>
					 		</div>
					 	</div>
		<!-- end-of-column-1 line number and text container-->



		<!--column-2-container line numbs and passage | Flex-1 keeps the columns veen-->
					 	<div id="secondColumnContainer" class="layout horizontal flex-1 container columnContainer" style="padding-left: 4px;overflow-y:scroll;">
			<!--Line number container-->
					 		<div id="linenumbersright" class="line-number layout vertical">
					 			<div id="linesB2">Lines</div>
					 			<div>&nbsp</div>
				
					 		 	<template is="dom-repeat" 
					 		 	items="{{lineNumberArrayTwo}}" 
					 		 	filter="{{columnTwoLineNumberFilter(numLines,finalLine)}}">
     								<span hidden="{{!item.show}}" id$="col_one_line_{{index}}">{{item.number}}</span><span hidden="{{item.show}}">&nbsp</span>
     								
    							</template>	
					 		</div>
			<!--end of passage-1-column-1 line number container-->
			<!--passage-1-column-2 container-->
					 	<div id="colDos" class="layout vertical text">
					 		<article id="textColumnTwo">
								<template 
									is="dom-repeat" 
									items="{{passageArrayOne}}" 
										filter="{{columnTwoFilter(showSecond,finalColumnOneWordIndex)}}">
 									<template is="dom-if" if="{{item.newPara}}">
 										<br><span>&nbsp&nbsp&nbsp&nbsp</span>
 									</template>
 									<a id="one_{{item.order}}" hidden$="{{!oneGone}}">{{item.word}}</a>

								</template>
								<br class="line-numbers">
								<hr>
								<span class="right right-justified line-numbers" style="float:right; text-align: right;" id="doubleColumnBounderTwo"> End of Passage</span>
							</article>
					 		</div>
		<!--passage-1-column-2 container-->
					 	</div>
	<!--end of flex passage column container-->
				</div>
<!--End of top container horizontal-->
			</div>
<!--End of Vertical passage container-->
</template>
<script>
FcReadingZero=Polymer({
	is:'fc-reading-zero',
	behaviors: [Polymer.IronResizableBehavior],
	properties: {
		passagePath: {
			type: String,
			value: 'new_Test_1',
			notify: true,
			reflectToAttributes: true
		},
		goldenRatio:{
			type: Number,
			computed: 'computeGoldenRatio(numWords)',
			notify: true
		},
		
		passageFullPath: {
			type: String,
			value: '',
			notify: true
		},
		passageArrayOne:{
			value: Array, 
			notify: true, 
		},

		screenTrueHeight: {
			type: Number, 
			value: function(){
				var estimate = Math.floor(window.innerHeight*.7925);
				var trueHeight=window.getComputedStyle(this.$.topPassageContainer);
				var measuredHeight=this.$.topPassageContainer.clientHeight;
				console.log(`estimate: ${estimate} 
							trueHeight: ${trueHeight}
							measuredHeight: ${measuredHeight}`);
				return estimate;
			},
			notify: true
		},
		textColumnOneHeight:{
			type: Number,
			computed: 'computePromiseColOneHeight(passageArrayOne)',
			notify: true
		},
		numLines: {
			type: Number,
			value: function(){
				return 65;
			},
			notify: true
		},
		resizeNotice: {
			type: Number,
			value: function(){return 480;},
			notify: true,
			reflectToAttributes: true
		},
		
		lineNumberArray: {
			type: Array,
			value: function() {
				var linenumberarray = [];
				for(i=1; i <= 200; i++)
				{
					j=	i % 5 ? false: true;
					linenumberarray.push({'number': i, 'show': j});	
				}
				return linenumberarray;
			},
			notify: true
		},
		lineNumberArrayTwo: {
			type: Array,
			value: function() {
				var linenumberarray = [];
				for(i=1; i <= 200; i++)
				{
					j=	i % 5 ? false: true;
					linenumberarray.push({'number': i, 'show': j});	
				}
				return linenumberarray;
			},
			notify: true
		},

		finalLine: {
			type: Number, 
			value: function(){ 
				return 123;
				},
		 	notify: true
		},
		
		passageTitle: {
			type: String, 
			notify: true,
			reflectToAttributes: true
		},
		numWords: {
			type: Number,
			notify: true,
			reflectToAttributes: true
		},
		passageBlurb:{
			type: String,
			value: 'Get The Blurbs',
			reflectToAttributes: true,
			notify: true
		},
		
		showSecond: {
			type: Boolean,
			value: false,
			notify: true
		},
		
		firstColIndex: {
			type: Number,
			notify: true
		},
		secondColumnFirstWordIndex:{
			type: Number,
			notify: true
		}
	},
	created: function(){
	
	},
	
	ready: function(){
		////console.log("READY");
	
		this.passageArrayOne=[];
		var self = this;
		var ref = new Firebase("https://focusedstaging1.firebaseio.com/passagesDestinations/" + self.passagePath);
		ref.on("value", function(snap){
			self.set('passageArrayOne', snap.val());
			self.numWords = self.passageArrayOne.length;
			self.firstColIndex = Math.ceil(618*self.numWords);
			self.secondColumnFirstWordIndex = self.firstColIndex+1;
			self.passageBlurb = self.passageArrayOne[3].passageBlurb;
		});
	},


	computePromiseColOneHeight: function (passageArrayOne){
		//we should use the canvas here
		this.notifyResize();
		return this.$.textColumnOne.clientHeight;
	},
 		
	
	attached: function(){
		////console.log("ATTACHED!");
		this.notifyResize();
	},
	computeGoldenRatio: function(numWords){
		var gold = Math.ceil(618*this.numWords);
		return gold;

	},

	notifyResize: function(){
		//console.log("NOTIFY RESIZE");		
		this.setUp();	
	},

	
	setUp: function(){
		if(this.textColumnOneHeight!=undefined && this.$.topPassageContainer.clientWidth >= 730)
			{	
				this.$.doubleColumnContainer.hidden = false;
				this.$.singleColumnContainer.hidden = true; 
				this.showSecond = true;
				this.numberFirstColumn(true);
				this.numberSecondColumn(this._adjustDoubleColumns(true));
				console.log('setUp2col');
			}
		else{ 
			this.$.doubleColumnContainer.hidden = true;
			this.$.singleColumnContainer.hidden = false;
		 	this.showSecond = false;
			this.numberFirstColumn(false);
			}
	},
	loop: function(){
		var max = this.passageArrayOne.length;
		for(var i=0; i<max; i++){
			console.log(this.passageArrayOne[i]);
		}
	},
	growFirstColumn: function(numberAhead){
				var self=this;
				//console.log("growing the right side");
				
				while(numberAhead>-8){
				self.firstWordAnchor =  (this.$$('#one_'+ self.secondColumnFirstWordIndex.toString()) != undefined) ? this.$$('#one_'+ self.secondColumnFirstWordIndex.toString()): setTimeout(self._measureWords(true),1400);
					var top_of_line_to_reclaim = self.firstWordAnchor.getBoundingClientRect().bottom;
					var nextAnchor = self.firstWordAnchor;
					var top_of_next_anchor = top_of_line_to_reclaim;
				while(top_of_line_to_reclaim == top_of_next_anchor){				
					nextAnchor = nextAnchor.nextSibling;	
					if(nextAnchor.nodeName == self.firstWordAnchor.nodeName){
				
						top_of_next_anchor = nextAnchor.getBoundingClientRect().bottom;
						
					}
				}
			}		
		},
	_adjustDoubleColumns: function(){
		console.log(this.firstColIndex + this.numWords +  this.goldenRatio);
				this.firstColIndex = (this.firstColIndex<Math.floor(.55*this.numWords)) ? this.goldenRatio: this.firstColIndex;
				var theId = '#one_'+ this.firstColIndex.toString();
				var finalWordAnchor = this.$$(theId);
				var bottom_of_line_to_cut = finalWordAnchor.getBoundingClientRect().bottom;
				var previousAnchor = finalWordAnchor;
				var bottom_of_previous_anchor = bottom_of_line_to_cut;
				var howManyAheadOfFinalColumnOneWord = 0;
				//console.log('adjustDoubleCol');
				while(howManyAheadOfFinalColumnOneWord <12 && bottom_of_previous_anchor == bottom_of_line_to_cut){
					previousAnchor = previousAnchor.previousSibling;
					if(previousAnchor.nodeName == finalWordAnchor.nodeName){
						bottom_of_previous_anchor = previousAnchor.getBoundingClientRect().bottom;
						howManyAheadOfFinalColumnOneWord++;
						
					}
				}
				
			this.firstColIndex = this.firstColIndex - howManyAheadOfFinalColumnOneWord;
			console.log(this.firstColIndex);
			this.growFirstColumn();
					
			},
	numberSecondColumn: function(adjustDouble){
		var bottom_of_topBound = this.$.lines.bottom;
		var bounderTwo = this.$.doubleColumnBounderTwo;
		var bounderTwo_rect =  bounderTwo.getBoundingClientRect();
		var line_height = this.$.lines.clientHeight;
		var deltaTwo = bounderTwo_rect.bottom - bottom_of_topBound;
		this.finalLine = Math.ceil(deltaTwo/line_height) - 3;
		//console.log('numTwoCol');
	},
	numberFirstColumn: function(showSecond){
			
		 var bottom_of_first_word = (showSecond==false) ? this.$.linesA1.getBoundingClientRect().bottom: this.$.lines.getBoundingClientRect().bottom;
		 var last_word = (showSecond==true) ? '#oneA_'+ this.firstColIndex.toString():'#one_'+ this.firstColIndex.toString();
		 var last_word_rect =  last_word.getBoundingClientRect();
		 var line_height = (showSecond==false) ? this.$.linesA1.clientHeight: this.$.lines.clientHeight;
		 var delta = last_word_rect.bottom - bottom_of_first_word;
		 var numLines = Math.floor(delta/line_height) - 3;
		 this.numLines = Math.floor(numLines);
		 this.numberSecondColumn();
		//console.log('numOneCol');
		
	},
	columnOneFilter: function(showSecond, finalWord){
		if(showSecond==true){
			return (item)=>{
				return (item.order <= this.firstColIndex);
			};
		} 
		else{
			return (items) => { 
				return false;
			};
		}
	},
	
	columnTwoFilter: function(showSecond, finalWord){
		if(showSecond==true){
			return (item)=>{
				return item.order > this.firstColIndex;
			};
		} else {
			return (item)=>{
				return false;
			};
		}
	},

	singleColumnFilter: function(numLines)
	{console.log(numLines);
		return (item) => {
			return item.number <= numLines;
		};
	},
	columnTwoLineNumberFilter: function(numLines, finalLine){
		return (item) => {
			return (item.number > numLines && item.number <= finalLine);
		};
	}
});
</script>
</dom-module>