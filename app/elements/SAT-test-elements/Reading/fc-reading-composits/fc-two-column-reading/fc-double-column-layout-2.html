<dom-module id="fc-double-column-layout">
<template>
<style>
		div.line-number {
			width: 28px;
			line-height: 1.2;
			font-size: 14pt;
			font-size: 1.25em;
			font-family: merriweather;
			font-weight: 500;
			font-style: italic;
			padding: 6px 0px 6px 0px;
			margin: 6px 0px 6px 0px;
			
		}
		div.columnContainer{
			overflow-y: scroll;
		}
		
		.highlighted {
			background: yellow;
		}
		
		div.text {
			line-height: 1.2;
			font-size: 14pt;
			font-size: 1.25em;
			font-family: merriweather;
			font-weight: 500;
			padding: 6px;
			margin: 6px 0px 6px 0px;
			min-height: 720px !important;
			display: flex;
			min-width: 260px !important;
			max-width: 680px !important;	
		}
</style>
		
		<div
			id="doubleColumnPassageContainer"
			class="layout horizontal flex container"
		>
			<div 
				id="firstColumnContainer" 
				class="layout horizontal flex-1 container columnContainer" 
				style="padding-right: 12px; overflow-y:scroll;"
			>
				<div 
					id="linenumbers" 
					class="layout vertical line-number"
				>
					<div
						id="lines" 
						class="line-numbers"
					>Lines
					</div>
					<template
						id="repeaterForLineNumbersOne" 
						is="dom-repeat" 
						items="{{LineNumberArrayTwo}}" 
						filter='{{columnOneLineNumbersFilter(num_lines)}}'
					>
     					<span 
     						id$="{{item.number}}"
     						hidden="{{!item.show}}">{{item.number}}</span>
     					<span 
     						id$="hidden_{{item.number}}"
     						hidden="{{item.show}}"
     						>&nbsp
     						</span>
    				</template>
    			</div><!--END OF COLUMN ONE LINE NUMBERS-->
				<div 
					id="ColumnOne" 
					class="layout horizontal flex wrap text"
				><!--START OF COLUMN ONE TEXT-->
				 	<article 
				 		id="textColumnOne"
				 		>
				 	    <template 
				 	    	id='columnOneDomRepeat' 
				 	    	is="dom-repeat" 
				 	    	items="{{theContent}}" 
				 	    	observe='{{order}}' 
				 	    	filter='{{columnOneWordFilter(firstColumnLastWordIndex, secondColumnFirstWordIndex)}}'
				 	    >
							<template 
								is="dom-if" 
								if="{{item.newPara}}"
							>
								<br>
								<span>&nbsp&nbsp&nbsp&nbsp
								</span>
							</template>
							<a 
								id$="one_{{item.order}}" 
								invisibility="{{invisibility}}"
							>{{item.word}}
							</a>
						</template>
						<br id="measurer" class="line-numbers">
						<hr>
						<span 
							id="doubleColumnBounderOne"
							class="right right-justified line-numbers" 
							style="float:right; text-align: right;"
							> 
							Focused Coaching (c) 2016
						</span>
					</article>
				</div>
			</div>				<!-- end-of-column-1 line number and text container-->
			<div 
				id="secondColumnContainer" 
				class="layout horizontal flex-1 columnContainer" 
			>
				<div 
					id="linenumbersright" 
					class="layout vertical line-number"
				>
				<div 
						id="lines" 
						class="line-numbers"
						style="margin-right: 12px;"
					>Lines
					</div>
					<template
						id="repeaterColTwoLineNums" 
						is="dom-repeat" 
						items='{{LineNumberArrayTwo}}'
						filter='{{columnTwoLineNumbersFilter(last_row, num_lines)}}'
					>	
     					<span 
     						id$="hiddenLinesTwo_{{item.number}}" 
     						hidden="{{!item.show}}" 
     						>
     						{{item.number}}
     					</span>
     					<span hidden="{{item.show}}">&nbsp</span>
    				</template>	
				</div>
				<div id="colDos" class="layout vertical text">
					 		<article id="textColumnTwo">
<!--FILTER WORDS COL TWO-->									
								<template 
								is="dom-repeat" 
								items="{{theContent}}" 
								filter='{{columnTwoWordFilter(firstColumnLastWordIndex, secondColumnFirstWordIndex, lastWordIndex)}}'>
	 									<template is="dom-if" if="{{item.newPara}}">
 											<br>
 											<span>&nbsp&nbsp&nbsp&nbsp</span>
	 									</template>
 										<a id$="one_{{item.order}}" hidden$="{{!oneGone}}">{{item.word}}</a>
									</template>
									<br>
									<hr>
									<span class="right right-justified line-numbers" style="float:right; text-align: right;" id="doubleColumnBounderTwo"> End of Passage</span>
							</article>
						</div>
		</div>
	<!--end of flex passage column container-->
	</div>
</template>
<script>
Polymer({
	is: 'fc-double-column-layout',
	behaviors: [Polymer.IronResizableBehavior],
	properties: {

		theContent:{
			type: Array, 
			value: function(){
				return []
			},
			notify: true, 
			reflectToAttibute: true 
		},
	

		lastWordIndex:{
			type: Number,
			notify: true,
			reflectToAttribute: true
		},
		
		longestLineNumberArrayThree:{
			type: Array,
			value: [],
			notify: true,

		},
		longestLineNumberArrayTwo:{
			type: Array,
			value: [],
			notify: true,

		},
		goldenRatio: {
			type: Number,
			notify: true,
			reflectToAttributes: true
		},
		firstColumnLastWordIndex: {
			type: Number,
			value: function(){
				return 456;
			},
			notify: true
		},

		secondColumnFirstWordIndex: {
			type: Number,
			value: function(){
				return 456;
			},
			notify: true
		},
		
		lastRow:{
			type: Number,
			value: 111,
			notify: true,
		},
		columnOneLastRow:{
			type: Number,
			value: 70,
			notify: true

		},
		
		deltaWords:{
			type: Number,
			value: 0,
			notify: true
		},

		shown:{
			type: Boolean,
			value: false,
			notify: true,
			reflectToAttributes: true
		}, 

		numWords: {
			type: Number,
			value: 500,
			notify: true
		},
		num_lines:{
			type: Number,
			value: 56,
			notify: true
		},
		num_lines_two: {
			type: Number,
			value: 96,
			notify: true
		}

	},

	ready: function(){
		console.log('READY DOUBLE COLUMN');
		this.longestLineNumberArrayThree=[];
		this.longestLineNumberArrayTwo=[];
		for(i=1; i <= 180; i++)
		{
			j=	i % 5 ? false: true;
			this.push("longestLineNumberArrayThree", {'number': i, 'show': j});
			this.push("longestLineNumberArrayTwo", {'number': i, 'show': j});
		}
		this.goldenRatio = (Math.floor(.618*this.lastWordIndex)!=undefined) ? Math.floor(.618*this.lastWordIndex): 545;
		this.firstColumnLastWordIndex = (this.goldenRatio!=undefined) ? this.goldenRatio: 545;
		this.secondColumnFirstWordIndex = (this.firstColumnLastWordIndex!=undefined) ? this.goldenRatio+1:546
	},

	attached: function(){ this.loadContent();
		console.log("firstColumnLastWordIndex: " + this.firstColumnLastWordIndex);
		console.log("secondColumnFirstWordIndex: " + this.secondColumnFirstWordIndex);	
	 },

	loadContent: function(){
		//this.notifyResize();
	},

	notifyResize: function(){
		console.log('NOTIFY RESIZE');
		//this._adjustDoubleColumns(this.firstColumnLastWordIndex);
	},
	gotRealWordCount: function(newValue, oldValue){
		console.log('GOT REAL WORD COUNT');
		console.log(newValue);
		console.log(oldValue);
		this._adjustDoubleColumns(newValue);
		this.numberTwoColumns();
	},

	growFirstColumn: function(numberAhead){
		var self=this;
		alert("growing the right side");
		var numberAhead=0;
		while(numberAhead>-8){
			self.firstWordAnchor =  this.$$('#one_'+ self.secondColumnFirstWordIndex.toString());
			var top_of_line_to_reclaim = self.firstWordAnchor.getBoundingClientRect().top;
			var nextAnchor = self.firstWordAnchor;
			var top_of_next_anchor = top_of_line_to_reclaim;
			while(top_of_line_to_reclaim == top_of_next_anchor){				
				nextAnchor = nextAnchor.nextSibling;	
				if(nextAnchor.nodeName == self.firstWordAnchor.nodeName){
					console.log(nextAnchor.nodeName +  ' node two: ' + self.firstWordAnchor.nodeName);
					top_of_next_anchor = nextAnchor.getBoundingClientRect().top;
					self.numberPlus--;
				}
			}
		}		
	},
	_adjustDoubleColumns: function(newValue){
		this.firstColumnLastWordIndex = (this.firstColumnLastWordIndex==undefined || this.firstColumnLastWordIndex<.53*newValue) ? Math.floor(.618*(newValue)): this.firstColumnLastWordIndex;
		var theId = '#one_'+ this.firstColumnLastWordIndex.toString()
		var finalWordAnchor = this.$$(theId);
		var bottom_of_line_to_cut = (finalWordAnchor != undefined)? finalWordAnchor.getBoundingClientRect().bottom: this.$.doubleColumnBounderOne.getBoundingClientRect().bottom;
		var previousAnchor = finalWordAnchor;
		var bottom_of_previous_anchor = bottom_of_line_to_cut;
		var howManyAheadOfFinalColumnOneWord = 0;
		
		while(howManyAheadOfFinalColumnOneWord <12 && bottom_of_previous_anchor == bottom_of_line_to_cut){
			previousAnchor = previousAnchor.previousSibling;
			if(previousAnchor.nodeName == finalWordAnchor.nodeName){
				console.log(previousAnchor.nodeName +  ' : compare node to node : ' + finalWordAnchor.nodeName);
				bottom_of_previous_anchor = previousAnchor.getBoundingClientRect().bottom;
				howManyAheadOfFinalColumnOneWord++;
				self.numberPlus = howManyAheadOfFinalColumnOneWord;
			}
		}
				
		this.firstColumnLastWordIndex = this.firstColumnLastWordIndex - howManyAheadOfFinalColumnOneWord;
					console.log(this.firstColumnLastWordIndex);
	},

	numberTwoColumns: function(){
		var top_of_first_column = this.$.lines.getBoundingClientRect().bottom;
		var last_word = this.$.doubleColumnBounderOne;
		var last_word_rect =  last_word.getBoundingClientRect().bottom;
		var line_height = this.$.lines.clientHeight;
		var delta = Math.floor(last_word_rect - top_of_first_column);
		this.num_lines = Math.ceil(delta/line_height);
		console.log(this.num_lines + "this is what I need");
		var deltaTwo = Math.ceil(top_of_first_column - this.$.doubleColumnBounderTwo.getBoundingClientRect().bottom);
		this.num_lines_two = Math.ceil(deltaTwo/line_height);
		this.last_row = this.num_lines + this.num_lines_two;

		this.columnOneLineNumbersFilter(this.last_row, this.num_lines);
		this.columnTwoLineNumbersFilter(this.last_row, this.num_lines);
		console.log( 'number two columns ' + this.last_row + " " + this.num_lines);
	},

	columnOneWordFilter: function(finalWordColOne){
		return (item ) => {
			return (item.order <= this.firstColumnLastWordIndex);
			//return true;
		};
	},

	columnTwoWordFilter: function(finalWordColOne){
		return (item) => {
			return (item.order > this.firstColumnLastWordIndex);
		};
	}, 

	columnOneLineNumbersFilter: function(num_lines){
		return (item) => {
			return(item.number<=this.num_lines);
		};
	},

	columnTwoLineNumbersFilter: function(num_lines,last_row){
		return (item) => {
			return(item.number>this.num_lines && item.number<=this.last_row);
		};
	}
});

</script>
</dom-module>